<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard (Firebase)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- নতুন যুক্ত: Chart.js লাইব্রেরি -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-bg: #2c3e50;
            --secondary-bg: #ecf0f1;
            --text-light: #ffffff;
            --text-dark: #34495e;
            --blue: #3498db;
            --green: #2ecc71;
            --yellow: #f1c40f;
            --red: #e74c3c;
            --purple: #8e44ad;
            --orange: #e67e22;
            --teal: #1abc9c;
            --card-bg: #ffffff;
            --border-color: #bdc3c7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: var(--secondary-bg);
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            position: relative;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        .side-nav {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background-color: var(--primary-bg); color: var(--text-light);
            transition: left 0.3s ease-in-out; z-index: 1000;
        }
        .side-nav.open { left: 0; }
        .nav-header { padding: 20px; font-size: 1.5rem; font-weight: 600; background-color: rgba(0, 0, 0, 0.2); text-align: center; }
        .nav-links { list-style: none; padding: 20px 0; }
        .nav-links li a { display: flex; align-items: center; padding: 15px 25px; color: var(--text-light); text-decoration: none; font-size: 1.1rem; transition: background-color 0.2s; }
        .nav-links li a:hover, .nav-links li a.active { background-color: rgba(255, 255, 255, 0.1); }
        .nav-links li a i { margin-right: 15px; width: 20px; text-align: center; }

        .main-content { height: 100%; transition: margin-left 0.3s ease-in-out; display: flex; flex-direction: column; }
        .app-header { display: flex; align-items: center; padding: 15px; background-color: var(--card-bg); color: var(--text-dark); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); flex-shrink: 0; border-bottom: 1px solid var(--border-color);}
        .menu-toggle { background: none; border: none; color: var(--text-dark); font-size: 1.5rem; cursor: pointer; margin-right: 20px; }
        .welcome-message { font-size: 1.2rem; font-weight: 500; }

        .content-area { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .dashboard-card { background-color: var(--card-bg); padding: 20px; border-radius: 8px; display: flex; align-items: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
        
        .dashboard-card .icon {
            font-size: 2.2rem; width: 60px; height: 60px; border-radius: 50%;
            color: white; margin-right: 20px; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0;
        }

        .card-content h3 { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--text-dark);}
        .card-content p { margin: 0; font-size: 1rem; color: #7f8c8d;}
        
        .icon.users { background: var(--blue); } .icon.ads { background: var(--purple); } .icon.earnings { background: var(--green); } .icon.commission { background: var(--orange); } .icon.referrals { background: var(--teal); } .icon.request { background: var(--yellow); color: #333;} .icon.pending { background: #e67e22; } .icon.approved { background: #27ae60; } .icon.methods { background: #c0392b; } .icon.settings { background: #2c3e50; }

        .section-card { background-color: white; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .section-header { padding: 15px 20px; background-color: var(--primary-bg); color: var(--text-light); border-radius: 8px 8px 0 0; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center;}
        .section-header i { margin-right: 10px; }
        .section-body { padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; font-family: 'Hind Siliguri', sans-serif; }
        .form-group textarea { resize: vertical; min-height: 100px; }

        .update-btn { width: 100%; padding: 15px; background: var(--green); color: var(--text-light); border: none; border-radius: 5px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .update-btn:hover { background-color: #27ae60; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .overlay.active { opacity: 1; visibility: visible; }
        
        .ad-network-setting, .task-setting, .method-setting, .tier-setting { /* tier-setting যুক্ত করা হলো */
            display: grid; gap: 15px; align-items: center;
            margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
        }
        .ad-network-setting { grid-template-columns: 2fr 2fr auto auto; }
        .task-setting { grid-template-columns: 2fr 2fr 1fr auto auto; }
        .method-setting { grid-template-columns: 1fr 1fr 1fr auto auto; }
        /* নতুন tier-setting এর জন্য স্টাইল */
        .tier-setting { grid-template-columns: 2fr 2fr 1fr auto auto; }

        .btn-remove { padding: 8px 12px; background: var(--red); color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-add { padding: 10px; background: var(--blue); color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;}
        hr { border: 0; border-top: 1px solid #ecf0f1; margin: 20px 0; }

        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(24px); }

        .section-toggle { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 5px; }
        .section-toggle label { font-weight: 600; margin: 0; }

        .days-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .daily-checkin-item { display: flex; align-items: center; gap: 10px; border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; }
        .daily-checkin-item .form-group { flex-grow: 1; margin: 0; }
        .daily-checkin-item label.day-label { font-weight: 600; margin-bottom: 8px; display: block; text-align: center;}
        
        /* --- অ্যানালিটিক্স চার্টের জন্য নতুন স্টাইল শুরু --- */
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 25px;
        }
        @media (min-width: 992px) {
            .analytics-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        /* --- অ্যানালিটিক্স চার্টের জন্য নতুন স্টাইল শেষ --- */

        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px 15px; border: 1px solid var(--border-color); text-align: left; }
        .data-table th { background-color: var(--primary-bg); color: var(--text-light); }
        .data-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .action-btn { padding: 6px 10px; border: none; border-radius: 5px; color: white; cursor: pointer; margin-right: 5px; font-size: 0.9rem;}
        .btn-approve { background-color: var(--green); }
        .btn-reject { background-color: var(--red); }
        .btn-view { background-color: var(--blue); }
        .btn-history { background-color: var(--teal); }
        .btn-block { background-color: var(--orange); }
        .btn-unblock { background-color: #7f8c8d; }
        
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; color: white; white-space: nowrap;}
        .status-pending { background-color: var(--yellow); color: var(--text-dark); }
        .status-approved { background-color: var(--green); }
        .status-rejected { background-color: var(--red); }
        .status-blocked { background-color: var(--text-dark); }

        .tab-nav { display: flex; gap: 10px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: var(--text-dark); border-radius: 5px 5px 0 0;}
        .tab-btn.active { background-color: var(--primary-bg); color: var(--text-light); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1001; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;}
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;}
        .modal-header h3 { margin: 0; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer;}
        .modal-body { overflow-y: auto; }
        .user-details p { margin: 0 0 10px; }
        .user-details strong { color: var(--primary-bg); margin-right: 8px;}
        
        .history-list { list-style: none; padding: 0; }
        .history-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .history-item:last-child { border-bottom: none; }
        .history-item .icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; }
        .history-item .info { flex-grow: 1; }
        .history-item .title { font-weight: 600; }
        .history-item .date { font-size: 0.85rem; color: #777; }
        .history-item .amount { font-weight: 700; text-align: right; }
        .amount.positive { color: var(--green); }
        .amount.negative { color: var(--red); }
        .icon.earning { background-color: var(--green); }
        .icon.withdrawal { background-color: var(--red); }
        .icon.referral, .icon.login, .icon.task { background-color: var(--blue); }
        .icon.manual { background-color: var(--purple); }

        @media (max-width: 768px) {
            .ad-network-setting, .task-setting, .method-setting, .tier-setting { grid-template-columns: 1fr; gap: 10px; }
            .method-setting .btn-remove, .task-setting .btn-remove, .ad-network-setting .btn-remove, .tier-setting .btn-remove { margin-top: 5px; width: 100%; }

            .data-table thead { display: none; }
            .data-table, .data-table tbody, .data-table tr, .data-table td {
                display: block; width: 100%;
            }
            .data-table tr {
                margin-bottom: 15px; border: 1px solid var(--border-color);
                border-radius: 5px; overflow: hidden;
            }
            .data-table td {
                text-align: right; padding-left: 50%;
                position: relative; border: none; border-bottom: 1px solid #eee;
            }
            .data-table td:last-child { border-bottom: none; }
            .data-table td::before {
                content: attr(data-label); position: absolute;
                left: 10px; width: 45%; padding-right: 10px;
                white-space: nowrap; text-align: left; font-weight: bold;
                color: var(--primary-bg);
            }
            .data-table .action-btn { margin-bottom: 5px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="side-nav" id="sideNav">
            <div class="nav-header">Admin Panel</div>
            <ul class="nav-links">
                <li><a href="#dashboard" class="nav-link active"><i class="fas fa-tachometer-alt"></i>Dashboard</a></li>
                <li><a href="#user-management" class="nav-link"><i class="fas fa-users-cog"></i>Users Management</a></li>
                <li><a href="#withdraw-management" class="nav-link"><i class="fas fa-money-check-alt"></i>Withdraw Management</a></li>
                <li><a href="#settings" class="nav-link"><i class="fas fa-cog"></i>Settings</a></li>
            </ul>
        </nav>

        <div class="overlay" id="overlay"></div>

        <main class="main-content">
            <header class="app-header">
                <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
                <div class="welcome-message">Welcome, Admin!</div>
            </header>

            <div class="content-area">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page active">
                    <div class="dashboard-grid">
                        <div class="dashboard-card"><div class="icon users"><i class="fas fa-users"></i></div><div class="card-content"><h3 id="db-total-users">0</h3><p>Total Users</p></div></div>
                        <div class="dashboard-card"><div class="icon ads"><i class="fas fa-eye"></i></div><div class="card-content"><h3 id="db-ads-watched">0</h3><p>Total Ads Watched</p></div></div>
                        <div class="dashboard-card"><div class="icon earnings"><i class="fas fa-wallet"></i></div><div class="card-content"><h3 id="db-total-earnings">BDT 0</h3><p>Total Earnings</p></div></div>
                        <div class="dashboard-card"><div class="icon commission"><i class="fas fa-percent"></i></div><div class="card-content"><h3 id="db-total-commission">BDT 0</h3><p>Total Commission</p></div></div>
                        <div class="dashboard-card"><div class="icon referrals"><i class="fas fa-user-plus"></i></div><div class="card-content"><h3 id="db-total-referrals">0</h3><p>Total Referrals</p></div></div>
                        <div class="dashboard-card"><div class="icon request"><i class="fas fa-inbox"></i></div><div class="card-content"><h3 id="db-req-withdraw">0</h3><p>Pending Requests</p></div></div>
                        <div class="dashboard-card"><div class="icon pending"><i class="fas fa-hourglass-half"></i></div><div class="card-content"><h3 id="db-pending-withdraw">0</h3><p>Pending Withdrawal (Legacy)</p></div></div>
                        <div class="dashboard-card"><div class="icon approved"><i class="fas fa-check-circle"></i></div><div class="card-content"><h3 id="db-approved-withdraw">0</h3><p>Approved Withdrawal</p></div></div>
                        <div class="dashboard-card"><div class="icon methods"><i class="fas fa-credit-card"></i></div><div class="card-content"><h3 id="db-withdraw-methods">0</h3><p>Withdrawal Methods</p></div></div>
                        <div class="dashboard-card"><div class="icon settings"><i class="fas fa-cog"></i></div><div class="card-content" style="cursor: pointer;" onclick="navigateToPage('settings')"><h3>Settings</h3><p>Manage App Settings</p></div></div>
                    </div>
                    <!-- নতুন যুক্ত: অ্যানালিটিক্স সেকশন শুরু -->
                    <div class="analytics-grid">
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-chart-line"></i>দৈনিক ব্যবহারকারী বৃদ্ধি</div>
                            <div class="section-body">
                                <div class="chart-container">
                                    <canvas id="user-growth-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-chart-bar"></i>দৈনিক মোট আয় (পয়েন্ট)</div>
                            <div class="section-body">
                                <div class="chart-container">
                                    <canvas id="daily-earnings-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- নতুন যুক্ত: অ্যানালিটিক্স সেকশন শেষ -->
                </div>

                <!-- User Management Page -->
                <div id="user-management" class="page">
                    <div class="section-card">
                        <div class="section-header"><i class="fas fa-users"></i>Users Management</div>
                        <div class="section-body">
                            <div class="form-group">
                                <label for="userSearch">Search User (by Name, Username, or ID)</label>
                                <input type="text" id="userSearch" placeholder="Search...">
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>User ID</th>
                                            <th>Name</th>
                                            <th>Balance (Points)</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <!-- User data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Withdraw Management Page -->
                <div id="withdraw-management" class="page">
                    <div class="section-card">
                        <div class="section-header"><i class="fas fa-money-check-alt"></i>Withdrawal Management</div>
                        <div class="section-body">
                            <nav class="tab-nav" id="withdraw-tab-nav">
                                <button class="tab-btn active" data-status="Pending">Pending</button>
                                <button class="tab-btn" data-status="Approved">Approved</button>
                                <button class="tab-btn" data-status="Rejected">Rejected</button>
                            </nav>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>User ID</th>
                                            <th>Date</th>
                                            <th>Method</th>
                                            <th>Account</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="withdraw-table-body">
                                        <!-- Withdraw data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Page -->
                <div id="settings" class="page">
                    <form id="settingsForm">
                        <!-- App Control Settings -->
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-bullhorn"></i>App Control</div>
                            <div class="section-body">
                                <div class="form-group">
                                    <label for="appVersion">App Version</label>
                                    <input type="text" id="appVersion" placeholder="e.g., 1.0.0">
                                </div>
                                <div class="form-group">
                                    <label for="botUsername">Telegram Bot Username (without @)</label>
                                    <input type="text" id="botUsername" placeholder="e.g., YourBotUsername">
                                </div>
                                <div class="form-group">
                                    <label for="announcement">Announcement / Notice</label>
                                    <textarea id="announcement" placeholder="অ্যাপের ব্যবহারকারীদের জন্য ঘোষণা..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- নতুন যুক্ত: গ্লোবাল নোটিফিকেশন সেকশন শুরু -->
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-bell"></i>সকল ব্যবহারকারীকে নোটিফিকেশন পাঠান</div>
                            <div class="section-body">
                                <div class="form-group">
                                    <label for="global-notification-message">নোটিফিকেশন বার্তা</label>
                                    <textarea id="global-notification-message" placeholder="এই বার্তাটি সকল সক্রিয় ব্যবহারকারীর কাছে অ্যাপের ভেতর পপ-আপ হিসেবে দেখানো হবে..."></textarea>
                                </div>
                                <button type="button" class="update-btn" style="background-color: var(--blue);" id="send-global-notification-btn">Send Global Notification</button>
                            </div>
                        </div>
                        <!-- নতুন যুক্ত: গ্লোবাল নোটিফিকেশন সেকশন শেষ -->

                        <!-- General Settings -->
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-cogs"></i>Manage Settings</div>
                            <div class="section-body">
                                <div class="form-group"><label for="adsReward">Ads Reward</label><input type="number" step="0.01" id="adsReward"></div>
                                <div class="form-group"><label for="adsLimit">Daily Ads Limit</label><input type="number" id="adsLimit"></div>
                                <div class="form-group"><label for="refferBonus">Referral Commission in %</label><input type="number" id="refferBonus"></div>
                                <div class="form-group"><label for="refferJoinBonus">Referral Join Bonus</label><input type="number" step="0.01" id="refferJoinBonus"></div>
                                <div class="form-group"><label for="currency">Currency Symbol</label><input type="text" id="currency"></div>
                                <div class="form-group">
                                    <label for="pointsPerCurrency">Points per <span id="currency-label">Currency</span></label>
                                    <input type="number" id="pointsPerCurrency" placeholder="e.g., 100">
                                </div>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-tools"></i>Advanced Control</div>
                            <div class="section-body">
                                <div class="form-group">
                                    <label for="adWatchTimerSeconds">Ad Watch Timer (Seconds)</label>
                                    <input type="number" id="adWatchTimerSeconds" placeholder="e.g., 30">
                                </div>
                                <div class="form-group">
                                    <label for="hourlyAdsLimit">Hourly Ads Limit</label>
                                    <input type="number" id="hourlyAdsLimit" placeholder="e.g., 25">
                                </div>
                                <div class="form-group">
                                    <label for="minReferralsForWithdrawal">Minimum Referrals for Withdrawal</label>
                                    <input type="number" id="minReferralsForWithdrawal" placeholder="e.g., 3">
                                </div>
                                <hr>
                                <div class="section-toggle">
                                    <label>Enable Maintenance Mode</label>
                                    <label class="switch">
                                        <input type="checkbox" id="maintenanceMode">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Ad Networks Settings -->
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-ad"></i>Ad Network Zone IDs</div>
                            <div class="section-body" id="ad-networks-section"></div>
                        </div>

                        <!-- Daily Check-in Settings -->
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-calendar-check"></i>Daily Check-in Bonus</div>
                            <div class="section-body" id="daily-checkin-section"></div>
                        </div>
                        
                        <!-- Tasks Settings -->
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-tasks"></i>Complete Tasks</div>
                            <div class="section-body" id="tasks-section"></div>
                        </div>

                        <!-- নতুন যুক্ত: ব্যবহারকারীর স্তর সেকশন শুরু -->
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-layer-group"></i>ব্যবহারকারীর স্তর (User Tiers)</div>
                            <div class="section-body" id="user-tiers-section"></div>
                        </div>
                        <!-- নতুন যুক্ত: ব্যবহারকারীর স্তর সেকশন শেষ -->

                        <!-- Withdrawal Settings -->
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-wallet"></i>Withdrawal Settings</div>
                            <div class="section-body">
                                <div class="form-group">
                                    <label for="minWithdraw">Minimum Withdrawal Limit</label>
                                    <input type="number" id="minWithdraw">
                                </div>
                                <hr>
                                <div id="withdrawal-methods-section"></div>
                            </div>
                        </div>
                        
                        <button type="submit" class="update-btn">UPDATE ALL SETTINGS</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- User Edit Modal -->
    <div class="modal-overlay" id="user-edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-user-name">Edit User</h3>
                <button class="modal-close-btn" onclick="closeUserEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="user-details" id="user-details-content"></div>
                <hr>
                
                <h4>Manual Transaction</h4>
                <div class="form-group">
                    <label for="points-to-add">Add/Subtract Points (e.g., 100 or -50)</label>
                    <input type="number" id="points-to-add" placeholder="0">
                </div>
                <div class="form-group">
                    <label for="transaction-reason">Reason (will be shown in user's history)</label>
                    <input type="text" id="transaction-reason" placeholder="e.g., Weekly bonus, refund...">
                </div>
                <button class="update-btn" id="save-user-changes-btn">Save Changes & Add to History</button>
                <hr>

                <h4>Send Notification</h4>
                <div class="form-group">
                    <label for="user-notification-message">Message for this user</label>
                    <textarea id="user-notification-message" placeholder="This message will be shown to the user in the app..."></textarea>
                </div>
                <button class="update-btn" style="background-color: var(--blue);" onclick="window.sendUserNotification()">Send Notification</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="user-history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-history-user-name">Transaction History</h3>
                <button class="modal-close-btn" onclick="closeUserHistoryModal()">&times;</button>
            </div>
            <div class="modal-body" id="user-history-content">
                <!-- History items will be loaded here -->
            </div>
        </div>
    </div>

<!-- Firebase SDKs -->
<script type="module">
    // --- Firebase Configuration ---
    const firebaseConfig = {
    apiKey: "AIzaSyD5WNVy_CCoQ9cuHWNeTYf0UirKLwIs8hQ",
    authDomain: "the-ramjan-earnings.firebaseapp.com",
    projectId: "the-ramjan-earnings",
    storageBucket: "the-ramjan-earnings.firebasestorage.app",
    messagingSenderId: "273789835484",
    appId: "1:273789835484:web:bc05207508c7b2d29b3c19"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    const dbRef = ref(database);
    const configRef = ref(database, 'app/config'); 
    const usersRef = ref(database, 'app/users');
    const withdrawRequestsRef = ref(database, 'app/withdraw_requests');
    // নতুন যুক্ত: গ্লোবাল নোটিফিকেশন ref
    const globalNotificationRef = ref(database, 'app/global_notification');

    document.addEventListener('DOMContentLoaded', function () {
        const menuToggle = document.getElementById('menuToggle');
        const sideNav = document.getElementById('sideNav');
        const overlay = document.getElementById('overlay');
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const settingsForm = document.getElementById('settingsForm');

        let appConfig = {};
        let allUsers = {};
        let allWithdrawals = {};
        let currentWithdrawFilter = 'Pending';
        let currentEditingUserId = null;
        
        // নতুন যুক্ত: চার্টের জন্য ভ্যারিয়েবল
        let userGrowthChart = null;
        let dailyEarningsChart = null;

        const DEFAULT_CONFIG = {
            adsReward: 1.0, adsLimit: 100, refferBonus: 10,
            refferJoinBonus: 5.0, currency: 'BDT', minWithdraw: 500,
            appVersion: '1.0.0', announcement: '',
            botUsername: 'YourBotUsername',
            pointsPerCurrency: 100,
            adWatchTimerSeconds: 30,
            hourlyAdsLimit: 25,
            minReferralsForWithdrawal: 3,
            maintenanceMode: false,
            adNetworksEnabled: true,
            adNetworks: [ { name: 'Monetag Ads', zoneId: '9704633', enabled: true } ],
            dailyCheckinEnabled: true,
            dailyCheckinRewards: Array.from({ length: 10 }, (_, i) => ({ day: i + 1, reward: (i + 1) * 2 })),
            tasksEnabled: true,
            tasks: [ { id: Date.now() + 1, title: 'Join Telegram', link: 'https://t.me/your_channel', reward: 5, enabled: true } ],
            withdrawalMethodsEnabled: true,
            withdrawalMethods: [ { name: 'bKash', bn_name: 'বিকাশ', logo: 'bkash.png', enabled: true } ],
            // নতুন যুক্ত: ব্যবহারকারীর স্তর ডিফল্ট কনফিগ
            userTiersEnabled: false,
            userTiers: [
                { name: 'Bronze', requiredPoints: 0, bonusPercent: 0 },
                { name: 'Silver', requiredPoints: 50000, bonusPercent: 2 },
                { name: 'Gold', requiredPoints: 200000, bonusPercent: 5 }
            ]
        };

        function init() {
            onValue(configRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    appConfig = { ...DEFAULT_CONFIG, ...data };
                } else {
                    console.log("No config found. Using and saving default config.");
                    appConfig = { ...DEFAULT_CONFIG };
                    set(configRef, appConfig);
                }
                renderAllSettings();
                updateDashboardData();
            }, (err) => console.error("Config read error:", err));
            
            onValue(usersRef, (snapshot) => {
                allUsers = snapshot.val() || {};
                renderUsers();
                updateDashboardData();
                processAnalyticsData(); // নতুন: ব্যবহারকারীর ডেটা লোড হলে চার্ট আপডেট হবে
            }, (err) => console.error("Users read error:", err));
            
            onValue(withdrawRequestsRef, (snapshot) => {
                allWithdrawals = snapshot.val() || {};
                renderWithdrawals();
                updateDashboardData();
            }, (err) => console.error("Withdrawals read error:", err));

            menuToggle.addEventListener('click', toggleMenu);
            overlay.addEventListener('click', toggleMenu);
            navLinks.forEach(link => link.addEventListener('click', handleNavClick));
            settingsForm.addEventListener('submit', saveAllSettings);

            document.getElementById('withdraw-tab-nav').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#withdraw-tab-nav .tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    currentWithdrawFilter = e.target.dataset.status;
                    renderWithdrawals();
                }
            });

            document.getElementById('userSearch').addEventListener('input', renderUsers);
            document.getElementById('save-user-changes-btn').addEventListener('click', saveUserChanges);
            document.getElementById('currency').addEventListener('input', (e) => {
                document.getElementById('currency-label').textContent = e.target.value || 'Currency';
            });
            
            // নতুন যুক্ত: গ্লোবাল নোটিফিকেশন বাটনের জন্য ইভেন্ট লিসেনার
            document.getElementById('send-global-notification-btn').addEventListener('click', sendGlobalNotification);
            
            initCharts(); // নতুন: চার্ট ইনিশিয়ালাইজ করা
        }
        
        // --- নতুন ফাংশন: অ্যানালিটিক্স চার্ট শুরু ---
        function initCharts() {
            const userCtx = document.getElementById('user-growth-chart').getContext('2d');
            userGrowthChart = new Chart(userCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'নতুন ব্যবহারকারী', data: [], backgroundColor: 'rgba(52, 152, 219, 0.2)', borderColor: 'rgba(52, 152, 219, 1)', borderWidth: 2, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const earningsCtx = document.getElementById('daily-earnings-chart').getContext('2d');
            dailyEarningsChart = new Chart(earningsCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'দৈনিক আয় (পয়েন্ট)', data: [], backgroundColor: 'rgba(46, 204, 113, 0.7)', borderColor: 'rgba(46, 204, 113, 1)', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function processAnalyticsData() {
            const userGrowthData = {};
            const dailyEarningsData = {};
            
            Object.values(allUsers).forEach(user => {
                if (user.joinedAt) {
                    const joinDate = new Date(user.joinedAt).toLocaleDateString('en-CA'); // YYYY-MM-DD format
                    userGrowthData[joinDate] = (userGrowthData[joinDate] || 0) + 1;
                }
                if (user.transactionHistory) {
                     Object.values(user.transactionHistory).forEach(tx => {
                        if (tx.amount > 0 && ['earning', 'login', 'task', 'referral'].includes(tx.type)) {
                            const txDate = new Date(tx.date).toLocaleDateString('en-CA');
                            dailyEarningsData[txDate] = (dailyEarningsData[txDate] || 0) + tx.amount;
                        }
                     });
                }
            });

            const sortedUserDates = Object.keys(userGrowthData).sort();
            const sortedEarningDates = Object.keys(dailyEarningsData).sort();

            userGrowthChart.data.labels = sortedUserDates;
            userGrowthChart.data.datasets[0].data = sortedUserDates.map(date => userGrowthData[date]);
            userGrowthChart.update();

            dailyEarningsChart.data.labels = sortedEarningDates;
            dailyEarningsChart.data.datasets[0].data = sortedEarningDates.map(date => dailyEarningsData[date]);
            dailyEarningsChart.update();
        }
        // --- নতুন ফাংশন: অ্যানালিটিক্স চার্ট শেষ ---

        // --- নতুন ফাংশন: গ্লোবাল নোটিফিকেশন শুরু ---
        async function sendGlobalNotification() {
            const message = document.getElementById('global-notification-message').value.trim();
            if (!message) {
                return alert("নোটিফিকেশন বার্তা খালি রাখা যাবে না।");
            }

            if (!confirm("আপনি কি নিশ্চিত যে এই বার্তাটি সকল ব্যবহারকারীর কাছে পাঠাতে চান?")) return;

            try {
                await set(globalNotificationRef, {
                    message: message,
                    timestamp: new Date().toISOString()
                });
                alert("গ্লোবাল নোটিফিকেশন সফলভাবে পাঠানো হয়েছে!");
                document.getElementById('global-notification-message').value = '';
            } catch (error) {
                console.error("Error sending global notification:", error);
                alert("নোটিফিকেশন পাঠাতে ব্যর্থ হয়েছে।");
            }
        }
        // --- নতুন ফাংশন: গ্লোবাল নোটিফিকেশন শেষ ---

        async function saveConfigToFirebase() {
            try {
                await set(configRef, appConfig);
                alert('Settings updated successfully in Firebase!');
            } catch (error) {
                console.error("Error saving settings to Firebase: ", error);
                alert('Failed to update settings. Check console.');
            }
        }
        
        function renderAllSettings() {
            if (!appConfig || Object.keys(appConfig).length === 0) return;
            document.getElementById('appVersion').value = appConfig.appVersion || '1.0.0';
            document.getElementById('announcement').value = appConfig.announcement || '';
            document.getElementById('adsReward').value = appConfig.adsReward;
            document.getElementById('adsLimit').value = appConfig.adsLimit;
            document.getElementById('refferBonus').value = appConfig.refferBonus;
            document.getElementById('refferJoinBonus').value = appConfig.refferJoinBonus;
            document.getElementById('currency').value = appConfig.currency;
            document.getElementById('minWithdraw').value = appConfig.minWithdraw;
            
            document.getElementById('adWatchTimerSeconds').value = appConfig.adWatchTimerSeconds;
            document.getElementById('hourlyAdsLimit').value = appConfig.hourlyAdsLimit;
            document.getElementById('minReferralsForWithdrawal').value = appConfig.minReferralsForWithdrawal;
            document.getElementById('maintenanceMode').checked = appConfig.maintenanceMode;

            document.getElementById('botUsername').value = appConfig.botUsername || '';
            document.getElementById('pointsPerCurrency').value = appConfig.pointsPerCurrency || 100;
            document.getElementById('currency-label').textContent = appConfig.currency || 'Currency';

            renderAdNetworksSection();
            renderDailyCheckinSection();
            renderTasksSection();
            renderUserTiersSection(); // নতুন: ব্যবহারকারীর স্তর সেকশন রেন্ডার করা
            renderWithdrawalMethodsSection();
        }

        function renderWithdrawals() {
            const tbody = document.getElementById('withdraw-table-body');
            tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
            const filteredWithdrawals = Object.entries(allWithdrawals).filter(([id, data]) => data.status === currentWithdrawFilter);

            if (filteredWithdrawals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7">No ${currentWithdrawFilter} requests found.</td></tr>`;
                return;
            }

            tbody.innerHTML = filteredWithdrawals.map(([id, req]) => `
                <tr>
                    <td data-label="User ID">${req.userId || 'N/A'}</td>
                    <td data-label="Date">${new Date(req.date).toLocaleString()}</td>
                    <td data-label="Method">${req.method}</td>
                    <td data-label="Account">${req.number}</td>
                    <td data-label="Amount">${req.amount} ${appConfig.currency || ''}</td>
                    <td data-label="Status"><span class="status-badge status-${req.status.toLowerCase()}">${req.status}</span></td>
                    <td data-label="Actions">
                        ${req.status === 'Pending' ? `
                            <button class="action-btn btn-approve" onclick="window.manageWithdrawal('${id}', 'Approved')">Approve</button>
                            <button class="action-btn btn-reject" onclick="window.manageWithdrawal('${id}', 'Rejected')">Reject</button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }
        
        window.manageWithdrawal = async (requestId, newStatus) => {
            if (!confirm(`Are you sure you want to ${newStatus.toLowerCase()} this request?`)) return;
            try {
                const requestRef = ref(database, `app/withdraw_requests/${requestId}`);
                await update(requestRef, { status: newStatus });
                
                if(newStatus === 'Rejected'){
                    const requestSnapshot = await get(requestRef);
                    const requestData = requestSnapshot.val();
                    const userRef = ref(database, `app/users/${requestData.userId}`);
                    const userSnapshot = await get(userRef);
                    if(userSnapshot.exists()){
                        const userData = userSnapshot.val();
                        const pointsToRefund = requestData.amount * (appConfig.pointsPerCurrency || 100);
                        await update(userRef, {
                            balance: (userData.balance || 0) + pointsToRefund
                        });
                        alert(`Request rejected and ${pointsToRefund} points have been refunded to the user.`);
                    }
                } else {
                     alert(`Request has been successfully ${newStatus.toLowerCase()}.`);
                }

            } catch (error) {
                console.error("Error updating withdrawal status:", error);
                alert("Failed to update status.");
            }
        };

        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

            const filteredUsers = Object.entries(allUsers).filter(([id, data]) => {
                if (!searchTerm) return true;
                const name = (data.profile?.firstName || '') + ' ' + (data.profile?.lastName || '');
                return id.toLowerCase().includes(searchTerm) ||
                       name.toLowerCase().includes(searchTerm) ||
                       (data.profile?.username || '').toLowerCase().includes(searchTerm);
            });
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No users found.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredUsers.map(([id, user]) => `
                <tr>
                    <td data-label="User ID">${id}</td>
                    <td data-label="Name">${(user.profile?.firstName || 'N/A')} ${(user.profile?.lastName || '')}</td>
                    <td data-label="Balance">${user.balance || 0}</td>
                    <td data-label="Status">
                        <span class="status-badge ${user.isBlocked ? 'status-blocked' : 'status-approved'}">
                            ${user.isBlocked ? 'Blocked' : 'Active'}
                        </span>
                    </td>
                    <td data-label="Actions">
                        <button class="action-btn btn-view" onclick="window.openUserEditModal('${id}')">Edit</button>
                        <button class="action-btn btn-history" onclick="window.openUserHistoryModal('${id}')">History</button>
                        <button class="action-btn ${user.isBlocked ? 'btn-unblock' : 'btn-block'}" onclick="window.toggleUserBlock('${id}', ${user.isBlocked || false})">
                            ${user.isBlocked ? 'Unblock' : 'Block'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.openUserEditModal = (userId) => {
            const user = allUsers[userId];
            if (!user) return;
            currentEditingUserId = userId;

            const modal = document.getElementById('user-edit-modal');
            document.getElementById('modal-user-name').textContent = `Edit User: ${user.profile?.firstName || userId}`;
            const detailsContent = document.getElementById('user-details-content');
            
            // নতুন যুক্ত: লগইন ইতিহাস দেখানো
            const lastLogin = user.profile?.lastLogin;
            const lastLoginTime = lastLogin?.timestamp ? new Date(lastLogin.timestamp).toLocaleString() : 'N/A';
            const lastLoginIP = lastLogin?.ip || 'N/A';
            
            detailsContent.innerHTML = `
                <p><strong>User ID:</strong> ${userId}</p>
                <p><strong>Name:</strong> ${user.profile?.firstName || ''} ${user.profile?.lastName || ''}</p>
                <p><strong>Username:</strong> @${user.profile?.username || 'N/A'}</p>
                <p><strong>Current Balance:</strong> ${user.balance || 0} points</p>
                <hr>
                <p><strong>Last Login Time:</strong> ${lastLoginTime}</p>
                <p><strong>Last Login IP:</strong> ${lastLoginIP} <small>(Client-reported, may not be accurate)</small></p>
            `;
            document.getElementById('points-to-add').value = '';
            document.getElementById('transaction-reason').value = '';
            document.getElementById('user-notification-message').value = '';
            modal.classList.add('active');
        };

        window.closeUserEditModal = () => {
            document.getElementById('user-edit-modal').classList.remove('active');
            currentEditingUserId = null;
        };
        
        window.openUserHistoryModal = (userId) => {
            const user = allUsers[userId];
            if (!user) return;

            const modal = document.getElementById('user-history-modal');
            document.getElementById('modal-history-user-name').textContent = `History for ${user.profile?.firstName || userId}`;
            const contentDiv = document.getElementById('user-history-content');

            const history = user.transactionHistory;
            if (!history || Object.keys(history).length === 0) {
                contentDiv.innerHTML = '<p>No transaction history found for this user.</p>';
            } else {
                const historyItems = Object.entries(history)
                    .sort(([, a], [, b]) => new Date(b.date) - new Date(a.date));
                
                contentDiv.innerHTML = `<ul class="history-list">${historyItems.map(([key, item]) => {
                    const date = new Date(item.date).toLocaleString();
                    let iconClass, amountClass, amountPrefix, amountDisplay;
                    
                    switch(item.type) {
                        case 'earning': iconClass = 'fa-solid fa-play'; amountClass = 'positive'; amountPrefix = '+'; amountDisplay = `${item.amount} Points`; break;
                        case 'withdrawal': iconClass = 'fa-solid fa-arrow-down'; amountClass = 'negative'; amountPrefix = '-'; amountDisplay = `${item.amount} ${appConfig.currency}`; break;
                        case 'referral': iconClass = 'fa-solid fa-users'; amountClass = 'positive'; amountPrefix = '+'; amountDisplay = `${item.amount} Points`; break;
                        case 'login': iconClass = 'fa-solid fa-calendar-check'; amountClass = 'positive'; amountPrefix = '+'; amountDisplay = `${item.amount} Points`; break;
                        case 'task': iconClass = 'fa-solid fa-tasks'; amountClass = 'positive'; amountPrefix = '+'; amountDisplay = `${item.amount} Points`; break;
                        case 'manual': iconClass = 'fa-solid fa-user-pen'; amountClass = item.amount >= 0 ? 'positive' : 'negative'; amountPrefix = item.amount >= 0 ? '+' : ''; amountDisplay = `${item.amount} Points`; break;
                        default: iconClass = 'fa-solid fa-question'; amountClass = ''; amountPrefix = ''; amountDisplay = `${item.amount}`; break;
                    }
                    
                    return `
                        <li class="history-item">
                            <div class="icon ${item.type}"><i class="${iconClass}"></i></div>
                            <div class="info">
                                <div class="title">${item.title || item.type.charAt(0).toUpperCase() + item.type.slice(1)}</div>
                                <div class="date">${date}</div>
                            </div>
                            <div class="amount ${amountClass}">${amountPrefix}${amountDisplay}</div>
                        </li>`;
                }).join('')}</ul>`;
            }
            modal.classList.add('active');
        };
        
        window.closeUserHistoryModal = () => {
            document.getElementById('user-history-modal').classList.remove('active');
        };

        async function saveUserChanges() {
            if (!currentEditingUserId) return;
            const pointsStr = document.getElementById('points-to-add').value;
            const pointsToAdd = parseInt(pointsStr, 10);
            
            if (isNaN(pointsToAdd) || pointsToAdd === 0) {
                return alert("Please enter a valid, non-zero number for points.");
            }

            const reason = document.getElementById('transaction-reason').value.trim() || 'Admin Adjustment';

            try {
                const userRef = ref(database, `app/users/${currentEditingUserId}`);
                const userSnapshot = await get(userRef);

                if (userSnapshot.exists()) {
                    const currentBalance = userSnapshot.val().balance || 0;
                    const newBalance = currentBalance + pointsToAdd;
                    
                    const updates = {};
                    updates[`balance`] = newBalance;

                    const historyRef = ref(database, `app/users/${currentEditingUserId}/transactionHistory`);
                    const newHistoryRef = push(historyRef);
                    updates[`transactionHistory/${newHistoryRef.key}`] = {
                        type: 'manual',
                        amount: pointsToAdd,
                        title: reason,
                        date: new Date().toISOString()
                    };
                    
                    await update(userRef, updates);
                    alert(`User balance updated to ${newBalance} points. Transaction added to history.`);
                    closeUserEditModal();
                }
            } catch (error) {
                console.error("Error updating user balance:", error);
                alert("Failed to update balance.");
            }
        }

        window.sendUserNotification = async () => {
            if (!currentEditingUserId) return;
            const message = document.getElementById('user-notification-message').value.trim();
            if (!message) {
                return alert("Notification message cannot be empty.");
            }

            try {
                const notificationsRef = ref(database, `app/users/${currentEditingUserId}/notifications`);
                const newNotificationRef = push(notificationsRef);
                await set(newNotificationRef, {
                    message: message,
                    date: new Date().toISOString(),
                    read: false
                });
                alert("Notification sent successfully!");
                document.getElementById('user-notification-message').value = '';
            } catch(error) {
                console.error("Error sending notification:", error);
                alert("Failed to send notification. Check console for errors.");
            }
        };

        window.toggleUserBlock = async (userId, isCurrentlyBlocked) => {
            const action = isCurrentlyBlocked ? 'unblock' : 'block';
            if (!confirm(`Are you sure you want to ${action} this user?`)) return;

            try {
                const userRef = ref(database, `app/users/${userId}`);
                await update(userRef, { isBlocked: !isCurrentlyBlocked });
                alert(`User has been successfully ${action}ed.`);
            } catch (error) {
                console.error(`Error ${action}ing user:`, error);
                alert(`Failed to ${action} user.`);
            }
        };

        function renderSection(containerId, list, config) {
            const container = document.getElementById(containerId);
            const listHtml = (list || []).map(config.itemRenderer).join('');
            
            container.innerHTML = `
                <div class="section-toggle">
                    <label>${config.toggleLabel}</label>
                    <label class="switch"><input type="checkbox" id="${config.enabledId}" ${appConfig[config.enabledFlag] ? 'checked' : ''}><span class="slider"></span></label>
                </div>
                <div id="${config.listContainerId}" style="padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;">
                    ${listHtml}
                    <button type="button" class="btn-add" onclick="${config.addFunction}"><i class="fas fa-plus"></i> ${config.addButtonLabel}</button>
                </div>`;
                
            const switchEl = document.getElementById(config.enabledId);
            const listContainerEl = document.getElementById(config.listContainerId);

            listContainerEl.style.display = switchEl.checked ? 'block' : 'none';
            switchEl.addEventListener('change', () => {
                listContainerEl.style.display = switchEl.checked ? 'block' : 'none';
            });
        }

        function renderAdNetworksSection() {
            renderSection('ad-networks-section', appConfig.adNetworks || [], {
                toggleLabel: 'Enable Ad Networks Feature',
                enabledId: 'adNetworksEnabled',
                enabledFlag: 'adNetworksEnabled',
                listContainerId: 'ad-networks-list',
                itemRenderer: (item, index) => `
                    <div class="ad-network-setting">
                        <input type="text" data-type="adNetworkName" data-index="${index}" value="${item.name}" placeholder="Ad Network Name">
                        <input type="text" data-type="adNetworkZoneId" data-index="${index}" value="${item.zoneId}" placeholder="Zone ID">
                        <label class="switch"><input type="checkbox" data-type="adNetworkItemEnabled" data-index="${index}" ${item.enabled ? 'checked' : ''}><span class="slider"></span></label>
                        <button type="button" class="btn-remove" onclick="removeAdNetwork(${index})">&times;</button>
                    </div>`,
                addFunction: 'window.addAdNetwork()',
                addButtonLabel: 'Add Ad Network'
            });
        }
        window.addAdNetwork = () => { if (!appConfig.adNetworks) appConfig.adNetworks = []; appConfig.adNetworks.push({ name: '', zoneId: '', enabled: true }); renderAdNetworksSection(); };
        window.removeAdNetwork = (index) => { if(confirm('Are you sure?')) { appConfig.adNetworks.splice(index, 1); renderAdNetworksSection(); } };

        function renderDailyCheckinSection() {
            const container = document.getElementById('daily-checkin-section');
            container.innerHTML = `
                <div class="section-toggle">
                    <label>Enable Daily Check-in Feature</label>
                    <label class="switch"><input type="checkbox" id="dailyCheckinEnabled" ${appConfig.dailyCheckinEnabled ? 'checked' : ''}><span class="slider"></span></label>
                </div>
                <div id="daily-checkin-list" style="padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;">
                    <div class="days-grid">
                        ${(appConfig.dailyCheckinRewards || []).map((item, index) => `
                            <div class="daily-checkin-item">
                                <div class="form-group">
                                    <label class="day-label">Day ${item.day}</label>
                                    <input type="number" step="0.01" data-type="checkinReward" data-index="${index}" value="${item.reward}">
                                </div>
                                <button type="button" class="btn-remove" onclick="removeCheckinDay(${index})">&times;</button>
                            </div>`).join('')}
                    </div>
                    <button type="button" class="btn-add" onclick="addCheckinDay()"><i class="fas fa-plus"></i> Add New Day</button>
                </div>`;

            const switchEl = document.getElementById('dailyCheckinEnabled');
            const listEl = document.getElementById('daily-checkin-list');
            listEl.style.display = switchEl.checked ? 'block' : 'none';
            switchEl.addEventListener('change', () => { listEl.style.display = switchEl.checked ? 'block' : 'none'; });
        }
        window.addCheckinDay = () => { if (!appConfig.dailyCheckinRewards) appConfig.dailyCheckinRewards = []; const nextDay = appConfig.dailyCheckinRewards.length + 1; appConfig.dailyCheckinRewards.push({ day: nextDay, reward: 0 }); renderDailyCheckinSection(); };
        window.removeCheckinDay = (index) => { if(confirm('Are you sure?')) { appConfig.dailyCheckinRewards.splice(index, 1); appConfig.dailyCheckinRewards.forEach((item, i) => item.day = i + 1); renderDailyCheckinSection(); }};
        
        function renderTasksSection() {
            renderSection('tasks-section', appConfig.tasks || [], {
                toggleLabel: 'Enable Tasks Feature',
                enabledId: 'tasksEnabled',
                enabledFlag: 'tasksEnabled',
                listContainerId: 'tasks-list',
                itemRenderer: (item, index) => `
                    <div class="task-setting">
                        <input type="text" data-type="taskTitle" data-index="${index}" value="${item.title}" placeholder="Task Title">
                        <input type="text" data-type="taskLink" data-index="${index}" value="${item.link}" placeholder="Task Link">
                        <input type="number" step="0.01" data-type="taskReward" data-index="${index}" value="${item.reward}" placeholder="Reward">
                        <label class="switch"><input type="checkbox" data-type="taskItemEnabled" data-index="${index}" ${item.enabled ? 'checked' : ''}><span class="slider"></span></label>
                        <button type="button" class="btn-remove" onclick="removeTask(${index})">&times;</button>
                    </div>`,
                addFunction: 'window.addTask()',
                addButtonLabel: 'Add Task'
            });
        }
        window.addTask = () => { if (!appConfig.tasks) appConfig.tasks = []; appConfig.tasks.push({ id: Date.now(), title: '', link: '', reward: 0, enabled: true }); renderTasksSection(); };
        window.removeTask = (index) => { if(confirm('Are you sure?')) { appConfig.tasks.splice(index, 1); renderTasksSection(); }};
        
        // --- নতুন ফাংশন: ব্যবহারকারীর স্তর সেকশন রেন্ডার করা ---
        function renderUserTiersSection() {
            renderSection('user-tiers-section', appConfig.userTiers || [], {
                toggleLabel: 'Enable User Tiers Feature',
                enabledId: 'userTiersEnabled',
                enabledFlag: 'userTiersEnabled',
                listContainerId: 'user-tiers-list',
                itemRenderer: (item, index) => `
                    <div class="tier-setting">
                        <input type="text" data-type="tierName" data-index="${index}" value="${item.name}" placeholder="Tier Name (e.g., Silver)">
                        <input type="number" data-type="tierRequiredPoints" data-index="${index}" value="${item.requiredPoints}" placeholder="Required Points">
                        <input type="number" data-type="tierBonusPercent" data-index="${index}" value="${item.bonusPercent}" placeholder="Bonus %">
                        <label class="switch"><input type="checkbox" data-type="tierItemEnabled" data-index="${index}" checked disabled><span class="slider"></span></label>
                        <button type="button" class="btn-remove" onclick="removeUserTier(${index})">&times;</button>
                    </div>`,
                addFunction: 'window.addUserTier()',
                addButtonLabel: 'Add Tier'
            });
        }
        window.addUserTier = () => { if (!appConfig.userTiers) appConfig.userTiers = []; appConfig.userTiers.push({ name: '', requiredPoints: 0, bonusPercent: 0 }); renderUserTiersSection(); };
        window.removeUserTier = (index) => { if(confirm('Are you sure?')) { appConfig.userTiers.splice(index, 1); renderUserTiersSection(); }};
        // --- ব্যবহারকারীর স্তর সেকশন শেষ ---

        function renderWithdrawalMethodsSection() {
            renderSection('withdrawal-methods-section', appConfig.withdrawalMethods || [], {
                toggleLabel: 'Enable Withdrawal Methods',
                enabledId: 'withdrawalMethodsEnabled',
                enabledFlag: 'withdrawalMethodsEnabled',
                listContainerId: 'withdrawal-methods-list',
                itemRenderer: (item, index) => `
                    <div class="method-setting">
                        <input type="text" data-type="methodName" data-index="${index}" value="${item.name}" placeholder="Method Name">
                        <input type="text" data-type="methodBnName" data-index="${index}" value="${item.bn_name}" placeholder="Bangla Name">
                        <input type="text" data-type="methodLogo" data-index="${index}" value="${item.logo}" placeholder="Logo URL">
                        <label class="switch"><input type="checkbox" data-type="methodItemEnabled" data-index="${index}" ${item.enabled ? 'checked' : ''}><span class="slider"></span></label>
                        <button type="button" class="btn-remove" onclick="removeMethod(${index})">&times;</button>
                    </div>`,
                addFunction: 'window.addMethod()',
                addButtonLabel: 'Add Method'
            });
        }
        window.addMethod = () => { if (!appConfig.withdrawalMethods) appConfig.withdrawalMethods = []; appConfig.withdrawalMethods.push({ name: '', bn_name: '', logo: '', enabled: true }); renderWithdrawalMethodsSection(); };
        window.removeMethod = (index) => { if(confirm('Are you sure?')) { appConfig.withdrawalMethods.splice(index, 1); renderWithdrawalMethodsSection(); }};

        async function saveAllSettings(e) {
            e.preventDefault();
            appConfig.appVersion = document.getElementById('appVersion').value;
            appConfig.announcement = document.getElementById('announcement').value;
            appConfig.adsReward = parseFloat(document.getElementById('adsReward').value);
            appConfig.adsLimit = parseInt(document.getElementById('adsLimit').value);
            appConfig.refferBonus = parseInt(document.getElementById('refferBonus').value);
            appConfig.refferJoinBonus = parseFloat(document.getElementById('refferJoinBonus').value);
            appConfig.currency = document.getElementById('currency').value;
            appConfig.minWithdraw = parseFloat(document.getElementById('minWithdraw').value);
            appConfig.botUsername = document.getElementById('botUsername').value;
            appConfig.pointsPerCurrency = parseInt(document.getElementById('pointsPerCurrency').value);
            appConfig.adWatchTimerSeconds = parseInt(document.getElementById('adWatchTimerSeconds').value);
            appConfig.hourlyAdsLimit = parseInt(document.getElementById('hourlyAdsLimit').value);
            appConfig.minReferralsForWithdrawal = parseInt(document.getElementById('minReferralsForWithdrawal').value);
            appConfig.maintenanceMode = document.getElementById('maintenanceMode').checked;

            appConfig.adNetworksEnabled = document.getElementById('adNetworksEnabled').checked;
            appConfig.adNetworks = appConfig.adNetworks || [];
            appConfig.adNetworks.forEach((item, index) => {
                item.name = document.querySelector(`[data-type="adNetworkName"][data-index="${index}"]`).value;
                item.zoneId = document.querySelector(`[data-type="adNetworkZoneId"][data-index="${index}"]`).value;
                item.enabled = document.querySelector(`[data-type="adNetworkItemEnabled"][data-index="${index}"]`).checked;
            });

            appConfig.dailyCheckinEnabled = document.getElementById('dailyCheckinEnabled').checked;
            appConfig.dailyCheckinRewards = appConfig.dailyCheckinRewards || [];
            appConfig.dailyCheckinRewards.forEach((item, index) => {
                item.reward = parseFloat(document.querySelector(`[data-type="checkinReward"][data-index="${index}"]`).value);
            });

            appConfig.tasksEnabled = document.getElementById('tasksEnabled').checked;
            appConfig.tasks = appConfig.tasks || [];
            appConfig.tasks.forEach((item, index) => {
                item.title = document.querySelector(`[data-type="taskTitle"][data-index="${index}"]`).value;
                item.link = document.querySelector(`[data-type="taskLink"][data-index="${index}"]`).value;
                item.reward = parseFloat(document.querySelector(`[data-type="taskReward"][data-index="${index}"]`).value);
                item.enabled = document.querySelector(`[data-type="taskItemEnabled"][data-index="${index}"]`).checked;
            });
            
            // নতুন যুক্ত: ব্যবহারকারীর স্তর সেটিংস সেভ করা
            appConfig.userTiersEnabled = document.getElementById('userTiersEnabled').checked;
            appConfig.userTiers = appConfig.userTiers || [];
            const tempTiers = [];
            document.querySelectorAll('.tier-setting').forEach((el, index) => {
                const tier = {
                    name: el.querySelector(`[data-type="tierName"]`).value,
                    requiredPoints: parseInt(el.querySelector(`[data-type="tierRequiredPoints"]`).value),
                    bonusPercent: parseInt(el.querySelector(`[data-type="tierBonusPercent"]`).value)
                };
                tempTiers.push(tier);
            });
            appConfig.userTiers = tempTiers.sort((a,b) => a.requiredPoints - b.requiredPoints); // পয়েন্ট অনুযায়ী সাজানো

            appConfig.withdrawalMethodsEnabled = document.getElementById('withdrawalMethodsEnabled').checked;
            appConfig.withdrawalMethods = appConfig.withdrawalMethods || [];
            appConfig.withdrawalMethods.forEach((item, index) => {
                item.name = document.querySelector(`[data-type="methodName"][data-index="${index}"]`).value;
                item.bn_name = document.querySelector(`[data-type="methodBnName"][data-index="${index}"]`).value;
                item.logo = document.querySelector(`[data-type="methodLogo"][data-index="${index}"]`).value;
                item.enabled = document.querySelector(`[data-type="methodItemEnabled"][data-index="${index}"]`).checked;
            });

            await saveConfigToFirebase();
        }

        function toggleMenu() { sideNav.classList.toggle('open'); overlay.classList.toggle('active'); }
        function handleNavClick(e) {
            e.preventDefault();
            navigateToPage(this.getAttribute('href').substring(1));
            if (window.innerWidth <= 768) toggleMenu();
        }
        window.navigateToPage = function(targetId) {
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
            navLinks.forEach(l => {
                l.classList.toggle('active', l.getAttribute('href') === `#${targetId}`);
            });
        }
        function updateDashboardData() {
            const currency = appConfig.currency || 'BDT';
            const pointsPerCurrency = appConfig.pointsPerCurrency || 100;
            const pendingWithdrawals = Object.values(allWithdrawals).filter(w => w.status === 'Pending');
            const approvedWithdrawals = Object.values(allWithdrawals).filter(w => w.status === 'Approved');
            const totalApprovedAmount = approvedWithdrawals.reduce((sum, w) => sum + (w.amount || 0), 0);
            
            let totalEarningsPoints = 0; let totalReferrals = 0; let totalAdsWatched = 0; let totalCommissionPoints = 0;

            Object.values(allUsers).forEach(user => {
                totalEarningsPoints += user.totalEarnings || 0;
                totalReferrals += user.referralsList ? Object.keys(user.referralsList).length : 0;
                totalAdsWatched += user.totalAdsWatched || 0;
                totalCommissionPoints += user.totalReferralCommission || 0;
            });
            const totalEarningsBdt = totalEarningsPoints / pointsPerCurrency;
            const totalCommissionBdt = totalCommissionPoints / pointsPerCurrency;

            document.getElementById('db-total-users').textContent = Object.keys(allUsers).length;
            document.getElementById('db-ads-watched').textContent = totalAdsWatched;
            document.getElementById('db-total-earnings').textContent = `${currency} ${totalEarningsBdt.toFixed(2)}`;
            document.getElementById('db-total-commission').textContent = `${currency} ${totalCommissionBdt.toFixed(2)}`;
            document.getElementById('db-total-referrals').textContent = totalReferrals;
            document.getElementById('db-req-withdraw').textContent = pendingWithdrawals.length;
            document.getElementById('db-approved-withdraw').textContent = `${currency} ${totalApprovedAmount.toFixed(2)}`;
            if (appConfig.withdrawalMethods) {
                document.getElementById('db-withdraw-methods').textContent = appConfig.withdrawalMethods.length;
            }
        }

        init();
    });
</script>

</body>
</html>

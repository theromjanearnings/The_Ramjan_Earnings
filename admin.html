<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard (Firebase)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-bg: #2c3e50;
            --secondary-bg: #ecf0f1;
            --text-light: #ffffff;
            --text-dark: #34495e;
            --blue: #3498db;
            --green: #2ecc71;
            --yellow: #f1c40f;
            --red: #e74c3c;
            --purple: #8e44ad;
            --orange: #e67e22;
            --teal: #1abc9c;
            --card-bg: #ffffff;
            --border-color: #bdc3c7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: var(--secondary-bg);
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            position: relative;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        .side-nav {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background-color: var(--primary-bg); color: var(--text-light);
            transition: left 0.3s ease-in-out; z-index: 1000;
        }
        .side-nav.open { left: 0; }
        .nav-header { padding: 20px; font-size: 1.5rem; font-weight: 600; background-color: rgba(0, 0, 0, 0.2); text-align: center; }
        .nav-links { list-style: none; padding: 20px 0; }
        .nav-links li a { display: flex; align-items: center; padding: 15px 25px; color: var(--text-light); text-decoration: none; font-size: 1.1rem; transition: background-color 0.2s; }
        .nav-links li a:hover, .nav-links li a.active { background-color: rgba(255, 255, 255, 0.1); }
        .nav-links li a i { margin-right: 15px; width: 20px; text-align: center; }

        .main-content { height: 100%; transition: margin-left 0.3s ease-in-out; display: flex; flex-direction: column; }
        .app-header { display: flex; align-items: center; justify-content: space-between; padding: 15px; background-color: var(--card-bg); color: var(--text-dark); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); flex-shrink: 0; border-bottom: 1px solid var(--border-color);}
        .header-left { display: flex; align-items: center; }
        .menu-toggle { background: none; border: none; color: var(--text-dark); font-size: 1.5rem; cursor: pointer; margin-right: 20px; }
        .welcome-message { font-size: 1.2rem; font-weight: 500; }

        .lang-switcher { display: flex; align-items: center; border: 1px solid var(--border-color); border-radius: 20px; overflow: hidden; }
        .lang-switcher button { background: none; border: none; padding: 8px 15px; cursor: pointer; font-weight: 600; font-family: 'Hind Siliguri', sans-serif; font-size: 0.9rem; transition: background-color 0.3s, color 0.3s; }
        .lang-switcher button.active { background-color: var(--primary-bg); color: var(--text-light); }

        .content-area { flex-grow: 1; padding: 20px; overflow-y: auto; padding-bottom: 100px; /* Add padding for the sticky button */ }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .dashboard-card { background-color: var(--card-bg); padding: 20px; border-radius: 8px; display: flex; align-items: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
        
        .dashboard-card .icon {
            font-size: 2.2rem; width: 60px; height: 60px; border-radius: 50%;
            color: white; margin-right: 20px; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0;
        }

        .card-content h3 { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--text-dark);}
        .card-content p { margin: 0; font-size: 1rem; color: #7f8c8d;}
        
        .icon.users { background: var(--blue); } .icon.ads { background: var(--purple); } .icon.earnings { background: var(--green); } .icon.commission { background: var(--orange); } .icon.referrals { background: var(--teal); } .icon.request { background: var(--yellow); color: #333;} .icon.pending { background: #e67e22; } .icon.approved { background: #27ae60; } .icon.methods { background: #c0392b; } .icon.settings { background: #2c3e50; }

        .section-card { background-color: white; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .section-header { padding: 15px 20px; background-color: var(--primary-bg); color: var(--text-light); border-radius: 8px 8px 0 0; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .section-header i { margin-right: 10px; }
        .section-header .toggle-icon { transition: transform 0.3s ease; }
        .section-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .section-body { padding: 20px; border-top: 1px solid var(--primary-bg); display: block; transition: all 0.3s ease-in-out; }
        .section-body.collapsed { display: none; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; font-family: 'Hind Siliguri', sans-serif; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group input[type="color"] { padding: 5px; height: 48px; }
        
        .global-save-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
        }
        .update-btn-global {
            padding: 15px 25px;
            background: var(--green);
            color: var(--text-light);
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .update-btn-global:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }
        .section-save-btn {
            display: block;
            margin-left: auto;
            margin-top: 15px;
            padding: 8px 18px;
            background: var(--blue);
            color: var(--text-light);
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .section-save-btn:hover {
            background-color: #2980b9;
        }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .overlay.active { opacity: 1; visibility: visible; }
        
        .tier-setting, .package-setting, .text-setting, .error-message-setting, .asset-setting, .firebase-config-setting { 
            display: grid; gap: 15px; align-items: center;
            margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
        }
        .method-setting {
            display: grid; gap: 15px; align-items: center;
            margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto auto auto;
        }
        .task-setting { display: grid; gap: 15px; margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; }
        .task-setting-grid { grid-template-columns: 2fr 2fr 1fr auto auto auto; }
        .tier-setting { grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr auto auto auto; }
        .package-setting { grid-template-columns: 2fr 1fr 1fr auto; }
        .text-setting, .error-message-setting, .asset-setting, .firebase-config-setting { grid-template-columns: 1fr 2fr; }
        .leaderboard-reward-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }

        .btn-remove { padding: 8px 12px; background: var(--red); color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-add { padding: 10px; background: var(--blue); color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;}
        hr { border: 0; border-top: 1px solid #ecf0f1; margin: 20px 0; }

        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(24px); }

        .section-toggle { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 5px; }
        .section-toggle label { font-weight: 600; margin: 0; }

        .days-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .daily-checkin-item { display: flex; align-items: center; gap: 10px; border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; }
        .daily-checkin-item .form-group { flex-grow: 1; margin: 0; }
        .daily-checkin-item label.day-label { font-weight: 600; margin-bottom: 8px; display: block; text-align: center;}
        
        .analytics-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 25px; }
        @media (min-width: 992px) { .analytics-grid { grid-template-columns: 1fr 1fr; } }
        .chart-container { position: relative; height: 300px; width: 100%; }

        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px 15px; border: 1px solid var(--border-color); text-align: left; }
        .data-table th { background-color: var(--primary-bg); color: var(--text-light); }
        .data-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .action-btn { padding: 6px 10px; border: none; border-radius: 5px; color: white; cursor: pointer; margin-right: 5px; font-size: 0.9rem;}
        .btn-approve { background-color: var(--green); }
        .btn-reject { background-color: var(--red); }
        .btn-view { background-color: var(--blue); }
        .btn-history { background-color: var(--teal); }
        .btn-block { background-color: var(--orange); }
        .btn-unblock { background-color: #7f8c8d; }
        .btn-info { background-color: #17a2b8; }
        .btn-refund { background-color: var(--purple); font-size: 0.8rem; padding: 4px 8px;}
        .screenshot-link { color: var(--blue); text-decoration: underline; cursor: pointer; }
        
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; color: white; white-space: nowrap;}
        .status-pending { background-color: var(--yellow); color: var(--text-dark); }
        .status-approved { background-color: var(--green); }
        .status-rejected { background-color: var(--red); }
        .status-blocked { background-color: var(--text-dark); }
        .status-open { background-color: var(--blue); }
        .status-closed { background-color: #7f8c8d; }

        .tab-nav { display: flex; gap: 10px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: var(--text-dark); border-radius: 5px 5px 0 0;}
        .tab-btn.active { background-color: var(--primary-bg); color: var(--text-light); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1001; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;}
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;}
        .modal-header h3 { margin: 0; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer;}
        .modal-body { overflow-y: auto; }
        .user-details p { margin: 0 0 10px; }
        .user-details strong { color: var(--primary-bg); margin-right: 8px;}
        
        .history-list { list-style: none; padding: 0; }
        .history-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .history-item:last-child { border-bottom: none; }
        .history-item .icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; }
        .history-item .info { flex-grow: 1; }
        .history-item .title { font-weight: 600; }
        .history-item .date { font-size: 0.85rem; color: #777; }
        .history-item .amount { font-weight: 700; text-align: right; }
        .amount.positive { color: var(--green); }
        .amount.negative { color: var(--red); }
        .icon.earning { background-color: var(--green); }
        .icon.withdrawal { background-color: var(--red); }
        .icon.referral, .icon.login, .icon.task { background-color: var(--blue); }
        .icon.manual { background-color: var(--purple); }
        .icon.refund { background-color: var(--orange); }

        .promo-code-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .promo-code-form .form-group { margin: 0; }
        .promo-code-form button { height: 46px; }

        .targeted-actions-form .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }

        .user-management-toolbar { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 20px; }
        .user-management-toolbar .form-group { margin-bottom: 0; flex-grow: 1; }
        .user-management-toolbar .btn-add { margin-top: 0; }
        .user-management-toolbar .filter-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .user-management-toolbar .filter-group .form-group { min-width: 150px; flex-grow: 0.5;}

        .modal-transaction-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px; margin-top: 15px;}
        .modal-transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f5f5f5;}
        .modal-transaction-item:last-child { border-bottom: none; }
        .modal-transaction-info .title { font-size: 0.9rem; font-weight: 500;}
        .modal-transaction-info .date { font-size: 0.75rem; color: #888; }
        .admin-notes-section .form-group { margin-bottom: 10px; }
        .admin-notes-section button { width: auto; padding: 10px 20px; font-size: 0.9rem; }

        .ticket-details-container { background-color: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .ticket-details-container p { margin: 0 0 10px; }
        .ticket-details-container strong { color: var(--primary-bg); }
        .ticket-replies-list { max-height: 200px; overflow-y: auto; }
        .ticket-reply-item { margin-bottom: 15px; padding: 10px; border-radius: 8px; }
        .ticket-reply-item.user-reply { background-color: #e9ecef; }
        .ticket-reply-item.admin-reply { background-color: #d1e7dd; text-align: right; }
        .reply-meta { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; color: #555; }
        .reply-message { font-size: 0.95rem; }

        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background-color: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 10px; display: flex; align-items: center; opacity: 0; transform: translateX(100%); transition: all 0.5s ease-in-out; min-width: 250px; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { border-left: 5px solid var(--green); }
        .toast.error { border-left: 5px solid var(--red); }
        .toast.info { border-left: 5px solid var(--blue); }
        .toast-message { margin: 0; margin-left: 10px; }

        .pagination-container { display: flex; justify-content: center; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 5px; }
        .pagination-container button { background-color: var(--primary-bg); color: white; border: none; padding: 8px 15px; margin: 0 3px; cursor: pointer; border-radius: 4px; transition: background-color 0.2s; }
        .pagination-container button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .pagination-container button.active { background-color: var(--blue); }
        .pagination-container span { margin: 0 10px; font-weight: 500; }

        .order-controls { display: flex; flex-direction: column; justify-content: center; gap: 4px; }
        .btn-order { background: #7f8c8d; color: white; border: none; width: 28px; height: 28px; font-size: 1rem; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .btn-order:disabled { background: #ccc; cursor: not-allowed; }

        .analytics-filter-container { background-color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .analytics-filter-container label { font-weight: 600; }
        .analytics-filter-container select { padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); }
        
        .multi-level-referral-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 10px; }
        
        .ip-list { list-style: none; padding: 10px; background: #f9f9f9; border-radius: 5px; max-height: 150px; overflow-y: auto; }
        .ip-list-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #eee;}
        .ip-list-item:last-child { border-bottom: none; }
        
        .tooltip-icon {
            cursor: pointer;
            color: var(--blue);
            margin-left: 8px;
            position: relative;
        }
        
        .gamification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .level-setting {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .level-setting .day-label {
            font-weight: 600;
            text-align: center;
        }
        
        /* Styles for Quiz Editor */
        .quiz-category { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
        .quiz-category-header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px;}
        .quiz-question { background: #f9f9f9; border-radius: 5px; padding: 10px; margin-top: 10px; }
        .quiz-option { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }


        @media (max-width: 768px) {
            .tier-setting, .package-setting, .text-setting, .error-message-setting, .asset-setting, .firebase-config-setting { grid-template-columns: 1fr; gap: 10px; }
            .method-setting { grid-template-columns: 1fr; }
            .task-setting-grid { grid-template-columns: 1fr; }
            .method-setting .btn-remove, .task-setting .btn-remove, .tier-setting .btn-remove, .package-setting .btn-remove { margin-top: 5px; width: 100%; }
            .promo-code-form { grid-template-columns: 1fr; }

            .data-table thead { display: none; }
            .data-table, .data-table tbody, .data-table tr, .data-table td { display: block; width: 100%; }
            .data-table tr { margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 5px; overflow: hidden; }
            .data-table td { text-align: right; padding-left: 50%; position: relative; border: none; border-bottom: 1px solid #eee; }
            .data-table td:last-child { border-bottom: none; }
            .data-table td::before { content: attr(data-label); position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: var(--primary-bg); }
            .data-table .action-btn { margin-bottom: 5px; }

            .global-save-container {
                right: 10px;
                bottom: 10px;
            }
            .update-btn-global {
                font-size: 1rem;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <div class="app-container">
        <nav class="side-nav" id="sideNav">
            <div class="nav-header" data-lang-key="adminPanel">Admin Panel</div>
            <ul class="nav-links">
                <li><a href="#dashboard" class="nav-link active" data-lang-key="navDashboard"><i class="fas fa-tachometer-alt"></i>Dashboard</a></li>
                <li><a href="#user-management" class="nav-link" data-lang-key="navUserManagement"><i class="fas fa-users-cog"></i>Users Management</a></li>
                <li><a href="#withdraw-management" class="nav-link" data-lang-key="navWithdrawManagement"><i class="fas fa-money-check-alt"></i>Withdraw Management</a></li>
                <li><a href="#task-submissions" class="nav-link" data-lang-key="navTaskSubmissions"><i class="fas fa-tasks"></i>Task Submissions</a></li>
                <li><a href="#support-management" class="nav-link" data-lang-key="navSupport"><i class="fas fa-life-ring"></i>Support System</a></li>
                <li><a href="#audit-log" class="nav-link" data-lang-key="navAuditLog"><i class="fas fa-history"></i>Audit Log</a></li>
                <li><a href="#settings" class="nav-link" data-lang-key="navSettings"><i class="fas fa-cog"></i>Settings</a></li>
            </ul>
        </nav>

        <div class="overlay" id="overlay"></div>

        <main class="main-content">
            <header class="app-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
                    <div class="welcome-message" data-lang-key="welcomeAdmin">Welcome, Admin!</div>
                </div>
                <div class="lang-switcher">
                    <button id="lang-en" data-lang="en">EN</button>
                    <button id="lang-bn" data-lang="bn">BN</button>
                </div>
            </header>

            <div class="content-area">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page active">
                    <div class="analytics-filter-container">
                        <label for="analytics-time-filter" data-lang-key="showDataFor">Show Data For:</label>
                        <select id="analytics-time-filter">
                            <option value="7" data-lang-key="last7Days">Last 7 Days</option>
                            <option value="30" selected data-lang-key="last30Days">Last 30 Days</option>
                            <option value="90" data-lang-key="last90Days">Last 90 Days</option>
                            <option value="all" data-lang-key="allTime">All Time</option>
                        </select>
                    </div>

                    <div class="dashboard-grid">
                        <div class="dashboard-card"><div class="icon users"><i class="fas fa-users"></i></div><div class="card-content"><h3 id="db-total-users">0</h3><p data-lang-key="dbTotalUsers">Total Users</p></div></div>
                        <div class="dashboard-card"><div class="icon ads"><i class="fas fa-eye"></i></div><div class="card-content"><h3 id="db-ads-watched">0</h3><p data-lang-key="dbAdsWatched">Total Ads Watched</p></div></div>
                        <div class="dashboard-card"><div class="icon earnings"><i class="fas fa-wallet"></i></div><div class="card-content"><h3 id="db-total-earnings">BDT 0</h3><p data-lang-key="dbTotalEarnings">Total Earnings</p></div></div>
                        <div class="dashboard-card"><div class="icon commission"><i class="fas fa-percent"></i></div><div class="card-content"><h3 id="db-total-commission">BDT 0</h3><p data-lang-key="dbTotalCommission">Total Commission</p></div></div>
                        <div class="dashboard-card"><div class="icon referrals"><i class="fas fa-user-plus"></i></div><div class="card-content"><h3 id="db-total-referrals">0</h3><p data-lang-key="dbTotalReferrals">Total Referrals</p></div></div>
                        <div class="dashboard-card"><div class="icon request"><i class="fas fa-inbox"></i></div><div class="card-content"><h3 id="db-req-withdraw">0</h3><p data-lang-key="dbPendingRequests">Pending Requests</p></div></div>
                    </div>
                    <div class="analytics-grid">
                        <div class="section-card">
                            <div class="section-header" data-lang-key="chartUserGrowth"><i class="fas fa-chart-line"></i>দৈনিক ব্যবহারকারী বৃদ্ধি</div>
                            <div class="section-body">
                                <div class="chart-container">
                                    <canvas id="user-growth-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="section-card">
                            <div class="section-header" data-lang-key="chartDailyEarnings"><i class="fas fa-chart-bar"></i>দৈনিক মোট আয় (পয়েন্ট)</div>
                            <div class="section-body">
                                <div class="chart-container">
                                    <canvas id="daily-earnings-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="section-card">
                            <div class="section-header" data-lang-key="chartEarningSources"><i class="fas fa-chart-pie"></i>উপার্জনের উৎস</div>
                            <div class="section-body">
                                <div class="chart-container">
                                    <canvas id="earning-sources-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="section-card">
                            <div class="section-header" data-lang-key="chartActiveUsers"><i class="fas fa-users-viewfinder"></i>সক্রিয় ব্যবহারকারী (গত ৭ দিন)</div>
                            <div class="section-body">
                                <div class="chart-container">
                                    <canvas id="user-retention-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="section-card">
                            <div class="section-header" data-lang-key="chartTopEarners"><i class="fas fa-trophy"></i>Top 5 Earners</div>
                            <div class="section-body">
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead><tr><th data-lang-key="tableUser">User</th><th data-lang-key="tableTotalEarnings">Total Earnings (Points)</th></tr></thead>
                                        <tbody id="top-earners-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="section-card">
                            <div class="section-header" data-lang-key="chartTopReferrers"><i class="fas fa-users"></i>Top 5 Referrers</div>
                            <div class="section-body">
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead><tr><th data-lang-key="tableUser">User</th><th data-lang-key="tableTotalReferrals">Total Referrals</th></tr></thead>
                                        <tbody id="top-referrers-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="section-card">
                            <div class="section-header" data-lang-key="chartTopTasks"><i class="fas fa-clipboard-check"></i>Top Completed Tasks</div>
                            <div class="section-body">
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead><tr><th data-lang-key="tableTaskTitle">Task Title</th><th data-lang-key="tableCompletions">Completions</th></tr></thead>
                                        <tbody id="top-tasks-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Page -->
                <div id="user-management" class="page">
                    <div class="section-card">
                        <div class="section-header" data-lang-key="navUserManagement"><i class="fas fa-users"></i>Users Management</div>
                        <div class="section-body">
                            <div class="user-management-toolbar">
                                <div class="form-group">
                                    <input type="text" id="userSearch" placeholder="Search User (Name, Username, or ID)">
                                </div>
                                <div class="filter-group">
                                    <div class="form-group">
                                        <select id="filter-status">
                                            <option value="" data-lang-key="filterByStatus">Filter by Status</option>
                                            <option value="active" data-lang-key="filterActive">Active</option>
                                            <option value="blocked" data-lang-key="filterBlocked">Blocked</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <select id="filter-balance">
                                            <option value="" data-lang-key="filterByBalance">Filter by Balance</option>
                                            <option value="high" data-lang-key="filterHighestFirst">Highest First</option>
                                            <option value="low" data-lang-key="filterLowestFirst">Lowest First</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <input type="text" onfocus="(this.type='date')" onblur="(this.type='text')" id="filter-joined-date" placeholder="Joined Date After">
                                    </div>
                                    <div class="form-group">
                                        <input type="number" id="filter-inactive-days" placeholder="Inactive for (days)">
                                    </div>
                                </div>
                                <select id="bulk-action-select" class="form-group" style="padding: 12px; width: auto; flex-grow: 0.5;">
                                    <option value="" data-lang-key="bulkActions">Bulk Actions</option>
                                    <option value="block" data-lang-key="bulkBlock">Block Selected</option>
                                    <option value="unblock" data-lang-key="bulkUnblock">Unblock Selected</option>
                                    <option value="bonus" data-lang-key="bulkBonus">Give Bonus to Selected</option>
                                </select>
                                <button class="btn-add" style="background-color: var(--purple);" onclick="window.applyBulkAction()" data-lang-key="btnApply">Apply</button>
                                <button class="btn-add" style="background-color: var(--orange);" onclick="window.showFraudulentUsers()" data-lang-key="btnFindSuspicious">Find Suspicious Users</button>
                                <button class="btn-add" style="background-color: var(--teal);" onclick="window.exportUsersToCSV()">Export to CSV</button>
                                <button class="btn-add" onclick="window.renderUsers(true)" data-lang-key="btnResetFilter">Reset Filter</button>
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="select-all-users"></th>
                                            <th data-lang-key="tableUserId">User ID</th>
                                            <th data-lang-key="tableName">Name</th>
                                            <th data-lang-key="tableBalance">Balance (Points)</th>
                                            <th data-lang-key="tableStatus">Status</th>
                                            <th data-lang-key="tableActions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body"></tbody>
                                </table>
                            </div>
                            <div id="pagination-container" class="pagination-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Withdraw Management Page -->
                <div id="withdraw-management" class="page">
                    <div class="section-card">
                        <div class="section-header" data-lang-key="navWithdrawManagement"><i class="fas fa-money-check-alt"></i>Withdrawal Management</div>
                        <div class="section-body">
                            <nav class="tab-nav" id="withdraw-tab-nav">
                                <button class="tab-btn active" data-status="Pending" data-lang-key="statusPending">Pending</button>
                                <button class="tab-btn" data-status="Approved" data-lang-key="statusApproved">Approved</button>
                                <button class="tab-btn" data-status="Rejected" data-lang-key="statusRejected">Rejected</button>
                            </nav>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th data-lang-key="tableUserId">User ID</th>
                                            <th data-lang-key="tableDate">Date</th>
                                            <th data-lang-key="tableMethod">Method</th>
                                            <th data-lang-key="tableAccount">Account</th>
                                            <th data-lang-key="tableAmount">Amount</th>
                                            <th data-lang-key="tableStatus">Status</th>
                                            <th data-lang-key="tableActions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="withdraw-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task Submissions Page -->
                <div id="task-submissions" class="page">
                    <div class="section-card">
                        <div class="section-header" data-lang-key="navTaskSubmissions"><i class="fas fa-tasks"></i>Task Submissions Review</div>
                        <div class="section-body">
                            <p data-lang-key="taskSubmissionsDesc">এখানে ব্যবহারকারীদের জমা দেওয়া স্ক্রিনশট টাস্কগুলো রিভিউ করুন।</p>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th data-lang-key="tableUserId">User ID</th>
                                            <th data-lang-key="tableTaskTitle">Task Title</th>
                                            <th data-lang-key="tableSubmission">Submission</th>
                                            <th data-lang-key="tableDate">Date</th>
                                            <th data-lang-key="tableStatus">Status</th>
                                            <th data-lang-key="tableActions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="task-submissions-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Support System Page -->
                <div id="support-management" class="page">
                    <div class="section-card">
                        <div class="section-header" data-lang-key="navSupport"><i class="fas fa-life-ring"></i>Support Tickets</div>
                        <div class="section-body">
                             <p data-lang-key="supportDesc">এখানে ব্যবহারকারীদের পাঠানো বার্তা বা সমস্যাগুলো দেখা যাবে।</p>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th data-lang-key="tableUserId">User ID</th>
                                            <th data-lang-key="tableDate">Date</th>
                                            <th data-lang-key="tableSubject">Subject</th>
                                            <th data-lang-key="tableStatus">Status</th>
                                            <th data-lang-key="tableActions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="support-tickets-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Log Page -->
                <div id="audit-log" class="page">
                    <div class="section-card">
                        <div class="section-header" data-lang-key="navAuditLog"><i class="fas fa-history"></i>Audit Log</div>
                        <div class="section-body">
                            <p data-lang-key="auditLogDesc">অ্যাডমিন প্যানেলে করা সমস্ত গুরুত্বপূর্ণ কার্যকলাপের রেকর্ড এখানে দেখানো হলো।</p>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th data-lang-key="tableTimestamp">Timestamp</th>
                                            <th data-lang-key="tableAdmin">Admin</th>
                                            <th data-lang-key="tableAction">Action</th>
                                            <th data-lang-key="tableDetails">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="audit-log-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings" class="page">
                    <form id="settingsForm" onsubmit="event.preventDefault(); window.saveAllSettings();">
                        <div class="form-group" style="margin-bottom: 25px;">
                            <input type="text" id="settingsSearch" placeholder="🔍 Search settings sections...">
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-code"></i>Technical Settings<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="section-toggle">
                                    <label>Enable Telegram Web App Script (telegram.org/js/telegram-web-app.js)</label>
                                    <label class="switch"><input type="checkbox" id="telegramScriptEnabled"><span class="slider"></span></label>
                                </div>
                                <div class="form-group">
                                    <label for="libtlZoneId">LibTL Ad Network Zone ID</label>
                                    <input type="text" id="libtlZoneId" placeholder="e.g., 9892740">
                                    <small>এই আইডিটি userM16.html ফাইলের libtl.com স্ক্রিপ্টে ব্যবহৃত হবে।</small>
                                </div>
                                <hr>
                                <h4>Firebase Configuration <span style="color: var(--red); font-weight: bold;">(DANGER: Edit with extreme caution!)</span></h4>
                                <div id="firebase-config-container">
                                    <div class="firebase-config-setting"><label for="fb-apiKey">apiKey</label><input type="text" id="fb-apiKey"></div>
                                    <div class="firebase-config-setting"><label for="fb-authDomain">authDomain</label><input type="text" id="fb-authDomain"></div>
                                    <div class="firebase-config-setting"><label for="fb-databaseURL">databaseURL</label><input type="text" id="fb-databaseURL"></div>
                                    <div class="firebase-config-setting"><label for="fb-projectId">projectId</label><input type="text" id="fb-projectId"></div>
                                    <div class="firebase-config-setting"><label for="fb-storageBucket">storageBucket</label><input type="text" id="fb-storageBucket"></div>
                                    <div class="firebase-config-setting"><label for="fb-messagingSenderId">messagingSenderId</label><input type="text" id="fb-messagingSenderId"></div>
                                    <div class="firebase-config-setting"><label for="fb-appId">appId</label><input type="text" id="fb-appId"></div>
                                    <div class="firebase-config-setting"><label for="fb-measurementId">measurementId</label><input type="text" id="fb-measurementId"></div>
                                </div>
                                <button type="button" class="section-save-btn" onclick="window.saveTechnicalSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsDataManagement"><i class="fas fa-database"></i>Data Management<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="form-group">
                                    <label data-lang-key="backupLabel">Download a full backup of your app's data.</label>
                                    <button type="button" class="update-btn" style="background-color: var(--blue);" onclick="window.downloadBackup()" data-lang-key="btnDownloadBackup">Download Data Backup (JSON)</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsAssetManagement"><i class="fas fa-image"></i>Asset Management (App Images)<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                               <p data-lang-key="assetManagementDesc" style="color: #555; margin-bottom: 15px;">ব্যবহারকারী অ্যাপে দেখানো ছবি বা আইকনের লিঙ্ক এখানে পরিবর্তন করুন। পরিবর্তনের পর userM16.html ফাইলটিও আপডেট করতে হতে পারে।</p>
                               <div class="asset-setting">
                                   <label for="asset-ad-logo" data-lang-key="assetAdLogo">Ad Network Logo URL</label>
                                   <input type="text" id="asset-ad-logo" placeholder="URL of the ad network logo">
                               </div>
                               <div class="asset-setting">
                                   <label for="asset-default-avatar" data-lang-key="assetDefaultAvatar">Default User Avatar URL</label>
                                   <input type="text" id="asset-default-avatar" placeholder="URL for users without a profile picture">
                               </div>
                               <button type="button" class="section-save-btn" onclick="window.saveAssetSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-shield-alt"></i>IP Management<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <p style="color: #555; margin-bottom: 15px;">নির্দিষ্ট আইপি ঠিকানা ব্লক বা হোয়াইটলিস্ট করে অ্যাপের নিরাপত্তা বাড়ান।</p>
                                <div class="form-group">
                                    <label for="ip-address-input">IP Address</label>
                                    <input type="text" id="ip-address-input" placeholder="e.g., 192.168.1.1">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" class="update-btn" style="background-color: var(--red);" onclick="window.blockIp()">Block IP</button>
                                    <button type="button" class="update-btn" style="background-color: var(--green);" onclick="window.whitelistIp()">Whitelist IP</button>
                                </div>
                                <hr>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <h4>Blocked IPs</h4>
                                        <ul id="blocked-ip-list" class="ip-list"></ul>
                                    </div>
                                    <div>
                                        <h4>Whitelisted IPs</h4>
                                        <ul id="whitelisted-ip-list" class="ip-list"></ul>
                                    </div>
                                </div>
                                <button type="button" class="section-save-btn" onclick="window.saveIpManagementSettings()">Save IP Lists</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsAppControl"><i class="fas fa-bullhorn"></i>App Control<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="form-group"><label for="appVersion" data-lang-key="labelAppVersion">App Version</label><input type="text" id="appVersion" placeholder="e.g., 1.0.0"></div>
                                <div class="form-group">
                                    <label for="appUpdateMessage" data-lang-key="labelAppUpdateMessage">App Update Message</label>
                                    <textarea id="appUpdateMessage" placeholder="e.g., A new version is available. Please restart the bot to get the latest features."></textarea>
                                    <small data-lang-key="appUpdateMessageDesc">ব্যবহারকারীরা অ্যাপের পুরনো সংস্করণ ব্যবহার করলে এই বার্তাটি দেখতে পাবে।</small>
                                </div>
                                <hr>
                                <div class="form-group"><label for="botUsername" data-lang-key="labelBotUsername">Telegram Bot Username (without @)</label><input type="text" id="botUsername" placeholder="e.g., YourBotUsername"></div>
                                <div class="form-group"><label for="announcement" data-lang-key="labelAnnouncement">Announcement / Notice</label><textarea id="announcement" placeholder="অ্যাপের ব্যবহারকারীদের জন্য ঘোষণা..."></textarea></div>
                                <button type="button" class="section-save-btn" onclick="window.saveAppControlSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsGlobalNotification"><i class="fas fa-bell"></i>সকল ব্যবহারকারীকে নোটিফিকেশন পাঠান<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="form-group"><label for="global-notification-message" data-lang-key="labelNotificationMessage">নোটিফিকেশন বার্তা</label><textarea id="global-notification-message" placeholder="এই বার্তাটি সকল সক্রিয় ব্যবহারকারীর কাছে অ্যাপের ভেতর পপ-আপ হিসেবে দেখানো হবে..."></textarea></div>
                                <button type="button" class="update-btn" style="background-color: var(--blue);" id="send-global-notification-btn" data-lang-key="btnSendGlobalNotification">Send Global Notification</button>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsAppCustomization"><i class="fas fa-palette"></i>App Customization<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="form-group">
                                    <label for="themeColor" data-lang-key="labelThemeColor">App Primary Theme Color</label>
                                    <input type="color" id="themeColor">
                                </div>
                                <hr>
                                <div class="section-toggle">
                                    <label data-lang-key="labelEnableWelcomeBonus">Enable Welcome Bonus for New Users</label>
                                    <label class="switch"><input type="checkbox" id="welcomeBonusEnabled"><span class="slider"></span></label>
                                </div>
                                <div class="form-group"><label for="welcomeBonus" data-lang-key="labelWelcomeBonus">Welcome Bonus (Points)</label><input type="number" id="welcomeBonus" placeholder="e.g., 100"></div>
                                <hr>
                                <div class="form-group"><label for="dynamicWelcomeMessage" data-lang-key="labelWelcomeMessageTemplate">Welcome Message Template</label><input type="text" id="dynamicWelcomeMessage" placeholder="e.g., Welcome, {name}!"><small>Use <code>{name}</code> to insert the user's first name.</small></div>
                                <div class="form-group"><label for="dynamicShoppingButtonText" data-lang-key="labelShoppingButtonText">Shopping Button Text</label><input type="text" id="dynamicShoppingButtonText" placeholder="e.g., Start Shopping Now"></div>
                                <div class="form-group"><label for="dynamicShoppingButtonLink" data-lang-key="labelShoppingButtonLink">Shopping Button Link</label><input type="text" id="dynamicShoppingButtonLink" placeholder="e.g., https://your-shop.com"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveAppCustomizationSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsGamification"><i class="fas fa-gamepad"></i>Gamification Settings (XP & Levels)<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="gamification-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveGamificationSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsManageSettings"><i class="fas fa-cogs"></i>Manage Settings<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="form-group"><label for="adsReward" data-lang-key="labelAdsReward">Ads Reward (Default)</label><input type="number" step="0.01" id="adsReward"></div>
                                <div class="form-group"><label for="adsLimit" data-lang-key="labelDailyAdsLimit">Daily Ads Limit</label><input type="number" id="adsLimit"></div>
                                <div class="form-group"><label for="refferBonus" data-lang-key="labelReferralCommission">Referral Commission in % (Level 1)</label><input type="number" id="refferBonus"></div>
                                <div class="form-group"><label for="currency" data-lang-key="labelCurrencySymbol">Currency Symbol</label><input type="text" id="currency"></div>
                                <div class="form-group"><label for="pointsPerCurrency">Points per <span id="currency-label">Currency</span></label><input type="number" id="pointsPerCurrency" placeholder="e.g., 100"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveManageSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsReferralControl"><i class="fas fa-user-friends"></i>Referral System Control<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="form-group">
                                    <label for="maxReferrals" data-lang-key="labelMaxReferrals">Maximum Referrals Limit per User</label>
                                    <input type="number" id="maxReferrals" placeholder="e.g., 100 (0 for unlimited)">
                                </div>
                                <div class="form-group">
                                    <label for="referralCommissionActivation" data-lang-key="labelReferralCommissionActivation">Minimum Ads Watched by Referred User to Activate Commission</label>
                                    <input type="number" id="referralCommissionActivation" placeholder="e.g., 10 (0 to disable)">
                                    <small data-lang-key="referralCommissionActivationDesc">রেফার করা ব্যবহারকারী এই সংখ্যক বিজ্ঞাপন দেখার পরই রেফারার কমিশন পাওয়া শুরু করবে।</small>
                                </div>
                                <hr>
                                <div id="multi-level-referral-section">
                                    <div class="section-toggle">
                                        <label data-lang-key="labelEnableMultiLevelReferral">Enable Multi-Level Referral Commission</label>
                                        <label class="switch"><input type="checkbox" id="multiLevelReferralEnabled"><span class="slider"></span></label>
                                    </div>
                                    <div id="multi-level-referral-inputs" style="display: none;">
                                        <p><small data-lang-key="multiLevelReferralDesc">আপনার ব্যবহারকারীরা আরও রেফার করতে উৎসাহিত হবে। লেভেল ২ মানে হলো আপনার রেফার করা ব্যবহারকারী যাকে রেফার করেছে।</small></p>
                                        <div class="multi-level-referral-grid">
                                            <div class="form-group">
                                                <label for="referral-level2-commission" data-lang-key="labelLevel2Commission">Level 2 Commission (%)</label>
                                                <input type="number" id="referral-level2-commission" placeholder="e.g., 2">
                                            </div>
                                            <div class="form-group">
                                                <label for="referral-level3-commission" data-lang-key="labelLevel3Commission">Level 3 Commission (%)</label>
                                                <input type="number" id="referral-level3-commission" placeholder="e.g., 1">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="section-save-btn" onclick="window.saveReferralControlSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsPromoCode"><i class="fas fa-gift"></i>Promo Code Management<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <h4 data-lang-key="titleExistingPromoCodes">Existing Promo Codes</h4>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead><tr><th data-lang-key="tableCode">Code</th><th data-lang-key="tableReward">Reward (Points)</th><th data-lang-key="tableUsage">Usage</th><th data-lang-key="tableStatus">Status</th><th data-lang-key="tableActions">Actions</th></tr></thead>
                                        <tbody id="promo-codes-table-body"></tbody>
                                    </table>
                                </div>
                                <div class="promo-code-form">
                                    <div class="form-group"><label for="promo-code-name" data-lang-key="labelNewCode">New Code</label><input type="text" id="promo-code-name" placeholder="e.g., EIDBONUS25"></div>
                                    <div class="form-group"><label for="promo-code-reward" data-lang-key="labelRewardPoints">Reward (Points)</label><input type="number" id="promo-code-reward" placeholder="e.g., 500"></div>
                                    <div class="form-group"><label for="promo-code-limit" data-lang-key="labelUsageLimit">Usage Limit</label><input type="number" id="promo-code-limit" placeholder="e.g., 100"></div>
                                    <button type="button" class="update-btn" style="background-color: var(--blue);" onclick="window.createPromoCode()" data-lang-key="btnCreateCode">Create Code</button>
                                </div>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsAdvancedControl"><i class="fas fa-tools"></i>Advanced Control<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="form-group"><label for="adWatchTimerSeconds" data-lang-key="labelAdWatchTimer">Ad Watch Timer (Seconds) - Default</label><input type="number" id="adWatchTimerSeconds" placeholder="e.g., 30"></div>
                                <div class="form-group"><label for="hourlyAdsLimit" data-lang-key="labelHourlyAdsLimit">Hourly Ads Limit</label><input type="number" id="hourlyAdsLimit" placeholder="e.g., 25"></div>
                                <div class="form-group"><label for="minReferralsForWithdrawal" data-lang-key="labelMinReferralsForWithdrawal">Minimum Referrals for Withdrawal</label><input type="number" id="minReferralsForWithdrawal" placeholder="e.g., 3"></div>
                                <hr>
                                <div class="section-toggle"><label data-lang-key="labelEnableMaintenance">Enable Maintenance Mode</label><label class="switch"><input type="checkbox" id="maintenanceMode"><span class="slider"></span></label></div>
                                <button type="button" class="section-save-btn" onclick="window.saveAdvancedControlSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsFraudDetection"><i class="fas fa-user-secret"></i>Advanced Fraud Detection Settings<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="form-group">
                                    <label for="ipSharingLimit" data-lang-key="labelIpSharingLimit">IP Sharing Limit</label>
                                    <input type="number" id="ipSharingLimit" placeholder="e.g., 3">
                                    <small data-lang-key="ipSharingLimitDesc">একই IP ঠিকানা থেকে সর্বোচ্চ কতজন ব্যবহারকারীকে অনুমতি দেওয়া হবে। এর বেশি হলে তাদের সন্দেহজনক হিসেবে দেখানো হবে।</small>
                                </div>
                                <hr>
                                <div id="vpn-detection-section">
                                    <div class="section-toggle">
                                        <label data-lang-key="labelEnableVpnDetection">Enable VPN/Proxy Detection</label>
                                        <label class="switch"><input type="checkbox" id="vpnDetectionEnabled"><span class="slider"></span></label>
                                    </div>
                                    <div id="vpn-detection-options" style="display: none;">
                                        <div class="form-group">
                                            <label for="vpn-detection-action" data-lang-key="labelVpnAction">Action on Detection</label>
                                            <select id="vpn-detection-action">
                                                <option value="warn" data-lang-key="vpnActionWarn">Warn the User</option>
                                                <option value="block_earning" data-lang-key="vpnActionBlockEarning">Block from Earning</option>
                                                <option value="block_account" data-lang-key="vpnActionBlockAccount">Block Account Automatically</option>
                                            </select>
                                            <small data-lang-key="vpnActionDesc">VPN ব্যবহারকারী শনাক্ত হলে সিস্টেম কী পদক্ষেপ নেবে তা নির্ধারণ করুন।</small>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="section-save-btn" onclick="window.saveFraudDetectionSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsTargetedActions"><i class="fas fa-bullseye"></i>Targeted Actions (User Segmentation)<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="grid">
                                    <div class="form-group"><label for="target-segment" data-lang-key="labelSelectTargetSegment">Select Target Segment</label><select id="target-segment"><option value="all" data-lang-key="segmentAllUsers">All Active Users</option><option value="tier" data-lang-key="segmentUsersByTier">Users by Tier</option><option value="inactive" data-lang-key="segmentInactiveUsers">Inactive Users</option></select></div>
                                    <div class="form-group" id="tier-select-group" style="display: none;"><label for="target-tier" data-lang-key="labelSelectTier">Select Tier</label><select id="target-tier"></select></div>
                                    <div class="form-group" id="inactive-days-group" style="display: none;"><label for="inactive-days" data-lang-key="labelInactiveForDays">Inactive for more than (days)</label><input type="number" id="inactive-days" value="7"></div>
                                </div><hr>
                                <div class="grid"><div class="form-group"><label for="action-type" data-lang-key="labelSelectAction">Select Action</label><select id="action-type"><option value="notification" data-lang-key="actionSendNotification">Send Notification</option><option value="bonus" data-lang-key="actionGiveBonus">Give Bonus Points</option></select></div></div>
                                <div class="form-group" id="action-notification-group"><label for="action-notification-message" data-lang-key="labelNotificationMessage">Notification Message</label><textarea id="action-notification-message" placeholder="Message for the targeted users..."></textarea></div>
                                <div class="form-group" id="action-bonus-group" style="display: none;"><label for="action-bonus-points" data-lang-key="labelBonusPoints">Bonus Points</label><input type="number" id="action-bonus-points" placeholder="e.g., 200"><label for="action-bonus-reason" style="margin-top: 10px;" data-lang-key="labelReasonForBonus">Reason for Bonus</label><input type="text" id="action-bonus-reason" placeholder="e.g., Special gift for Gold members"></div>
                                <button type="button" class="update-btn" style="background-color: var(--purple);" onclick="window.executeTargetedAction()" data-lang-key="btnExecuteAction">Execute Action</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-hand-holding-usd"></i>Ad System Management<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                
                                <h4>Primary Ad (Click to Watch & Earn)</h4>
                                <div class="section-toggle">
                                    <label>Enable Primary Ad Feature</label>
                                    <label class="switch"><input type="checkbox" id="primaryAdEnabled"><span class="slider"></span></label>
                                </div>
                                <div class="gamification-grid" style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label>Reward (Points)</label>
                                        <input type="number" id="primaryAdReward" placeholder="e.g., 15">
                                    </div>
                                    <div class="form-group">
                                        <label>Timer (Seconds)</label>
                                        <input type="number" id="primaryAdTimer" placeholder="e.g., 30">
                                    </div>
                                </div>
                                
                                <hr>
                        
                                <h4>Rewarded Ad (After Task Completion)</h4>
                                <div class="section-toggle">
                                    <label>Enable Rewarded Ad Feature</label>
                                    <label class="switch"><input type="checkbox" id="rewardedAdEnabled"><span class="slider"></span></label>
                                </div>
                                <div id="rewarded-ad-options-container" style="margin-top: 15px;">
                                     <div class="section-toggle" style="background-color: #f0f0f0; padding: 10px;">
                                        <label>Trigger Ad after ANY 'Join & Claim' Task</label>
                                        <label class="switch"><input type="checkbox" id="rewardedAdTriggerOnTask"><span class="slider"></span></label>
                                    </div>
                                    <div class="gamification-grid" style="margin-top: 15px;">
                                        <div class="form-group">
                                            <label>Reward (Points)</label>
                                            <input type="number" id="rewardedAdReward" placeholder="e.g., 25">
                                        </div>
                                        <div class="form-group">
                                            <label>Timer (Seconds)</label>
                                            <input type="number" id="rewardedAdTimer" placeholder="e.g., 20">
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="section-save-btn" onclick="window.saveAdSystemSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <!-- #### START: NEW EARNING FEATURES #### -->

                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-bullseye"></i>Spin Wheel Settings<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="spin-wheel-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveSpinWheelSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-scratch"></i>Scratch Card Settings<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="scratch-card-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveScratchCardSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-video"></i>Video Zone Settings<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="video-zone-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveVideoZoneSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-question-circle"></i>Quiz System Settings<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="quiz-system-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveQuizSystemSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-keyboard"></i>Captcha Entry Settings<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="captcha-entry-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveCaptchaEntrySettings()">Save Changes</button>
                            </div>
                        </div>

                        <!-- #### END: NEW EARNING FEATURES #### -->

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsDailyCheckin"><i class="fas fa-calendar-check"></i>Daily Check-in Bonus<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="daily-checkin-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveDailyCheckinSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsTasks"><i class="fas fa-tasks"></i>Complete Tasks<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="tasks-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveTasksSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsUserTiers"><i class="fas fa-layer-group"></i>ব্যবহারকারীর স্তর (User Tiers)<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="user-tiers-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveUserTiersSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsWithdrawalMonetization"><i class="fas fa-wallet"></i>Withdrawal & Monetization<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div class="form-group"><label for="minWithdraw" data-lang-key="labelMinWithdrawal">Minimum Withdrawal Limit</label><input type="number" id="minWithdraw"></div>
                                <div class="form-group">
                                    <label for="withdrawalFeePercent" data-lang-key="labelWithdrawalFee">Withdrawal Fee (%)</label>
                                    <input type="number" id="withdrawalFeePercent" placeholder="e.g., 5 for 5%">
                                </div>
                                <hr>
                                <div id="withdrawal-methods-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveWithdrawalSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-gifts"></i>Offerwall Management<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="offerwall-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveOfferwallSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header"><i class="fas fa-ticket-alt"></i>Lottery System<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="lottery-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveLotterySettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsLeaderboard"><i class="fas fa-trophy"></i>Leaderboard Management<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="leaderboard-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveLeaderboardSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsPointStore"><i class="fas fa-store"></i>পয়েন্ট স্টোর (Store)<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="point-packages-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveStoreSettings()">Save Changes</button>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsTextManagement"><i class="fas fa-edit"></i>অ্যাপের টেক্সট পরিবর্তন (Text Management)<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="text-management-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveTextManagementSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsAdvancedTextManagement"><i class="fas fa-language"></i>Advanced Text Management (UI Labels)<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="advanced-text-management-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveAdvancedTextSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <div class="section-header" data-lang-key="settingsErrorMessages"><i class="fas fa-exclamation-triangle"></i>ত্রুটির বার্তা নিয়ন্ত্রণ (Error Messages)<i class="fas fa-chevron-down toggle-icon"></i></div>
                            <div class="section-body collapsed">
                                <div id="error-message-section"></div>
                                <button type="button" class="section-save-btn" onclick="window.saveErrorMessagesSettings()">Save Changes</button>
                            </div>
                        </div>
                        
                        <div class="global-save-container">
                             <button type="submit" class="update-btn-global" data-lang-key="btnUpdateAllSettings">UPDATE ALL SETTINGS</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="user-edit-modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-user-name">Edit User</h3><button class="modal-close-btn" onclick="closeUserEditModal()">&times;</button></div>
            <div class="modal-body">
                <div class="user-details" id="user-details-content"></div><hr>
                
                <h4 data-lang-key="modalManualTransaction">Manual Transaction</h4>
                <div class="form-group"><label for="points-to-add" data-lang-key="modalAddSubtractPoints">Add/Subtract Points (e.g., 100 or -50)</label><input type="number" id="points-to-add" placeholder="0"></div>
                <div class="form-group"><label for="transaction-reason" data-lang-key="modalReason">Reason (will be shown in user's history)</label><input type="text" id="transaction-reason" placeholder="e.g., Weekly bonus, refund..."></div>
                <button class="update-btn" id="save-user-changes-btn" data-lang-key="btnSaveChanges">Save Changes & Add to History</button><hr>
                
                <h4 data-lang-key="modalUserAdStats">User Ad Stats</h4>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <button class="update-btn" style="background-color: var(--orange);" onclick="window.resetUserStats('daily')" data-lang-key="btnResetDailyCount">Reset Daily Ad Count</button>
                    <button class="update-btn" style="background-color: var(--yellow); color: #333;" onclick="window.resetUserStats('hourly')" data-lang-key="btnResetHourlyCount">Reset Hourly Ad Count</button>
                </div>
                <hr>

                <h4 data-lang-key="modalRefundTransaction">Refund a Transaction</h4>
                <div id="modal-refund-section">
                    <p><small data-lang-key="modalRefundDesc">ব্যবহারকারীর সাম্প্রতিক লেনদেনগুলো নিচে দেখানো হলো। যেকোনো লেনদেন রিফান্ড করতে বাটনে ক্লিক করুন।</small></p>
                    <div class="modal-transaction-list" id="modal-transaction-list-container"></div>
                </div>
                <hr>
                
                <div class="admin-notes-section">
                    <h4 data-lang-key="modalAdminNotes">Admin Notes (Visible to Admins Only)</h4>
                    <div class="form-group">
                        <textarea id="admin-notes-textarea" placeholder="Add a private note about this user..."></textarea>
                    </div>
                    <button class="update-btn" style="background-color: var(--teal);" onclick="window.saveAdminNote()" data-lang-key="btnSaveNote">Save Note</button>
                </div>
                <hr>

                <h4 data-lang-key="modalSendNotification">Send Notification</h4>
                <div class="form-group"><label for="user-notification-message" data-lang-key="modalMessageForUser">Message for this user</label><textarea id="user-notification-message" placeholder="This message will be shown to the user in the app..."></textarea></div>
                <button class="update-btn" style="background-color: var(--blue);" onclick="window.sendUserNotification()" data-lang-key="btnSendNotification">Send Notification</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="user-history-modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-history-user-name">Transaction History</h3><button class="modal-close-btn" onclick="closeUserHistoryModal()">&times;</button></div>
            <div class="modal-body" id="user-history-content"></div>
        </div>
    </div>
    <div class="modal-overlay" id="user-referrals-modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-referrals-user-name">User's Referrals</h3><button class="modal-close-btn" onclick="closeUserReferralsModal()">&times;</button></div>
            <div class="modal-body" id="user-referrals-content"></div>
        </div>
    </div>
    <div class="modal-overlay" id="support-ticket-modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-ticket-subject">Support Ticket</h3><button class="modal-close-btn" onclick="closeSupportTicketModal()">&times;</button></div>
            <div class="modal-body">
                <div class="ticket-details-container" id="ticket-details-content"></div>
                <div class="ticket-replies-list" id="ticket-replies-list"></div>
                <hr>
                <h4 data-lang-key="modalSendReply">Send Reply</h4>
                <div class="form-group"><textarea id="ticket-reply-message" placeholder="Write your reply..."></textarea></div>
                <button class="update-btn" style="background-color: var(--blue);" onclick="window.sendSupportReply()" data-lang-key="btnSendReply">Send Reply</button>
            </div>
        </div>
    </div>
     <div class="modal-overlay" id="screenshot-modal">
        <div class="modal-content">
            <div class="modal-header"><h3 data-lang-key="modalScreenshot">Screenshot</h3><button class="modal-close-btn" onclick="closeScreenshotModal()">&times;</button></div>
            <div class="modal-body" style="text-align: center;">
                <img id="screenshot-image" src="" alt="Screenshot" style="max-width: 100%; max-height: 60vh; border-radius: 8px;">
            </div>
        </div>
    </div>


<!-- Firebase SDKs -->
<script type="module">
    // --- Firebase Configuration ---
    const firebaseConfig = {
    apiKey: "AIzaSyD5WNVy_CCoQ9cuHWNeTYf0UirKLwIs8hQ",
    authDomain: "the-ramjan-earnings.firebaseapp.com",
    databaseURL: "https://the-ramjan-earnings-default-rtdb.firebaseio.com",
    projectId: "the-ramjan-earnings",
    storageBucket: "the-ramjan-earnings.firebasestorage.app",
    messagingSenderId: "273789835484",
    appId: "1:273789835484:web:bc05207508c7b2d29b3c19"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push, remove, query, orderByKey, limitToFirst, startAt } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    let app = initializeApp(firebaseConfig);
    let database = getDatabase(app);
    
    let dbRef, configRef, usersRef, withdrawRequestsRef, supportTicketsRef, taskSubmissionsRef, globalNotificationRef, promoCodesRef, lotteryRef, auditLogRef;

    function initializeDbRefs() {
        dbRef = ref(database);
        configRef = ref(database, 'app/config'); 
        usersRef = ref(database, 'app/users');
        withdrawRequestsRef = ref(database, 'app/withdraw_requests');
        supportTicketsRef = ref(database, 'app/support_tickets');
        taskSubmissionsRef = ref(database, 'app/task_submissions'); 
        globalNotificationRef = ref(database, 'app/global_notification');
        promoCodesRef = ref(database, 'app/promo_codes');
        lotteryRef = ref(database, 'app/lottery');
        auditLogRef = ref(database, 'app/audit_log');
    }
    
    initializeDbRefs();


    document.addEventListener('DOMContentLoaded', function () {
        const menuToggle = document.getElementById('menuToggle');
        const sideNav = document.getElementById('sideNav');
        const overlay = document.getElementById('overlay');
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const settingsForm = document.getElementById('settingsForm');

        let appConfig = {};
        let allUsers = {};
        let allWithdrawals = {};
        let currentWithdrawFilter = 'Pending';
        let currentEditingUserId = null;
        let currentReplyingTicketId = null;
        let userGrowthChart = null, dailyEarningsChart = null, earningSourcesChart = null, userRetentionChart = null;

        const originalDocTitle = document.title;
        
        let currentPage = 1;
        const usersPerPage = 50;
        let pageStartKeys = [null];
        let totalUsersCount = 0;
        let currentFilteredUsers = [];
        
        const translations = {
            en: {
                adminPanel: "Admin Panel", navDashboard: "Dashboard", navUserManagement: "Users Management", navWithdrawManagement: "Withdraw Management", navTaskSubmissions: "Task Submissions", navSupport: "Support System", navAuditLog: "Audit Log", navSettings: "Settings", welcomeAdmin: "Welcome, Admin!",
                showDataFor: "Show Data For:", last7Days: "Last 7 Days", last30Days: "Last 30 Days", last90Days: "Last 90 Days", allTime: "All Time",
                dbTotalUsers: "Total Users", dbAdsWatched: "Total Ads Watched", dbTotalEarnings: "Total Earnings", dbTotalCommission: "Total Commission", dbTotalReferrals: "Total Referrals", dbPendingRequests: "Pending Requests",
                chartUserGrowth: "Daily User Growth", chartDailyEarnings: "Daily Total Earnings (Points)", chartEarningSources: "Earning Sources", chartActiveUsers: "Active Users (Last 7 Days)", chartTopEarners: "Top 5 Earners", chartTopReferrers: "Top 5 Referrers", chartTopTasks: "Top Completed Tasks",
                tableUser: "User", tableTotalEarnings: "Total Earnings (Points)", tableTotalReferrals: "Total Referrals", tableTaskTitle: "Task Title", tableCompletions: "Completions",
                filterByStatus: "Filter by Status", filterActive: "Active", filterBlocked: "Blocked", filterByBalance: "Filter by Balance", filterHighestFirst: "Highest First", filterLowestFirst: "Lowest First",
                bulkActions: "Bulk Actions", bulkBlock: "Block Selected", bulkUnblock: "Unblock Selected", bulkBonus: "Give Bonus to Selected",
                btnApply: "Apply", btnFindSuspicious: "Find Suspicious Users", btnResetFilter: "Reset Filter",
                tableUserId: "User ID", tableName: "Name", tableBalance: "Balance (Points)", tableStatus: "Status", tableActions: "Actions",
                statusPending: "Pending", statusApproved: "Approved", statusRejected: "Rejected", tableDate: "Date", tableMethod: "Method", tableAccount: "Account", tableAmount: "Amount",
                taskSubmissionsDesc: "Review screenshot tasks submitted by users here.", tableSubmission: "Submission",
                supportDesc: "View messages or issues sent by users here.", tableSubject: "Subject",
                auditLogDesc: "Records of all important activities performed in the admin panel are shown here.", tableTimestamp: "Timestamp", tableAdmin: "Admin", tableAction: "Action", tableDetails: "Details",
                settingsDataManagement: "Data Management", backupLabel: "Download a full backup of your app's data.", btnDownloadBackup: "Download Data Backup (JSON)",
                settingsAssetManagement: "Asset Management (App Images)", assetManagementDesc: "Change the links for images or icons shown in the user app here. After changing, the userM16.html file might also need to be updated.", assetAdLogo: "Ad Network Logo URL", assetDefaultAvatar: "Default User Avatar URL",
                settingsAppControl: "App Control", labelAppVersion: "App Version", labelBotUsername: "Telegram Bot Username (without @)", labelAnnouncement: "Announcement / Notice", labelAppUpdateMessage: "App Update Message", appUpdateMessageDesc: "Users on older app versions will see this message.",
                settingsGlobalNotification: "Send Notification to All Users", labelNotificationMessage: "Notification Message", btnSendGlobalNotification: "Send Global Notification",
                settingsAppCustomization: "App Customization", labelThemeColor: "App Primary Theme Color", labelEnableWelcomeBonus: "Enable Welcome Bonus for New Users", labelWelcomeBonus: "Welcome Bonus (Points)", labelWelcomeMessageTemplate: "Welcome Message Template", labelShoppingButtonText: "Shopping Button Text", labelShoppingButtonLink: "Shopping Button Link",
                settingsGamification: "Gamification Settings (XP & Levels)",
                settingsManageSettings: "Manage Settings", labelAdsReward: "Ads Reward (Default)", labelDailyAdsLimit: "Daily Ads Limit", labelReferralCommission: "Referral Commission in % (Level 1)", labelCurrencySymbol: "Currency Symbol",
                settingsReferralControl: "Referral System Control", labelMaxReferrals: "Maximum Referrals Limit per User", labelReferralCommissionActivation: "Minimum Ads Watched by Referred User to Activate Commission", referralCommissionActivationDesc: "The referrer will start earning commission only after the referred user watches this number of ads.",
                labelEnableMultiLevelReferral: "Enable Multi-Level Referral Commission", multiLevelReferralDesc: "Encourage users to refer more. Level 2 means a user referred by your referral.", labelLevel2Commission: "Level 2 Commission (%)", labelLevel3Commission: "Level 3 Commission (%)",
                settingsPromoCode: "Promo Code Management", titleExistingPromoCodes: "Existing Promo Codes", tableCode: "Code", tableReward: "Reward (Points)", tableUsage: "Usage", labelNewCode: "New Code", labelRewardPoints: "Reward (Points)", labelUsageLimit: "Usage Limit", btnCreateCode: "Create Code",
                settingsAdvancedControl: "Advanced Control", labelAdWatchTimer: "Ad Watch Timer (Seconds) - Default", labelHourlyAdsLimit: "Hourly Ads Limit", labelMinReferralsForWithdrawal: "Minimum Referrals for Withdrawal", labelEnableMaintenance: "Enable Maintenance Mode",
                settingsFraudDetection: "Advanced Fraud Detection Settings", labelIpSharingLimit: "IP Sharing Limit", ipSharingLimitDesc: "Maximum number of users allowed from the same IP address. More than this will be shown as suspicious.",
                labelEnableVpnDetection: "Enable VPN/Proxy Detection", labelVpnAction: "Action on Detection", vpnActionWarn: "Warn the User", vpnActionBlockEarning: "Block from Earning", vpnActionBlockAccount: "Block Account Automatically", vpnActionDesc: "Determine what action the system will take when a VPN user is detected.",
                settingsTargetedActions: "Targeted Actions (User Segmentation)", labelSelectTargetSegment: "Select Target Segment", segmentAllUsers: "All Active Users", segmentUsersByTier: "Users by Tier", segmentInactiveUsers: "Inactive Users", labelSelectTier: "Select Tier", labelInactiveForDays: "Inactive for more than (days)",
                labelSelectAction: "Select Action", actionSendNotification: "Send Notification", actionGiveBonus: "Give Bonus Points", labelBonusPoints: "Bonus Points", labelReasonForBonus: "Reason for Bonus", btnExecuteAction: "Execute Action",
                settingsDailyCheckin: "Daily Check-in Bonus", settingsTasks: "Complete Tasks", settingsUserTiers: "User Tiers",
                settingsWithdrawalMonetization: "Withdrawal & Monetization", labelMinWithdrawal: "Minimum Withdrawal Limit", labelWithdrawalFee: "Withdrawal Fee (%)",
                settingsLeaderboard: "Leaderboard Management", settingsPointStore: "Point Store", settingsTextManagement: "Text Management", settingsAdvancedTextManagement: "Advanced Text Management (UI Labels)", settingsErrorMessages: "Error Messages Control",
                btnUpdateAllSettings: "UPDATE ALL SETTINGS",
                modalManualTransaction: "Manual Transaction", modalAddSubtractPoints: "Add/Subtract Points (e.g., 100 or -50)", modalReason: "Reason (will be shown in user's history)", btnSaveChanges: "Save Changes & Add to History",
                modalUserAdStats: "User Ad Stats", btnResetDailyCount: "Reset Daily Ad Count", btnResetHourlyCount: "Reset Hourly Ad Count",
                modalRefundTransaction: "Refund a Transaction", modalRefundDesc: "User's recent transactions are shown below. Click the button to refund any transaction.",
                modalAdminNotes: "Admin Notes (Visible to Admins Only)", btnSaveNote: "Save Note",
                modalSendNotification: "Send Notification", modalMessageForUser: "Message for this user", btnSendNotification: "Send Notification",
                modalSendReply: "Send Reply", btnSendReply: "Send Reply", modalScreenshot: "Screenshot",
            },
            bn: {
                adminPanel: "অ্যাডমিন প্যানেল", navDashboard: "ড্যাশবোর্ড", navUserManagement: "ব্যবহারকারী ব্যবস্থাপনা", navWithdrawManagement: "উত্তোলন ব্যবস্থাপনা", navTaskSubmissions: "টাস্ক সাবমিশন", navSupport: "সাপোর্ট সিস্টেম", navAuditLog: "অডিট লগ", navSettings: "সেটিংস", welcomeAdmin: "স্বাগতম, অ্যাডমিন!",
                showDataFor: "ডেটা দেখুন:", last7Days: "গত ৭ দিন", last30Days: "গত ৩০ দিন", last90Days: "গত ৯০ দিন", allTime: "সর্বমোট",
                dbTotalUsers: "মোট ব্যবহারকারী", dbAdsWatched: "মোট বিজ্ঞাপন দেখা হয়েছে", dbTotalEarnings: "মোট আয়", dbTotalCommission: "মোট কমিশন", dbTotalReferrals: "মোট রেফারেল", dbPendingRequests: "অপেক্ষারত অনুরোধ",
                chartUserGrowth: "দৈনিক ব্যবহারকারী বৃদ্ধি", chartDailyEarnings: "দৈনিক মোট আয় (পয়েন্ট)", chartEarningSources: "উপার্জনের উৎস", chartActiveUsers: "সক্রিয় ব্যবহারকারী (গত ৭ দিন)", chartTopEarners: "সেরা ৫ আয়কারী", chartTopReferrers: "সেরা ৫ রেফারকারী", chartTopTasks: "সর্বাধিক সম্পন্ন টাস্ক",
                tableUser: "ব্যবহারকারী", tableTotalEarnings: "মোট আয় (পয়েন্ট)", tableTotalReferrals: "মোট রেফারেল", tableTaskTitle: "টাস্কের নাম", tableCompletions: "সমাপ্তির সংখ্যা",
                filterByStatus: "স্ট্যাটাস অনুযায়ী ফিল্টার", filterActive: "সক্রিয়", filterBlocked: "ব্লকড", filterByBalance: "ব্যালেন্স অনুযায়ী ফিল্টার", filterHighestFirst: "সর্বোচ্চ প্রথমে", filterLowestFirst: "সর্বনিম্ন প্রথমে",
                bulkActions: "বাল্ক অ্যাকশন", bulkBlock: "নির্বাচিতদের ব্লক করুন", bulkUnblock: "নির্বাচিতদের আনব্লক করুন", bulkBonus: "নির্বাচিতদের বোনাস দিন",
                btnApply: "প্রয়োগ", btnFindSuspicious: "সন্দেহজনক ব্যবহারকারী খুঁজুন", btnResetFilter: "ফিল্টার রিসেট",
                tableUserId: "ব্যবহারকারী আইডি", tableName: "নাম", tableBalance: "ব্যালেন্স (পয়েন্ট)", tableStatus: "স্ট্যাটাস", tableActions: "অ্যাকশন",
                statusPending: "অপেক্ষমাণ", statusApproved: "অনুমোদিত", statusRejected: "প্রত্যাখ্যাত", tableDate: "তারিখ", tableMethod: "মাধ্যম", tableAccount: "অ্যাকাউন্ট", tableAmount: "পরিমাণ",
                taskSubmissionsDesc: "এখানে ব্যবহারকারীদের জমা দেওয়া স্ক্রিনশট টাস্কগুলো রিভিউ করুন।", tableSubmission: "জমাদান",
                supportDesc: "এখানে ব্যবহারকারীদের পাঠানো বার্তা বা সমস্যাগুলো দেখা যাবে।", tableSubject: "বিষয়",
                auditLogDesc: "অ্যাডমিন প্যানেলে করা সমস্ত গুরুত্বপূর্ণ কার্যকলাপের রেকর্ড এখানে দেখানো হলো।", tableTimestamp: "সময়", tableAdmin: "অ্যাডমিন", tableAction: "কার্যকলাপ", tableDetails: "বিস্তারিত",
                settingsDataManagement: "ডেটা ম্যানেজমেন্ট", backupLabel: "আপনার অ্যাপের ডেটার একটি সম্পূর্ণ ব্যাকআপ ডাউনলোড করুন।", btnDownloadBackup: "ডেটা ব্যাকআপ ডাউনলোড করুন (JSON)",
                settingsAssetManagement: "অ্যাপের ছবি পরিচালনা", assetManagementDesc: "ব্যবহারকারী অ্যাপে দেখানো ছবি বা আইকনের লিঙ্ক এখানে পরিবর্তন করুন। পরিবর্তনের পর userM16.html ফাইলটিও আপডেট করতে হতে পারে।", assetAdLogo: "বিজ্ঞাপন নেটওয়ার্ক লোগো URL", assetDefaultAvatar: "ডিফল্ট ব্যবহারকারী অ্যাভাটার URL",
                settingsAppControl: "অ্যাপ নিয়ন্ত্রণ", labelAppVersion: "অ্যাপ সংস্করণ", labelBotUsername: "টেলিগ্রাম বট ইউজারনেম (@ ছাড়া)", labelAnnouncement: "ঘোষণা / নোটিশ", labelAppUpdateMessage: "অ্যাপ আপডেট বার্তা", appUpdateMessageDesc: "ব্যবহারকারীরা অ্যাপের পুরনো সংস্করণ ব্যবহার করলে এই বার্তাটি দেখতে পাবে।",
                settingsGlobalNotification: "সকল ব্যবহারকারীকে নোটিফিকেশন পাঠান", labelNotificationMessage: "নোটিফিকেশন বার্তা", btnSendGlobalNotification: "গ্লোবাল নোটিফিকেশন পাঠান",
                settingsAppCustomization: "অ্যাপ কাস্টমাইজেশন", labelThemeColor: "অ্যাপের প্রাথমিক থিম রঙ", labelEnableWelcomeBonus: "নতুন ব্যবহারকারীদের জন্য স্বাগতম বোনাস সক্ষম করুন", labelWelcomeBonus: "স্বাগতম বোনাস (পয়েন্ট)", labelWelcomeMessageTemplate: "স্বাগতম বার্তার টেমপ্লেট", labelShoppingButtonText: "শপিং বাটনের লেখা", labelShoppingButtonLink: "শপিং বাটনের লিঙ্ক",
                settingsGamification: "গ্যামিফিকেশন সেটিংস (XP এবং লেভেল)",
                settingsManageSettings: "সেটিংস পরিচালনা", labelAdsReward: "বিজ্ঞাপন পুরস্কার (ডিফল্ট)", labelDailyAdsLimit: "দৈনিক বিজ্ঞাপন দেখার সীমা", labelReferralCommission: "রেফারেল কমিশন % (লেভেল ১)", labelCurrencySymbol: "কারেন্সি প্রতীক",
                settingsReferralControl: "রেফারেল সিস্টেম নিয়ন্ত্রণ", labelMaxReferrals: "ব্যবহারকারী প্রতি সর্বোচ্চ রেফারেল সীমা", labelReferralCommissionActivation: "কমিশন সক্রিয় করতে রেফার করা ব্যবহারকারীর সর্বনিম্ন বিজ্ঞাপন দেখার সংখ্যা", referralCommissionActivationDesc: "রেফার করা ব্যবহারকারী এই সংখ্যক বিজ্ঞাপন দেখার পরই রেফারার কমিশন পাওয়া শুরু করবে।",
                labelEnableMultiLevelReferral: "একাধিক স্তরের রেফারেল কমিশন চালু করুন", multiLevelReferralDesc: "আপনার ব্যবহারকারীরা আরও রেফার করতে উৎসাহিত হবে। লেভেল ২ মানে হলো আপনার রেফার করা ব্যবহারকারী যাকে রেফার করেছে।", labelLevel2Commission: "লেভেল ২ কমিশন (%)", labelLevel3Commission: "লেভেল ৩ কমিশন (%)",
                settingsPromoCode: "প্রোমো কোড ম্যানেজমেন্ট", titleExistingPromoCodes: "বিদ্যমান প্রোমো কোড", tableCode: "কোড", tableReward: "পুরস্কার (পয়েন্ট)", tableUsage: "ব্যবহার", labelNewCode: "নতুন কোড", labelRewardPoints: "পুরস্কার (পয়েন্ট)", labelUsageLimit: "ব্যবহারের সীমা", btnCreateCode: "কোড তৈরি করুন",
                settingsAdvancedControl: "অ্যাডভান্সড নিয়ন্ত্রণ", labelAdWatchTimer: "বিজ্ঞাপন দেখার টাইমার (সেকেন্ড) - ডিফল্ট", labelHourlyAdsLimit: "ঘণ্টায় বিজ্ঞাপন দেখার সীমা", labelMinReferralsForWithdrawal: "টাকা তোলার জন্য সর্বনিম্ন রেফারেল", labelEnableMaintenance: "রক্ষণাবেক্ষণ মোড সক্ষম করুন",
                settingsFraudDetection: "অ্যাডভান্সড জালিয়াতি সনাক্তকরণ সেটিংস", labelIpSharingLimit: "আইপি শেয়ারিং সীমা", ipSharingLimitDesc: "একই IP ঠিকানা থেকে সর্বোচ্চ কতজন ব্যবহারকারীকে অনুমতি দেওয়া হবে। এর বেশি হলে তাদের সন্দেহজনক হিসেবে দেখানো হবে।",
                labelEnableVpnDetection: "VPN/Proxy শনাক্তকরণ চালু করুন", labelVpnAction: "শনাক্ত হলে করণীয়", vpnActionWarn: "ব্যবহারকারীকে সতর্ক করুন", vpnActionBlockEarning: "আয় করা থেকে বিরত রাখুন", vpnActionBlockAccount: "অ্যাকাউন্ট স্বয়ংক্রিয়ভাবে ব্লক করুন", vpnActionDesc: "VPN ব্যবহারকারী শনাক্ত হলে সিস্টেম কী পদক্ষেপ নেবে তা নির্ধারণ করুন।",
                settingsTargetedActions: "টার্গেটেড অ্যাকশন (ব্যবহারকারী বিভাজন)", labelSelectTargetSegment: "টার্গেট অংশ নির্বাচন করুন", segmentAllUsers: "সকল সক্রিয় ব্যবহারকারী", segmentUsersByTier: "স্তর অনুযায়ী ব্যবহারকারী", segmentInactiveUsers: "নিষ্ক্রিয় ব্যবহারকারী", labelSelectTier: "স্তর নির্বাচন করুন", labelInactiveForDays: "এর বেশি দিন নিষ্ক্রিয় (দিন)",
                labelSelectAction: "অ্যাকশন নির্বাচন করুন", actionSendNotification: "নোটিফিকেশন পাঠান", actionGiveBonus: "বোনাস পয়েন্ট দিন", labelBonusPoints: "বোনাস পয়েন্ট", labelReasonForBonus: "বোনাসের কারণ", btnExecuteAction: "অ্যাকশন চালান",
                settingsDailyCheckin: "দৈনিক চেক-ইন বোনাস", settingsTasks: "টাস্ক সম্পন্ন করুন", settingsUserTiers: "ব্যবহারকারীর স্তর (User Tiers)",
                settingsWithdrawalMonetization: "উত্তোলন এবং নগদীকরণ", labelMinWithdrawal: "সর্বনিম্ন উত্তোলনের সীমা", labelWithdrawalFee: "উত্তোলন ফি (%)",
                settingsLeaderboard: "লিডারবোর্ড ব্যবস্থাপনা", settingsPointStore: "পয়েন্ট স্টোর (Store)", settingsTextManagement: "অ্যাপের টেক্সট পরিবর্তন", settingsAdvancedTextManagement: "অ্যাডভান্সড টেক্সট ম্যানেজমেন্ট (UI লেবেল)", settingsErrorMessages: "ত্রুটির বার্তা নিয়ন্ত্রণ",
                btnUpdateAllSettings: "সমস্ত সেটিংস আপডেট করুন",
                modalManualTransaction: "ম্যানুয়াল লেনদেন", modalAddSubtractPoints: "পয়েন্ট যোগ/বিয়োগ করুন (যেমন, ১০০ বা -৫০)", modalReason: "কারণ (ব্যবহারকারীর ইতিহাসে দেখানো হবে)", btnSaveChanges: "পরিবর্তনগুলি সংরক্ষণ করুন এবং ইতিহাসে যুক্ত করুন",
                modalUserAdStats: "ব্যবহারকারীর বিজ্ঞাপন পরিসংখ্যান", btnResetDailyCount: "দৈনিক বিজ্ঞাপন গণনা রিসেট করুন", btnResetHourlyCount: "ঘণ্টার বিজ্ঞাপন গণনা রিসেট করুন",
                modalRefundTransaction: "একটি লেনদেন রিফান্ড করুন", modalRefundDesc: "ব্যবহারকারীর সাম্প্রতিক লেনদেনগুলো নিচে দেখানো হলো। যেকোনো লেনদেন রিফান্ড করতে বাটনে ক্লিক করুন।",
                modalAdminNotes: "অ্যাডমিন নোট (শুধুমাত্র অ্যাডমিনদের জন্য দৃশ্যমান)", btnSaveNote: "নোট সংরক্ষণ করুন",
                modalSendNotification: "নোটিফিকেশন পাঠান", modalMessageForUser: "এই ব্যবহারকারীর জন্য বার্তা", btnSendNotification: "নোটিফিকেশন পাঠান",
                modalSendReply: "উত্তর পাঠান", btnSendReply: "উত্তর পাঠান", modalScreenshot: "স্ক্রিনশট",
            }
        };
        
        const DEFAULT_CONFIG = {
            adsReward: 1.0, adsLimit: 100, refferBonus: 10,
            currency: 'BDT', minWithdraw: 500,
            appVersion: '1.0.0', announcement: '',
            appUpdateMessage: 'A new version is available. Please restart the bot to get the latest features.',
            botUsername: 'YourBotUsername', pointsPerCurrency: 100,
            adWatchTimerSeconds: 30, hourlyAdsLimit: 25,
            minReferralsForWithdrawal: 3, maintenanceMode: false,
            libtlZoneId: '9892740',
            dailyCheckinEnabled: true,
            dailyCheckinRewards: Array.from({ length: 10 }, (_, i) => ({ day: i + 1, reward: (i + 1) * 2 })),
            tasksEnabled: true,
            tasks: [ { id: Date.now() + 1, title: 'Join Telegram', link: 'https://t.me/your_channel', reward: 5, enabled: true, type: 'join_claim', iconUrl: '' } ],
            withdrawalMethodsEnabled: true,
            withdrawalMethods: [ { name: 'bKash', bn_name: 'বিকাশ', logo: 'bkash.png', enabled: true, min: 100, max: 5000 } ],
            userTiersEnabled: false,
            userTiers: [
                { name: 'Bronze', requiredPoints: 0, bonusPercent: 0, minWithdraw: 500, dailyWithdrawLimit: 1000 },
                { name: 'Silver', requiredPoints: 50000, bonusPercent: 2, minWithdraw: 400, dailyWithdrawLimit: 2000 },
                { name: 'Gold', requiredPoints: 200000, bonusPercent: 5, minWithdraw: 300, dailyWithdrawLimit: 5000 }
            ],
            welcomeBonus: 100, welcomeBonusEnabled: true,
            dynamicText: {
                welcomeMessageTemplate: 'Welcome, {name}!',
                shoppingButtonText: 'Start Shopping Now',
                shoppingButtonLink: 'https://the-arafat-collection-woad.vercel.app/'
            },
            theme: { primaryColor: '#6a11cb' },
            withdrawalFeePercent: 0,
            storeEnabled: false,
            pointPackages: [
                { price: 100, currency: 'BDT', points: 10000, enabled: true }
            ],
            leaderboard: {
                enabled: false,
                resetFrequency: 'daily',
                rewards: { top1: 500, top2: 250, top3: 100 }
            },
            textStrings: {
                navHome: "Home", navEarn: "Earn", navRefer: "Refer", navProfile: "Profile",
                referTitle: "Refer & Earn Forever", referLinkTitle: "Your Referral Link",
                errorMessages: {
                    insufficientBalance: "Insufficient balance.",
                    minWithdrawal: "Minimum withdrawal is {amount} {currency}.",
                    minReferrals: "Minimum {count} referrals required for withdrawal.",
                    fillAllFields: "Please fill all fields correctly."
                }
            },
            uiStrings: {
                balanceLabel: "Balance:",
                totalEarningsLabel: "Total Earnings",
                adsWatchedLabel: "Ads Watched (Total)",
                totalReferralsLabel: "Total Referrals",
                requestWithdrawalBtn: "Request Withdrawal",
                transactionHistoryBtn: "Transaction History"
            },
            fraudDetection: { 
                ipSharingLimit: 3,
                vpnDetection: {
                    enabled: false,
                    action: 'warn'
                }
            },
            firewall: {
                blocked: [],
                whitelisted: []
            },
            referralControl: { 
                maxReferrals: 0, 
                commissionActivation: { adsWatched: 10 },
                multiLevel: {
                    enabled: false,
                    level2_commission: 2,
                    level3_commission: 1
                }
            },
            assets: {
                adNetworkLogo: "https://i.ibb.co/Lh2SFvmH/Untitled-design-20250825-163934-0000.png",
                defaultAvatar: "https://i.pravatar.cc/150"
            },
            offerwall: {
                enabled: false,
                code: '<!-- Paste your Offerwall HTML/JS code here -->'
            },
            lottery: {
                enabled: false,
                ticketPrice: 100,
                prizeAmount: 5000
            },
            telegramScript: {
                enabled: true
            },
            firebaseConfig: { ...firebaseConfig },
            gamification: {
                enabled: false,
                xpPerAd: 1,
                xpPerReferral: 10,
                xpPerTask: 5,
                xpPerCheckin: 2,
                levelUpBonus: 100,
                levels: [
                    { level: 1, xp: 0 },
                    { level: 2, xp: 100 },
                    { level: 3, xp: 250 },
                    { level: 4, xp: 500 },
                    { level: 5, xp: 1000 }
                ]
            },
            adSystemConfig: {
                primaryAd: { enabled: true, reward: 10, timer: 30 },
                rewardedAd: { enabled: true, reward: 20, timer: 20, triggerOnTaskCompletion: true }
            },
            // Default config for new features
            spinWheel: { enabled: false, cost: 0, dailyLimit: 10, segments: [{ text: '10', value: 10 }, { text: 'Try Again', value: 0 }] },
            scratchCard: { enabled: false, cost: 0, dailyLimit: 10, prizes: [{ text: '20', value: 20, probability: 30 }, { text: 'No Luck', value: 0, probability: 70 }] },
            videoZone: { enabled: false, videos: [{ title: 'Sample Video', url: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ', duration: 30, reward: 15 }] },
            quizSystem: { enabled: false, rewardPerCorrect: 5, categories: [{ name: 'General Knowledge', questions: [{ q: 'What is the capital of Bangladesh?', options: ['Dhaka', 'Chittagong', 'Sylhet'], answer: 'Dhaka' }] }] },
            captchaEntry: { enabled: false, reward: 1, dailyLimit: 50 }
        };
        
        async function logAdminAction(action, details = {}) {
            try {
                await push(auditLogRef, {
                    action: action,
                    details: details,
                    timestamp: new Date().toISOString(),
                    adminId: 'Admin'
                });
            } catch (error) {
                console.error("Failed to write to audit log:", error);
            }
        }
        
        function setLanguage(lang) {
            localStorage.setItem('adminLang', lang);
            document.documentElement.lang = lang;
            
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                } else if (translations['en'] && translations['en'][key]) {
                    element.textContent = translations['en'][key];
                }
            });

            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            document.getElementById('lang-bn').classList.toggle('active', lang === 'bn');
            
            processAnalyticsData();
        }

        function initLanguage() {
            const savedLang = localStorage.getItem('adminLang') || 'bn';
            setLanguage(savedLang);

            document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
            document.getElementById('lang-bn').addEventListener('click', () => setLanguage('bn'));
        }

        function showToast(message, type = 'success', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const iconClass = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-times-circle' : 'fa-info-circle');
            toast.innerHTML = `<i class="fas ${iconClass}"></i> <p class="toast-message">${message}</p>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        container.removeChild(toast);
                    }
                }, 500);
            }, duration);
        }

        function init() {
            initLanguage();
            onValue(ref(database, 'app/config'), (snapshot) => {
                const data = snapshot.val();
                appConfig = data ? { ...DEFAULT_CONFIG, ...data } : { ...DEFAULT_CONFIG };

                if (JSON.stringify(appConfig.firebaseConfig) !== JSON.stringify(firebaseConfig)) {
                    console.warn("Firebase config has changed. Re-initializing...");
                    try {
                        app = initializeApp(appConfig.firebaseConfig, "admin-panel-reinit");
                        database = getDatabase(app);
                        initializeDbRefs();
                         showToast("Firebase config reloaded.", "info");
                    } catch (e) {
                        console.error("Failed to re-initialize with new Firebase config:", e);
                        showToast("Error: Invalid Firebase config provided.", "error");
                    }
                }
                
                if (!appConfig.textStrings.errorMessages) appConfig.textStrings.errorMessages = DEFAULT_CONFIG.textStrings.errorMessages;
                if (!appConfig.leaderboard) appConfig.leaderboard = DEFAULT_CONFIG.leaderboard;
                if (!appConfig.uiStrings) appConfig.uiStrings = DEFAULT_CONFIG.uiStrings;
                if (!appConfig.assets) appConfig.assets = DEFAULT_CONFIG.assets;
                if (!appConfig.fraudDetection) appConfig.fraudDetection = DEFAULT_CONFIG.fraudDetection;
                if (!appConfig.referralControl) appConfig.referralControl = DEFAULT_CONFIG.referralControl;
                if (!appConfig.referralControl.multiLevel) appConfig.referralControl.multiLevel = DEFAULT_CONFIG.referralControl.multiLevel;
                if (!appConfig.fraudDetection.vpnDetection) appConfig.fraudDetection.vpnDetection = DEFAULT_CONFIG.fraudDetection.vpnDetection;
                if (!appConfig.telegramScript) appConfig.telegramScript = DEFAULT_CONFIG.telegramScript;
                if (!appConfig.firebaseConfig) appConfig.firebaseConfig = DEFAULT_CONFIG.firebaseConfig;
                if (!appConfig.firewall) appConfig.firewall = DEFAULT_CONFIG.firewall;
                if (!appConfig.gamification) appConfig.gamification = DEFAULT_CONFIG.gamification;
                if (!appConfig.adSystemConfig) appConfig.adSystemConfig = DEFAULT_CONFIG.adSystemConfig; 

                if (!data) {
                    set(configRef, appConfig);
                }
                renderAllSettings();
                setupDynamicListeners();
                
                get(usersRef).then(snapshot => {
                    if (snapshot.exists()) {
                        totalUsersCount = snapshot.size;
                        allUsers = snapshot.val(); 
                        updateDashboardData(); 
                        processAnalyticsData(); 
                        renderDashboardAnalytics();
                        renderTopTasksAnalytics();
                    }
                    renderUsers(true);
                });


            }, { onlyOnce: true }); 

            menuToggle.addEventListener('click', toggleMenu);
            overlay.addEventListener('click', toggleMenu);
            navLinks.forEach(link => link.addEventListener('click', handleNavClick));
            
            document.getElementById('settingsSearch').addEventListener('keyup', filterSettings);
            document.querySelectorAll('#settings .section-header').forEach(header => {
                header.addEventListener('click', () => {
                    const body = header.nextElementSibling;
                    header.classList.toggle('collapsed');
                    body.classList.toggle('collapsed');
                });
            });

            document.getElementById('analytics-time-filter').addEventListener('change', processAnalyticsData);
            
            initCharts();
        }

        function setupDynamicListeners() {
            onValue(withdrawRequestsRef, (snapshot) => { 
                allWithdrawals = snapshot.val() || {}; 
                renderWithdrawals(); 
                updateDashboardData(); 
                
                const pendingCount = Object.values(allWithdrawals).filter(w => w.status === 'Pending').length;
                document.title = pendingCount > 0 ? `(${pendingCount}) ${originalDocTitle}` : originalDocTitle;
            });
            onValue(promoCodesRef, (snapshot) => { renderPromoCodes(snapshot.val() || {}); });
            onValue(supportTicketsRef, (snapshot) => { renderSupportTickets(snapshot.val() || {}); });
            onValue(taskSubmissionsRef, (snapshot) => { renderTaskSubmissions(snapshot.val() || {}); });
            onValue(lotteryRef, (snapshot) => { renderLotterySection(snapshot.val()); });
            onValue(auditLogRef, (snapshot) => { renderAuditLog(snapshot.val() || {}); });
            
            document.getElementById('withdraw-tab-nav').addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { document.querySelectorAll('#withdraw-tab-nav .tab-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); currentWithdrawFilter = e.target.dataset.status; renderWithdrawals(); } });
            document.getElementById('userSearch').addEventListener('input', () => { currentPage = 1; pageStartKeys = [null]; renderUsers(false); });
            document.getElementById('filter-status').addEventListener('change', () => { currentPage = 1; pageStartKeys = [null]; renderUsers(false); });
            document.getElementById('filter-balance').addEventListener('change', () => { currentPage = 1; pageStartKeys = [null]; renderUsers(false); });
            document.getElementById('filter-joined-date').addEventListener('change', () => { currentPage = 1; pageStartKeys = [null]; renderUsers(false); });
            document.getElementById('filter-inactive-days').addEventListener('input', () => { currentPage = 1; pageStartKeys = [null]; renderUsers(false); });
            
            document.getElementById('select-all-users').addEventListener('change', (e) => { document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = e.target.checked); });
            document.getElementById('save-user-changes-btn').addEventListener('click', saveUserChanges);
            document.getElementById('currency').addEventListener('input', (e) => { document.getElementById('currency-label').textContent = e.target.value || 'Currency'; });
            document.getElementById('send-global-notification-btn').addEventListener('click', sendGlobalNotification);
            document.getElementById('target-segment').addEventListener('change', handleSegmentChange);
            document.getElementById('action-type').addEventListener('change', handleActionChange);
        }
        
        function filterSettings() {
            const searchTerm = document.getElementById('settingsSearch').value.toLowerCase();
            const sections = document.querySelectorAll('#settings .section-card');
            sections.forEach(section => {
                const headerText = section.querySelector('.section-header').innerText.toLowerCase();
                if (headerText.includes(searchTerm)) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        function initCharts() {
            if (userGrowthChart) userGrowthChart.destroy();
            if (dailyEarningsChart) dailyEarningsChart.destroy();
            if (earningSourcesChart) earningSourcesChart.destroy();
            if (userRetentionChart) userRetentionChart.destroy();
            
            const currentLang = localStorage.getItem('adminLang') || 'bn';
            const userGrowthLabel = translations[currentLang]?.chartUserGrowth || translations.en.chartUserGrowth;
            const dailyEarningsLabel = translations[currentLang]?.chartDailyEarnings || translations.en.chartDailyEarnings;
            const activeUsersLabel = translations[currentLang]?.chartActiveUsers || translations.en.chartActiveUsers;

            const userCtx = document.getElementById('user-growth-chart').getContext('2d');
            userGrowthChart = new Chart(userCtx, { type: 'line', data: { labels: [], datasets: [{ label: userGrowthLabel, data: [], backgroundColor: 'rgba(52, 152, 219, 0.2)', borderColor: 'rgba(52, 152, 219, 1)', borderWidth: 2, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false } });
            
            const earningsCtx = document.getElementById('daily-earnings-chart').getContext('2d');
            dailyEarningsChart = new Chart(earningsCtx, { type: 'bar', data: { labels: [], datasets: [{ label: dailyEarningsLabel, data: [], backgroundColor: 'rgba(46, 204, 113, 0.7)', borderColor: 'rgba(46, 204, 113, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false } });
            
            const sourcesCtx = document.getElementById('earning-sources-chart').getContext('2d');
            earningSourcesChart = new Chart(sourcesCtx, { type: 'doughnut', data: { labels: ['Ads', 'Referrals', 'Tasks', 'Check-in', 'Bonus'], datasets: [{ data: [], backgroundColor: ['#3498db', '#9b59b6', '#f1c40f', '#2ecc71', '#e74c3c'] }] }, options: { responsive: true, maintainAspectRatio: false } });

            const retentionCtx = document.getElementById('user-retention-chart').getContext('2d');
            userRetentionChart = new Chart(retentionCtx, { type: 'line', data: { labels: [], datasets: [{ label: activeUsersLabel, data: [], backgroundColor: 'rgba(230, 126, 34, 0.2)', borderColor: '#e67e22', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false } });
        }
        
        window.downloadBackup = async () => {
            if (!confirm("Are you sure you want to download the entire database? This might be a large file.")) return;

            try {
                const snapshot = await get(dbRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    const date = new Date().toISOString().slice(0, 10);
                    a.download = `firebase-backup-${date}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                    
                    showToast("Backup downloaded successfully!", "success");
                    logAdminAction("Data Backup Downloaded");
                } else {
                    showToast("No data to back up.", "info");
                }
            } catch (error) {
                console.error("Error downloading backup:", error);
                showToast("Failed to download backup.", "error");
            }
        };

        function renderTopTasksAnalytics() {
            if (Object.keys(allUsers).length === 0 || !appConfig.tasks) {
                return;
            }

            const taskCounts = {};
            appConfig.tasks.forEach(task => {
                taskCounts[task.id] = { count: 0, title: task.title };
            });

            Object.values(allUsers).forEach(user => {
                if (user.tasksState) {
                    Object.keys(user.tasksState).forEach(taskId => {
                        if (user.tasksState[taskId].completed && taskCounts[taskId]) {
                            taskCounts[taskId].count++;
                        }
                    });
                }
            });

            const sortedTasks = Object.values(taskCounts)
                .filter(task => task.title)
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            const tbody = document.getElementById('top-tasks-body');
            if (sortedTasks.length === 0) {
                tbody.innerHTML = `<tr><td colspan="2">No task completion data available.</td></tr>`;
            } else {
                tbody.innerHTML = sortedTasks.map(task => `
                    <tr>
                        <td data-label="Task Title">${task.title}</td>
                        <td data-label="Completions">${task.count.toLocaleString()}</td>
                    </tr>
                `).join('');
            }
        }


        function processAnalyticsData() {
            if (Object.keys(allUsers).length === 0) return;

            const filterDays = document.getElementById('analytics-time-filter').value;
            let startDate = new Date(0); 
            if (filterDays !== 'all') {
                startDate = new Date();
                startDate.setDate(startDate.getDate() - parseInt(filterDays));
                startDate.setHours(0, 0, 0, 0);
            }

            const userGrowthData = {}, dailyEarningsData = {};
            const earningSources = { 'Ads': 0, 'Referrals': 0, 'Tasks': 0, 'Check-in': 0, 'Bonus': 0 };
            const dailyActiveUsers = {};
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toLocaleDateString('en-CA');
                dailyActiveUsers[dateString] = new Set();
            }

            Object.values(allUsers).forEach(user => {
                const joinDate = user.joinedAt ? new Date(user.joinedAt) : null;
                if (joinDate && joinDate >= startDate) {
                    const joinDateStr = joinDate.toLocaleDateString('en-CA');
                    userGrowthData[joinDateStr] = (userGrowthData[joinDateStr] || 0) + 1;
                }
                
                if (user.profile?.lastLogin?.timestamp) {
                    const lastLoginDateStr = new Date(user.profile.lastLogin.timestamp).toLocaleDateString('en-CA');
                    if (dailyActiveUsers[lastLoginDateStr]) {
                        dailyActiveUsers[lastLoginDateStr].add(user.profile.id);
                    }
                }
                
                if (user.transactionHistory) { 
                    Object.values(user.transactionHistory).forEach(tx => { 
                        const txDate = new Date(tx.date);
                        if (txDate >= startDate) {
                            if (tx.amount > 0) {
                                const txDateStr = txDate.toLocaleDateString('en-CA');
                                dailyEarningsData[txDateStr] = (dailyEarningsData[txDateStr] || 0) + tx.amount;
                                if (tx.type === 'earning') earningSources['Ads'] += tx.amount;
                                else if (tx.type === 'referral') earningSources['Referrals'] += tx.amount;
                                else if (tx.type === 'task') earningSources['Tasks'] += tx.amount;
                                else if (tx.type === 'login') earningSources['Check-in'] += tx.amount;
                                else if (tx.type === 'manual' || tx.type === 'promo') earningSources['Bonus'] += tx.amount;
                            }
                        }
                    }); 
                }
            });
            const sortedUserDates = Object.keys(userGrowthData).sort(), sortedEarningDates = Object.keys(dailyEarningsData).sort();
            
            const currentLang = localStorage.getItem('adminLang') || 'bn';
            userGrowthChart.data.datasets[0].label = translations[currentLang]?.chartUserGrowth || translations.en.chartUserGrowth;
            dailyEarningsChart.data.datasets[0].label = translations[currentLang]?.chartDailyEarnings || translations.en.chartDailyEarnings;
            userRetentionChart.data.datasets[0].label = translations[currentLang]?.chartActiveUsers || translations.en.chartActiveUsers;
            
            userGrowthChart.data.labels = sortedUserDates; userGrowthChart.data.datasets[0].data = sortedUserDates.map(date => userGrowthData[date]); userGrowthChart.update();
            dailyEarningsChart.data.labels = sortedEarningDates; dailyEarningsChart.data.datasets[0].data = sortedEarningDates.map(date => dailyEarningsData[date]); dailyEarningsChart.update();
            earningSourcesChart.data.datasets[0].data = [earningSources['Ads'], earningSources['Referrals'], earningSources['Tasks'], earningSources['Check-in'], earningSources['Bonus']]; earningSourcesChart.update();
            const retentionLabels = Object.keys(dailyActiveUsers);
            const retentionData = retentionLabels.map(date => dailyActiveUsers[date].size);
            userRetentionChart.data.labels = retentionLabels.map(d => new Date(d).toLocaleDateString('en-GB', {day: '2-digit', month: 'short'}));
            userRetentionChart.data.datasets[0].data = retentionData; userRetentionChart.update();
        }

        function renderDashboardAnalytics() {
            const usersArray = Object.entries(allUsers);
            
            const topEarners = usersArray.sort(([, a], [, b]) => (b.totalEarnings || 0) - (a.totalEarnings || 0)).slice(0, 5);
            const topEarnersBody = document.getElementById('top-earners-body');
            topEarnersBody.innerHTML = topEarners.map(([id, user]) => `
                <tr>
                    <td data-label="User">${user.profile?.firstName || id}</td>
                    <td data-label="Earnings">${(user.totalEarnings || 0).toLocaleString()}</td>
                </tr>
            `).join('');

            const topReferrers = usersArray.sort(([, a], [, b]) => (Object.keys(b.referralsList || {}).length) - (Object.keys(a.referralsList || {}).length)).slice(0, 5);
            const topReferrersBody = document.getElementById('top-referrers-body');
            topReferrersBody.innerHTML = topReferrers.map(([id, user]) => `
                <tr>
                    <td data-label="User">${user.profile?.firstName || id}</td>
                    <td data-label="Referrals">${Object.keys(user.referralsList || {}).length}</td>
                </tr>
            `).join('');
        }

        async function sendGlobalNotification() {
            const message = document.getElementById('global-notification-message').value.trim();
            if (message && confirm("আপনি কি নিশ্চিত যে এই বার্তাটি সকল ব্যবহারকারীর কাছে পাঠাতে চান?")) {
                try { 
                    await set(globalNotificationRef, { message: message, timestamp: new Date().toISOString() }); 
                    showToast("Global notification sent successfully!");
                    document.getElementById('global-notification-message').value = '';
                    logAdminAction("Sent Global Notification", { message: message });
                } catch (error) { 
                    console.error("Error sending global notification:", error); 
                    showToast("Failed to send notification.", "error"); 
                }
            }
        }
        
        async function saveConfigToFirebase() { 
            try { 
                await set(configRef, appConfig); 
                return true;
            } catch (error) { 
                console.error("Error saving settings to Firebase: ", JSON.stringify(error, null, 2)); 
                showToast(`Failed to update settings. Code: ${error.code}`, 'error'); 
                return false;
            } 
        }
        
        function renderAuditLog(logs) {
            const tbody = document.getElementById('audit-log-body');
            const sortedLogs = Object.values(logs).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (sortedLogs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4">No admin activities have been logged yet.</td></tr>`;
                return;
            }

            tbody.innerHTML = sortedLogs.map(log => {
                return `
                    <tr>
                        <td data-label="Timestamp">${new Date(log.timestamp).toLocaleString()}</td>
                        <td data-label="Admin">${log.adminId}</td>
                        <td data-label="Action">${log.action}</td>
                        <td data-label="Details">${JSON.stringify(log.details)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function renderUsers(reset = false) {
            if (reset) {
                document.getElementById('userSearch').value = '';
                document.getElementById('filter-status').value = '';
                document.getElementById('filter-balance').value = '';
                document.getElementById('filter-joined-date').value = '';
                document.getElementById('filter-inactive-days').value = '';
                currentPage = 1;
                pageStartKeys = [null];
            }
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Loading users...</td></tr>`;

            const startKey = pageStartKeys[currentPage - 1];
            let usersQuery;
            if (startKey) {
                usersQuery = query(usersRef, orderByKey(), startAt(startKey), limitToFirst(usersPerPage));
            } else {
                usersQuery = query(usersRef, orderByKey(), limitToFirst(usersPerPage));
            }

            const snapshot = await get(usersQuery);
            if (!snapshot.exists()) {
                tbody.innerHTML = `<tr><td colspan="6">No users found.</td></tr>`;
                renderPaginationControls(0, 1);
                return;
            }

            let usersData = [];
            let lastKey = null;
            snapshot.forEach(childSnapshot => {
                usersData.push([childSnapshot.key, childSnapshot.val()]);
                lastKey = childSnapshot.key;
            });

            if (usersData.length > 0 && pageStartKeys.length === currentPage) {
                pageStartKeys.push(lastKey);
            }
            
            const searchVal = document.getElementById('userSearch').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const balanceFilter = document.getElementById('filter-balance').value;
            const joinedDateFilter = document.getElementById('filter-joined-date').value;
            const inactiveDaysFilter = parseInt(document.getElementById('filter-inactive-days').value) || 0;

            let displayedUsers = usersData.filter(([id, user]) => {
                if (!user.profile) return false;
                const name = `${user.profile.firstName || ''} ${user.profile.lastName || ''}`.toLowerCase();
                const username = user.profile.username?.toLowerCase() || '';
                const userId = id.toLowerCase();
                
                const searchMatch = !searchVal || name.includes(searchVal) || username.includes(searchVal) || userId.includes(searchVal);
                const statusMatch = !statusFilter || (statusFilter === 'blocked' && user.isBlocked) || (statusFilter === 'active' && !user.isBlocked);
                const joinedDateMatch = !joinedDateFilter || (user.joinedAt && new Date(user.joinedAt) >= new Date(joinedDateFilter));

                let inactiveMatch = true;
                if (inactiveDaysFilter > 0) {
                    const lastLogin = user.profile.lastLogin?.timestamp;
                    const threshold = Date.now() - (inactiveDaysFilter * 24 * 60 * 60 * 1000);
                    inactiveMatch = !lastLogin || new Date(lastLogin).getTime() < threshold;
                }

                return searchMatch && statusMatch && joinedDateMatch && inactiveMatch;
            });
            
            if (balanceFilter === 'high') {
                displayedUsers.sort(([, a], [, b]) => (b.balance || 0) - (a.balance || 0));
            } else if (balanceFilter === 'low') {
                displayedUsers.sort(([, a], [, b]) => (a.balance || 0) - (b.balance || 0));
            }
            
            tbody.innerHTML = displayedUsers.map(([id, user]) => {
                return `<tr>
                    <td data-label="Select"><input type="checkbox" class="user-checkbox" data-id="${id}"></td>
                    <td data-label="User ID">${id}</td>
                    <td data-label="Name">${(user.profile?.firstName || 'N/A')} ${(user.profile?.lastName || '')}</td>
                    <td data-label="Balance">${(user.balance || 0).toLocaleString()}</td>
                    <td data-label="Status"><span class="status-badge ${user.isBlocked ? 'status-blocked' : 'status-approved'}">${user.isBlocked ? 'Blocked' : 'Active'}</span></td>
                    <td data-label="Actions">
                        <button class="action-btn btn-view" onclick="window.openUserEditModal('${id}')">Edit</button>
                        <button class="action-btn btn-history" onclick="window.openUserHistoryModal('${id}')">History</button>
                        <button class="action-btn btn-info" onclick="window.openUserReferralsModal('${id}')">Referrals</button>
                        <button class="action-btn ${user.isBlocked ? 'btn-unblock' : 'btn-block'}" onclick="window.toggleUserBlock('${id}', ${user.isBlocked || false})">${user.isBlocked ? 'Unblock' : 'Block'}</button>
                    </td>
                </tr>`;
            }).join('');
            
            if(displayedUsers.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="6">No users match the current filter.</td></tr>`;
            }

            renderPaginationControls(totalUsersCount, currentPage, snapshot.size < usersPerPage);
        }

        function renderPaginationControls(totalUsers, page, isLastPage) {
            const container = document.getElementById('pagination-container');
            const totalPages = Math.ceil(totalUsers / usersPerPage);
            if (totalUsers === 0) {
                container.innerHTML = '';
                return;
            }

            let html = `
                <button onclick="window.changePage(1)" ${page === 1 ? 'disabled' : ''}>&laquo;</button>
                <button onclick="window.changePage(${page - 1})" ${page === 1 ? 'disabled' : ''}>&lsaquo;</button>
                <span>Page ${page} ${totalPages > 1 ? `/ ~${totalPages}` : ''}</span>
                <button onclick="window.changePage(${page + 1})" ${isLastPage ? 'disabled' : ''}>&rsaquo;</button>
            `;
            container.innerHTML = html;
        }

        window.changePage = function(newPage) {
            if (newPage < 1) return;
            currentPage = newPage;
            renderUsers(false);
        }

        function renderAllSettings() {
            if (!appConfig || Object.keys(appConfig).length === 0) return;

            document.getElementById('telegramScriptEnabled').checked = appConfig.telegramScript?.enabled ?? true;
            document.getElementById('libtlZoneId').value = appConfig.libtlZoneId || '';
            const fbConfig = appConfig.firebaseConfig || {};
            document.getElementById('fb-apiKey').value = fbConfig.apiKey || '';
            document.getElementById('fb-authDomain').value = fbConfig.authDomain || '';
            document.getElementById('fb-databaseURL').value = fbConfig.databaseURL || '';
            document.getElementById('fb-projectId').value = fbConfig.projectId || '';
            document.getElementById('fb-storageBucket').value = fbConfig.storageBucket || '';
            document.getElementById('fb-messagingSenderId').value = fbConfig.messagingSenderId || '';
            document.getElementById('fb-appId').value = fbConfig.appId || '';
            document.getElementById('fb-measurementId').value = fbConfig.measurementId || '';
            
            if (appConfig.assets) {
                document.getElementById('asset-ad-logo').value = appConfig.assets.adNetworkLogo || '';
                document.getElementById('asset-default-avatar').value = appConfig.assets.defaultAvatar || '';
            }

            document.getElementById('appVersion').value = appConfig.appVersion || '1.0.0';
            document.getElementById('appUpdateMessage').value = appConfig.appUpdateMessage || DEFAULT_CONFIG.appUpdateMessage;
            document.getElementById('announcement').value = appConfig.announcement || '';
            document.getElementById('adsReward').value = appConfig.adsReward; document.getElementById('adsLimit').value = appConfig.adsLimit;
            document.getElementById('refferBonus').value = appConfig.refferBonus;
            document.getElementById('currency').value = appConfig.currency; document.getElementById('minWithdraw').value = appConfig.minWithdraw;
            document.getElementById('adWatchTimerSeconds').value = appConfig.adWatchTimerSeconds; document.getElementById('hourlyAdsLimit').value = appConfig.hourlyAdsLimit;
            document.getElementById('minReferralsForWithdrawal').value = appConfig.minReferralsForWithdrawal;
            document.getElementById('maintenanceMode').checked = appConfig.maintenanceMode;
            document.getElementById('botUsername').value = appConfig.botUsername || ''; document.getElementById('pointsPerCurrency').value = appConfig.pointsPerCurrency || 100;
            document.getElementById('currency-label').textContent = appConfig.currency || 'Currency';
            document.getElementById('welcomeBonusEnabled').checked = appConfig.welcomeBonusEnabled; document.getElementById('welcomeBonus').value = appConfig.welcomeBonus;
            if (appConfig.dynamicText) { document.getElementById('dynamicWelcomeMessage').value = appConfig.dynamicText.welcomeMessageTemplate; document.getElementById('dynamicShoppingButtonText').value = appConfig.dynamicText.shoppingButtonText; document.getElementById('dynamicShoppingButtonLink').value = appConfig.dynamicText.shoppingButtonLink; }
            const tierSelect = document.getElementById('target-tier'); tierSelect.innerHTML = (appConfig.userTiers || []).map(tier => `<option value="${tier.name}">${tier.name} (${tier.requiredPoints}+ Points)</option>`).join('');
            
            document.getElementById('themeColor').value = appConfig.theme?.primaryColor || '#6a11cb';
            document.getElementById('withdrawalFeePercent').value = appConfig.withdrawalFeePercent || 0;

            if(appConfig.fraudDetection) {
                document.getElementById('ipSharingLimit').value = appConfig.fraudDetection.ipSharingLimit || 3;
                const vpnConfig = appConfig.fraudDetection.vpnDetection || {};
                document.getElementById('vpnDetectionEnabled').checked = vpnConfig.enabled || false;
                document.getElementById('vpn-detection-action').value = vpnConfig.action || 'warn';
                const vpnOptionsContainer = document.getElementById('vpn-detection-options');
                vpnOptionsContainer.style.display = vpnConfig.enabled ? 'block' : 'none';
                document.getElementById('vpnDetectionEnabled').addEventListener('change', (e) => {
                    vpnOptionsContainer.style.display = e.target.checked ? 'block' : 'none';
                });
            }
            if(appConfig.referralControl) {
                document.getElementById('maxReferrals').value = appConfig.referralControl.maxReferrals || 0;
                document.getElementById('referralCommissionActivation').value = appConfig.referralControl.commissionActivation?.adsWatched || 10;
                const multiLevelConfig = appConfig.referralControl.multiLevel || {};
                document.getElementById('multiLevelReferralEnabled').checked = multiLevelConfig.enabled || false;
                document.getElementById('referral-level2-commission').value = multiLevelConfig.level2_commission || 2;
                document.getElementById('referral-level3-commission').value = multiLevelConfig.level3_commission || 1;
                const multiLevelInputs = document.getElementById('multi-level-referral-inputs');
                multiLevelInputs.style.display = multiLevelConfig.enabled ? 'block' : 'none';
                document.getElementById('multiLevelReferralEnabled').addEventListener('change', (e) => {
                    multiLevelInputs.style.display = e.target.checked ? 'block' : 'none';
                });
            }

            renderAdSystemSettings();
            renderDailyCheckinSection(); renderTasksSection();
            renderUserTiersSection(); renderWithdrawalMethodsSection();
            renderPointPackagesSection(); renderTextManagementSection();
            renderErrorMessageSection();
            renderLeaderboardSection();
            renderAdvancedTextManagementSection();
            renderOfferwallSection();
            renderIpManagementSection();
            renderGamificationSettings();
            // #### START: RENDER NEW FEATURES ####
            renderSpinWheelSection();
            renderScratchCardSection();
            renderVideoZoneSection();
            renderQuizSystemSection();
            renderCaptchaEntrySection();
            // #### END: RENDER NEW FEATURES ####
        }

        function renderAdSystemSettings() {
            const config = appConfig.adSystemConfig || {
                primaryAd: { enabled: true, reward: 10, timer: 30 },
                rewardedAd: { enabled: true, reward: 20, timer: 20, triggerOnTaskCompletion: true }
            };

            document.getElementById('primaryAdEnabled').checked = config.primaryAd.enabled;
            document.getElementById('primaryAdReward').value = config.primaryAd.reward;
            document.getElementById('primaryAdTimer').value = config.primaryAd.timer;

            document.getElementById('rewardedAdEnabled').checked = config.rewardedAd.enabled;
            document.getElementById('rewardedAdReward').value = config.rewardedAd.reward;
            document.getElementById('rewardedAdTimer').value = config.rewardedAd.timer;
            document.getElementById('rewardedAdTriggerOnTask').checked = config.rewardedAd.triggerOnTaskCompletion;

            const rewardedAdOptions = document.getElementById('rewarded-ad-options-container');
            rewardedAdOptions.style.display = config.rewardedAd.enabled ? 'block' : 'none';
            document.getElementById('rewardedAdEnabled').addEventListener('change', (e) => {
                rewardedAdOptions.style.display = e.target.checked ? 'block' : 'none';
            });
        }
        
        window.saveAdSystemSettings = () => createSaveFunction('Ad System', () => {
            if (!appConfig.adSystemConfig) appConfig.adSystemConfig = {};
            appConfig.adSystemConfig = {
                primaryAd: {
                    enabled: document.getElementById('primaryAdEnabled').checked,
                    reward: parseInt(document.getElementById('primaryAdReward').value) || 0,
                    timer: parseInt(document.getElementById('primaryAdTimer').value) || 0
                },
                rewardedAd: {
                    enabled: document.getElementById('rewardedAdEnabled').checked,
                    reward: parseInt(document.getElementById('rewardedAdReward').value) || 0,
                    timer: parseInt(document.getElementById('rewardedAdTimer').value) || 0,
                    triggerOnTaskCompletion: document.getElementById('rewardedAdTriggerOnTask').checked
                }
            };
        });

        function renderWithdrawals() {
            const tbody = document.getElementById('withdraw-table-body');
            const filteredWithdrawals = Object.entries(allWithdrawals).filter(([id, data]) => data.status === currentWithdrawFilter).sort(([, a], [, b]) => new Date(b.date) - new Date(a.date));
            tbody.innerHTML = filteredWithdrawals.length === 0 ? `<tr><td colspan="7">No ${currentWithdrawFilter} requests found.</td></tr>` : 
            filteredWithdrawals.map(([id, req]) => {
                let noteHtml = '';
                if (req.adminNote) {
                    noteHtml = `<span class="tooltip-icon" title="${req.adminNote}"><i class="fas fa-info-circle"></i></span>`;
                }
                return `<tr>
                    <td data-label="User ID">${req.userId || 'N/A'}</td>
                    <td data-label="Date">${new Date(req.date).toLocaleString()}</td>
                    <td data-label="Method">${req.method}</td>
                    <td data-label="Account">${req.number}</td>
                    <td data-label="Amount">${req.amount} ${appConfig.currency || ''}</td>
                    <td data-label="Status"><span class="status-badge status-${req.status.toLowerCase()}">${req.status}</span> ${noteHtml}</td>
                    <td data-label="Actions">${req.status === 'Pending' ? `<button class="action-btn btn-approve" onclick="window.manageWithdrawal('${id}', 'Approved')">Approve</button><button class="action-btn btn-reject" onclick="window.manageWithdrawal('${id}', 'Rejected')">Reject</button>` : (req.transactionId ? `TxID: ${req.transactionId}` : '-')}</td>
                </tr>`;
            }).join('');
        }
        
        window.manageWithdrawal = async (requestId, newStatus) => {
            if (!confirm(`Are you sure you want to ${newStatus.toLowerCase()} this request?`)) return;
            const adminNote = prompt("Add an optional note for this action:", "");
            
            try {
                const requestRef = ref(database, `app/withdraw_requests/${requestId}`);
                const updates = { status: newStatus, adminNote: adminNote || null };

                if (newStatus === 'Approved') {
                    const txId = prompt("Enter Transaction ID (optional):", "");
                    updates.transactionId = txId || 'N/A';
                }
                await update(requestRef, updates);

                if(newStatus === 'Rejected'){
                    const requestSnapshot = await get(requestRef); const requestData = requestSnapshot.val(); const userRef = ref(database, `app/users/${requestData.userId}`); const userSnapshot = await get(userRef);
                    if(userSnapshot.exists()){ const userData = userSnapshot.val(); const pointsToRefund = requestData.requestedAmount * (appConfig.pointsPerCurrency || 100); await update(userRef, { balance: (userData.balance || 0) + pointsToRefund }); 
                    showToast(`Request rejected and ${pointsToRefund} points have been refunded.`); 
                    const rejectionMessage = `Your withdrawal request of ${requestData.requestedAmount} ${appConfig.currency} was rejected. The points have been returned to your balance. Admin note: ${adminNote || 'N/A'}`;
                    await set(push(ref(database, `app/users/${requestData.userId}/notifications`)), { message: rejectionMessage, date: new Date().toISOString(), read: false });
                    }
                } else { 
                    showToast(`Request has been successfully ${newStatus.toLowerCase()}.`); 
                }
                logAdminAction(`Withdrawal ${newStatus}`, { requestId: requestId, note: adminNote });
            } catch (error) { console.error("Error updating withdrawal status:", error); showToast("Failed to update status.", "error"); }
        };
        
        window.resetUserStats = async (type) => {
            if (!currentEditingUserId) return;
            const confirmation = confirm(`Are you sure you want to reset the ${type} ad count for this user?`);
            if (!confirmation) return;

            const userRef = ref(database, `app/users/${currentEditingUserId}`);
            const updates = {};
            if (type === 'daily') {
                updates['adTracking/dailyCount'] = 0;
            } else if (type === 'hourly') {
                updates['adTracking/hourlyCount'] = 0;
                updates['adTracking/lastHourlyReset'] = null;
            }

            try {
                await update(userRef, updates);
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} ad count has been reset successfully.`);
                logAdminAction(`Reset ${type} ad count`, { userId: currentEditingUserId });
            } catch (error) {
                console.error(`Error resetting ${type} count:`, error);
                showToast(`Failed to reset ${type} count.`, 'error');
            }
        };

        window.openUserEditModal = async (userId) => {
            const userRef = ref(database, `app/users/${userId}`);
            const snapshot = await get(userRef);
            const user = snapshot.val();

            if (!user) return; 
            currentEditingUserId = userId; 
            const modal = document.getElementById('user-edit-modal'); 
            document.getElementById('modal-user-name').textContent = `Edit User: ${user.profile?.firstName || userId}`;
            const lastLogin = user.profile?.lastLogin; const lastLoginTime = lastLogin?.timestamp ? new Date(lastLogin.timestamp).toLocaleString() : 'N/A'; const lastLoginIP = lastLogin?.ip || 'N/A';
            let userDetailsHTML = `<p><strong>User ID:</strong> ${userId}</p><p><strong>Name:</strong> ${user.profile?.firstName || ''} ${user.profile?.lastName || ''}</p><p><strong>Username:</strong> @${user.profile?.username || 'N/A'}</p><p><strong>Current Balance:</strong> ${(user.balance || 0).toLocaleString()} points</p><hr><p><strong>Last Login Time:</strong> ${lastLoginTime}</p><p><strong>Last Login IP:</strong> ${lastLoginIP}</p>`;
            if (user.isBlocked && user.blockReason) {
                userDetailsHTML += `<p><strong>Block Reason:</strong> ${user.blockReason}</p>`;
            }
            document.getElementById('user-details-content').innerHTML = userDetailsHTML;
            document.getElementById('points-to-add').value = ''; document.getElementById('transaction-reason').value = ''; document.getElementById('user-notification-message').value = '';
            document.getElementById('admin-notes-textarea').value = user.adminNotes || '';
            
            const transactionContainer = document.getElementById('modal-transaction-list-container');
            const history = user.transactionHistory || {};
            const historyItems = Object.entries(history).sort(([, a], [, b]) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            if(historyItems.length === 0) {
                 transactionContainer.innerHTML = '<p>No recent transactions to refund.</p>';
            } else {
                transactionContainer.innerHTML = historyItems.map(([key, item]) => {
                    const isRefundable = item.type !== 'withdrawal' && item.type !== 'refund';
                    const amountClass = item.amount >= 0 ? 'positive' : 'negative';
                    return `
                    <div class="modal-transaction-item">
                        <div class="modal-transaction-info">
                            <div class="title">${item.title}</div>
                            <div class="date">${new Date(item.date).toLocaleString()}</div>
                        </div>
                        <div class="amount-action">
                            <span class="amount ${amountClass}">${item.amount.toLocaleString()} Pts</span>
                            ${isRefundable ? `<button class="action-btn btn-refund" onclick="window.refundTransaction('${userId}', '${key}')">Refund</button>` : ''}
                        </div>
                    </div>`;
                }).join('');
            }
            
            modal.classList.add('active');
        };
        window.closeUserEditModal = () => document.getElementById('user-edit-modal').classList.remove('active');

        window.refundTransaction = async (userId, transactionId) => {
            if (!confirm("Are you sure you want to refund this transaction? The points will be reversed from the user's balance.")) return;
            const userRef = ref(database, `app/users/${userId}`);
            const userSnapshot = await get(userRef);
            const user = userSnapshot.val();
            const transaction = user?.transactionHistory?.[transactionId];

            if (!user || !transaction) {
                return showToast("Transaction not found.", "error");
            }
            
            const pointsToReverse = transaction.amount;
            const reason = `Refund for: ${transaction.title}`;

            try {
                if (userSnapshot.exists()) {
                    const currentBalance = user.balance || 0;
                    const newBalance = currentBalance - pointsToReverse;

                    const newHistoryRef = push(ref(database, `app/users/${userId}/transactionHistory`));
                    const updates = {
                        balance: newBalance,
                        [`transactionHistory/${newHistoryRef.key}`]: {
                            type: 'refund',
                            amount: -pointsToReverse,
                            title: reason,
                            date: new Date().toISOString(),
                            refundedTxId: transactionId
                        }
                    };

                    await update(userRef, updates);
                    showToast(`Transaction refunded. ${pointsToReverse} points deducted.`);
                    logAdminAction("Refunded Transaction", { userId: userId, amount: pointsToReverse, transactionId: transactionId });
                    closeUserEditModal();
                }
            } catch (error) {
                console.error("Error refunding transaction:", error);
                showToast("Failed to refund transaction.", "error");
            }
        };

        window.openUserHistoryModal = async (userId) => {
            const userRef = ref(database, `app/users/${userId}`);
            const snapshot = await get(userRef);
            const user = snapshot.val();
            if (!user) return; 
            const modal = document.getElementById('user-history-modal'); document.getElementById('modal-history-user-name').textContent = `History for ${user.profile?.firstName || userId}`; const contentDiv = document.getElementById('user-history-content');
            const history = user.transactionHistory; if (!history || Object.keys(history).length === 0) { contentDiv.innerHTML = '<p>No history found.</p>'; } else {
                const historyItems = Object.entries(history).sort(([, a], [, b]) => new Date(b.date) - new Date(a.date));
                contentDiv.innerHTML = `<ul class="history-list">${historyItems.map(([key, item]) => {
                    const date = new Date(item.date).toLocaleString(); let iconClass, amountClass, amountPrefix, amountDisplay;
                    switch(item.type) { case 'earning': iconClass = 'fa-solid fa-play'; amountClass = 'positive'; amountPrefix = '+'; amountDisplay = `${item.amount.toLocaleString()} Points`; break; case 'withdrawal': iconClass = 'fa-solid fa-arrow-down'; amountClass = 'negative'; amountPrefix = '-'; amountDisplay = `${item.amount} ${appConfig.currency}`; break; case 'referral': iconClass = 'fa-solid fa-users'; amountClass = 'positive'; amountPrefix = '+'; amountDisplay = `${item.amount.toLocaleString()} Points`; break; case 'login': iconClass = 'fa-solid fa-calendar-check'; amountClass = 'positive'; amountPrefix = '+'; amountDisplay = `${item.amount.toLocaleString()} Points`; break; case 'task': iconClass = 'fa-solid fa-tasks'; amountClass = 'positive'; amountPrefix = '+'; amountDisplay = `${item.amount.toLocaleString()} Points`; break; case 'manual': iconClass = 'fa-solid fa-user-pen'; amountClass = item.amount >= 0 ? 'positive' : 'negative'; amountPrefix = item.amount >= 0 ? '+' : ''; amountDisplay = `${item.amount.toLocaleString()} Points`; break; case 'refund': iconClass = 'fa-solid fa-undo'; amountClass = 'negative'; amountPrefix = ''; amountDisplay = `${item.amount.toLocaleString()} Points`; break; default: iconClass = 'fa-solid fa-question'; amountClass = ''; amountPrefix = ''; amountDisplay = `${item.amount}`; break; }
                    return `<li class="history-item"><div class="icon ${item.type}"><i class="${iconClass}"></i></div><div class="info"><div class="title">${item.title || item.type.charAt(0).toUpperCase() + item.type.slice(1)}</div><div class="date">${date}</div></div><div class="amount ${amountClass}">${amountPrefix}${amountDisplay}</div></li>`;
                }).join('')}</ul>`;
            } modal.classList.add('active');
        };
        window.closeUserHistoryModal = () => document.getElementById('user-history-modal').classList.remove('active');

        window.openUserReferralsModal = async (userId) => {
            const userRef = ref(database, `app/users/${userId}`);
            const snapshot = await get(userRef);
            const user = snapshot.val();
            if (!user) return;
            const modal = document.getElementById('user-referrals-modal');
            document.getElementById('modal-referrals-user-name').textContent = `Referrals of ${user.profile?.firstName || userId}`;
            const contentDiv = document.getElementById('user-referrals-content');
            const referralsList = user.referralsList || {};
            if (Object.keys(referralsList).length === 0) {
                contentDiv.innerHTML = '<p>This user has not referred anyone yet.</p>';
            } else {
                const referralPromises = Object.values(referralsList).map(ref => get(ref(database, `app/users/${ref.userId}`)));
                const referredSnapshots = await Promise.all(referralPromises);
                
                const referralItemsHTML = referredSnapshots.map(snap => {
                     if (!snap.exists()) return '';
                     const referredUser = snap.val();
                     const name = referredUser ? `${referredUser.profile?.firstName || ''} ${referredUser.profile?.lastName || ''}`.trim() : `User ID: ${referredUser.profile?.id || 'Unknown'}`;
                     const joinDate = referredUser ? new Date(referredUser.joinedAt).toLocaleDateString() : 'N/A';
                     return `<li class="history-item"><div class="info"><div class="title">${name}</div><div class="date">Joined on: ${joinDate}</div></div></li>`;
                }).join('');
                contentDiv.innerHTML = `<ul class="history-list">${referralItemsHTML}</ul>`;
            }
            modal.classList.add('active');
        };
        window.closeUserReferralsModal = () => document.getElementById('user-referrals-modal').classList.remove('active');

        async function saveUserChanges() {
            if (!currentEditingUserId) return; const pointsStr = document.getElementById('points-to-add').value; const pointsToAdd = parseInt(pointsStr, 10);
            if (isNaN(pointsToAdd) || pointsToAdd === 0) return showToast("Please enter a valid, non-zero number.", "error");
            const reason = document.getElementById('transaction-reason').value.trim() || 'Admin Adjustment';
            try {
                const userRef = ref(database, `app/users/${currentEditingUserId}`); const userSnapshot = await get(userRef);
                if (userSnapshot.exists()) {
                    const currentBalance = userSnapshot.val().balance || 0; const newBalance = currentBalance + pointsToAdd;
                    const updates = { balance: newBalance }; const newHistoryRef = push(ref(database, `app/users/${currentEditingUserId}/transactionHistory`));
                    updates[`transactionHistory/${newHistoryRef.key}`] = { type: 'manual', amount: pointsToAdd, title: reason, date: new Date().toISOString() };
                    await update(userRef, updates); 
                    showToast(`User balance updated to ${newBalance} points.`);
                    logAdminAction("Manual Transaction", { userId: currentEditingUserId, amount: pointsToAdd, reason: reason });
                    closeUserEditModal();
                }
            } catch (error) { console.error("Error updating user balance:", error); showToast("Failed to update balance.", "error"); }
        }

        window.saveAdminNote = async () => {
            if (!currentEditingUserId) return;
            const note = document.getElementById('admin-notes-textarea').value.trim();
            try {
                await update(ref(database, `app/users/${currentEditingUserId}`), { adminNotes: note });
                showToast("Admin note saved successfully!");
                logAdminAction("Saved Admin Note", { userId: currentEditingUserId });
            } catch (error) {
                console.error("Error saving admin note:", error);
                showToast("Failed to save admin note.", "error");
            }
        };

        window.sendUserNotification = async () => {
            if (!currentEditingUserId) return; const message = document.getElementById('user-notification-message').value.trim(); if (!message) return showToast("Message cannot be empty.", "error");
            try { const notificationsRef = ref(database, `app/users/${currentEditingUserId}/notifications`); const newNotificationRef = push(notificationsRef); await set(newNotificationRef, { message: message, date: new Date().toISOString(), read: false }); showToast("Notification sent!"); document.getElementById('user-notification-message').value = ''; logAdminAction("Sent User Notification", { userId: currentEditingUserId, message: message }); } catch(error) { console.error("Error sending notification:", error); showToast("Failed to send notification.", "error"); }
        };

        window.toggleUserBlock = async (userId, isCurrentlyBlocked) => {
            const action = isCurrentlyBlocked ? 'unblock' : 'block';
            if (!confirm(`Are you sure you want to ${action} this user?`)) return;

            let updates = { isBlocked: !isCurrentlyBlocked };
            let reason = null;
            if (!isCurrentlyBlocked) { 
                reason = prompt("Enter reason for blocking this user (optional):", "");
                updates.blockReason = reason || null;
            } else { 
                updates.blockReason = null; 
            }

            try {
                await update(ref(database, `app/users/${userId}`), updates);
                showToast(`User has been successfully ${action}ed.`);
                logAdminAction(`User ${action}ed`, { userId: userId, reason: reason });
                renderUsers(false);
            } catch (error) {
                console.error(`Error ${action}ing user:`, error);
                showToast(`Failed to ${action} user.`, "error");
            }
        };
        
        window.moveItem = (listKey, index, direction) => {
            const list = appConfig[listKey];
            if (!list) return;

            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= list.length) return;

            [list[index], list[newIndex]] = [list[newIndex], list[index]];
            
            switch (listKey) {
                case 'tasks': renderTasksSection(); break;
                case 'userTiers': renderUserTiersSection(); break;
                case 'withdrawalMethods': renderWithdrawalMethodsSection(); break;
                case 'gamification.levels': renderGamificationSettings(); break;
            }
        };

        function renderSection(containerId, list, config) {
            const container = document.getElementById(containerId); const listHtml = (list || []).map(config.itemRenderer).join('');
            container.innerHTML = `<div class="section-toggle"><label data-lang-key="${config.langKeyEnable}">${config.toggleLabel}</label><label class="switch"><input type="checkbox" id="${config.enabledId}" ${appConfig[config.enabledFlag] ? 'checked' : ''}><span class="slider"></span></label></div><div id="${config.listContainerId}" style="padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;">${listHtml}<button type="button" class="btn-add" onclick="${config.addFunction}" data-lang-key="${config.langKeyAdd}"><i class="fas fa-plus"></i> ${config.addButtonLabel}</button></div>`;
            const switchEl = document.getElementById(config.enabledId), listContainerEl = document.getElementById(config.listContainerId); listContainerEl.style.display = switchEl.checked ? 'block' : 'none'; switchEl.addEventListener('change', () => { listContainerEl.style.display = switchEl.checked ? 'block' : 'none'; });
        }
        function renderDailyCheckinSection() { const container = document.getElementById('daily-checkin-section'); container.innerHTML = `<div class="section-toggle"><label>Enable Daily Check-in Feature</label><label class="switch"><input type="checkbox" id="dailyCheckinEnabled" ${appConfig.dailyCheckinEnabled ? 'checked' : ''}><span class="slider"></span></label></div><div id="daily-checkin-list" style="padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;"><div class="days-grid">${(appConfig.dailyCheckinRewards || []).map((item, index) => `<div class="daily-checkin-item"><div class="form-group"><label class="day-label">Day ${item.day}</label><input type="number" step="0.01" data-type="checkinReward" data-index="${index}" value="${item.reward}"></div><button type="button" class="btn-remove" onclick="removeCheckinDay(${index})">&times;</button></div>`).join('')}</div><button type="button" class="btn-add" onclick="addCheckinDay()"><i class="fas fa-plus"></i> Add New Day</button></div>`; const switchEl = document.getElementById('dailyCheckinEnabled'), listEl = document.getElementById('daily-checkin-list'); listEl.style.display = switchEl.checked ? 'block' : 'none'; switchEl.addEventListener('change', () => { listEl.style.display = switchEl.checked ? 'block' : 'none'; }); }
        window.addCheckinDay = () => { if (!appConfig.dailyCheckinRewards) appConfig.dailyCheckinRewards = []; const nextDay = appConfig.dailyCheckinRewards.length + 1; appConfig.dailyCheckinRewards.push({ day: nextDay, reward: 0 }); renderDailyCheckinSection(); }; window.removeCheckinDay = (index) => { if(confirm('Are you sure?')) { appConfig.dailyCheckinRewards.splice(index, 1); appConfig.dailyCheckinRewards.forEach((item, i) => item.day = i + 1); renderDailyCheckinSection(); }};
        
        function renderTasksSection() {
            const container = document.getElementById('tasks-section');
            const list = appConfig.tasks || [];
            const listHtml = list.map((item, index) => {
                const isScreenshot = item.type === 'screenshot';
                const isQuestion = item.type === 'question_answer';
                const isWatchAds = item.type === 'watch_ads_claim';

                return `
                <div class="task-setting" id="task-item-${index}">
                    <div class="task-setting-grid">
                        <input type="text" data-type="taskTitle" data-index="${index}" value="${item.title}" placeholder="Task Title">
                        <input type="text" data-type="taskIconUrl" data-index="${index}" value="${item.iconUrl || ''}" placeholder="Icon URL (Optional)">
                        <input type="number" step="1" data-type="taskReward" data-index="${index}" value="${item.reward}" placeholder="Reward">
                        <label class="switch"><input type="checkbox" data-type="taskItemEnabled" data-index="${index}" ${item.enabled ? 'checked' : ''}><span class="slider"></span></label>
                        <div class="order-controls"><button type="button" class="btn-order" onclick="window.moveItem('tasks', ${index}, 'up')" ${index === 0 ? 'disabled' : ''}>▲</button><button type="button" class="btn-order" onclick="window.moveItem('tasks', ${index}, 'down')" ${index === list.length - 1 ? 'disabled' : ''}>▼</button></div>
                        <button type="button" class="btn-remove" onclick="removeTask(${index})">&times;</button>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label>Task Type</label>
                        <select data-type="taskType" data-index="${index}" onchange="window.handleTaskTypeChange(this, ${index})">
                            <option value="join_claim" ${item.type === 'join_claim' ? 'selected' : ''}>Join & Claim</option>
                            <option value="screenshot" ${isScreenshot ? 'selected' : ''}>Screenshot Submission</option>
                            <option value="question_answer" ${isQuestion ? 'selected' : ''}>Question & Answer</option>
                            <option value="watch_ads_claim" ${isWatchAds ? 'selected' : ''}>Watch Ads & Claim</option>
                        </select>
                    </div>
                    <div class="form-group task-type-field" id="task-link-field-${index}" style="display: ${!isScreenshot && !isQuestion && !isWatchAds ? 'block' : 'none'};">
                        <label>Task Link</label>
                        <input type="text" data-type="taskLink" data-index="${index}" value="${item.link || ''}" placeholder="https://t.me/your_channel">
                    </div>
                    <div class="form-group task-type-field" id="task-description-field-${index}" style="display: ${isScreenshot ? 'block' : 'none'};">
                        <label>Task Description for User</label>
                        <textarea data-type="taskDescription" data-index="${index}" placeholder="e.g., Subscribe to our YouTube channel and upload a screenshot.">${item.description || ''}</textarea>
                    </div>
                    <div id="task-qa-fields-${index}" style="display: ${isQuestion ? 'block' : 'none'};">
                        <div class="form-group task-type-field">
                            <label>Question</label>
                            <input type="text" data-type="taskQuestion" data-index="${index}" value="${item.question || ''}" placeholder="e.g., What is the capital of Bangladesh?">
                        </div>
                        <div class="form-group task-type-field">
                            <label>Correct Answer (Case-sensitive)</label>
                            <input type="text" data-type="taskAnswer" data-index="${index}" value="${item.answer || ''}" placeholder="e.g., Dhaka">
                        </div>
                    </div>
                    <div class="form-group task-type-field" id="task-watch-ads-field-${index}" style="display: ${isWatchAds ? 'block' : 'none'};">
                        <label>Required Ads to Watch</label>
                        <input type="number" data-type="taskRequiredAds" data-index="${index}" value="${item.requiredAds || ''}" placeholder="e.g., 20">
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = `
                <div class="section-toggle">
                    <label>Enable Tasks Feature</label>
                    <label class="switch"><input type="checkbox" id="tasksEnabled" ${appConfig.tasksEnabled ? 'checked' : ''}><span class="slider"></span></label>
                </div>
                <div id="tasks-list" style="padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;">
                    ${listHtml}
                    <button type="button" class="btn-add" onclick="window.addTask()"><i class="fas fa-plus"></i> Add Task</button>
                </div>`;
            
            const switchEl = document.getElementById('tasksEnabled');
            const listContainerEl = document.getElementById('tasks-list');
            listContainerEl.style.display = switchEl.checked ? 'block' : 'none';
            switchEl.addEventListener('change', () => { listContainerEl.style.display = switchEl.checked ? 'block' : 'none'; });
        }

        window.handleTaskTypeChange = (selectElement, index) => {
            const selectedType = selectElement.value;
            document.getElementById(`task-link-field-${index}`).style.display = selectedType === 'join_claim' ? 'block' : 'none';
            document.getElementById(`task-description-field-${index}`).style.display = selectedType === 'screenshot' ? 'block' : 'none';
            document.getElementById(`task-qa-fields-${index}`).style.display = selectedType === 'question_answer' ? 'block' : 'none';
            document.getElementById(`task-watch-ads-field-${index}`).style.display = selectedType === 'watch_ads_claim' ? 'block' : 'none';
        };

        window.addTask = () => { if (!appConfig.tasks) appConfig.tasks = []; appConfig.tasks.push({ id: Date.now(), title: '', reward: 0, enabled: true, type: 'join_claim', iconUrl: '' }); renderTasksSection(); }; 
        window.removeTask = (index) => { if(confirm('Are you sure?')) { appConfig.tasks.splice(index, 1); renderTasksSection(); }};
        
        function renderUserTiersSection() { 
            const list = appConfig.userTiers || [];
            renderSection('user-tiers-section', list, { toggleLabel: 'Enable User Tiers Feature', enabledId: 'userTiersEnabled', enabledFlag: 'userTiersEnabled', listContainerId: 'user-tiers-list', 
                itemRenderer: (item, index) => `<div class="tier-setting">
                    <input type="text" data-type="tierName" data-index="${index}" value="${item.name}" placeholder="Tier Name">
                    <input type="number" data-type="tierRequiredPoints" data-index="${index}" value="${item.requiredPoints}" placeholder="Required Points">
                    <input type="number" data-type="tierBonusPercent" data-index="${index}" value="${item.bonusPercent}" placeholder="Bonus %">
                    <input type="number" data-type="tierMinWithdraw" data-index="${index}" value="${item.minWithdraw || ''}" placeholder="Min Withdraw">
                    <input type="number" data-type="tierDailyLimit" data-index="${index}" value="${item.dailyWithdrawLimit || ''}" placeholder="Daily Limit">
                    <label class="switch"><input type="checkbox" data-type="tierItemEnabled" data-index="${index}" checked disabled><span class="slider"></span></label>
                    <div class="order-controls"><button type="button" class="btn-order" onclick="window.moveItem('userTiers', ${index}, 'up')" ${index === 0 ? 'disabled' : ''}>▲</button><button type="button" class="btn-order" onclick="window.moveItem('userTiers', ${index}, 'down')" ${index === list.length - 1 ? 'disabled' : ''}>▼</button></div>
                    <button type="button" class="btn-remove" onclick="removeUserTier(${index})">&times;</button>
                </div>`, 
                addFunction: 'window.addUserTier()', 
                addButtonLabel: 'Add Tier' 
            }); 
        }
        window.addUserTier = () => { if (!appConfig.userTiers) appConfig.userTiers = []; appConfig.userTiers.push({ name: '', requiredPoints: 0, bonusPercent: 0, minWithdraw: 0, dailyWithdrawLimit: 0 }); renderUserTiersSection(); }; window.removeUserTier = (index) => { if(confirm('Are you sure?')) { appConfig.userTiers.splice(index, 1); renderUserTiersSection(); }};
        
        function renderWithdrawalMethodsSection() { 
            const list = appConfig.withdrawalMethods || [];
            renderSection('withdrawal-methods-section', list, { 
                toggleLabel: 'Enable Withdrawal Methods', 
                enabledId: 'withdrawalMethodsEnabled', 
                enabledFlag: 'withdrawalMethodsEnabled', 
                listContainerId: 'withdrawal-methods-list', 
                itemRenderer: (item, index) => `
                <div class="method-setting">
                    <input type="text" data-type="methodName" data-index="${index}" value="${item.name}" placeholder="Method Name">
                    <input type="text" data-type="methodBnName" data-index="${index}" value="${item.bn_name}" placeholder="Bangla Name">
                    <input type="text" data-type="methodLogo" data-index="${index}" value="${item.logo}" placeholder="Logo URL">
                    <input type="number" data-type="methodMin" data-index="${index}" value="${item.min || ''}" placeholder="Min Amount">
                    <input type="number" data-type="methodMax" data-index="${index}" value="${item.max || ''}" placeholder="Max Amount">
                    <label class="switch"><input type="checkbox" data-type="methodItemEnabled" data-index="${index}" ${item.enabled ? 'checked' : ''}><span class="slider"></span></label>
                    <div class="order-controls"><button type="button" class="btn-order" onclick="window.moveItem('withdrawalMethods', ${index}, 'up')" ${index === 0 ? 'disabled' : ''}>▲</button><button type="button" class="btn-order" onclick="window.moveItem('withdrawalMethods', ${index}, 'down')" ${index === list.length - 1 ? 'disabled' : ''}>▼</button></div>
                    <button type="button" class="btn-remove" onclick="removeMethod(${index})">&times;</button>
                </div>`, 
                addFunction: 'window.addMethod()', 
                addButtonLabel: 'Add Method' 
            }); 
        }
        window.addMethod = () => { if (!appConfig.withdrawalMethods) appConfig.withdrawalMethods = []; appConfig.withdrawalMethods.push({ name: '', bn_name: '', logo: '', enabled: true, min: 0, max: 0 }); renderWithdrawalMethodsSection(); }; 
        window.removeMethod = (index) => { if(confirm('Are you sure?')) { appConfig.withdrawalMethods.splice(index, 1); renderWithdrawalMethodsSection(); }};
        
        function renderPromoCodes(codes) {
            const tbody = document.getElementById('promo-codes-table-body'); const codeEntries = Object.entries(codes);
            tbody.innerHTML = codeEntries.length === 0 ? `<tr><td colspan="5">No promo codes created.</td></tr>` : codeEntries.map(([code, data]) => { const usage = `${data.timesUsed || 0} / ${data.usageLimit}`; const isActive = (data.timesUsed || 0) < data.usageLimit; return `<tr><td data-label="Code"><strong>${code}</strong></td><td data-label="Reward">${data.reward}</td><td data-label="Usage">${usage}</td><td data-label="Status"><span class="status-badge ${isActive ? 'status-approved' : 'status-blocked'}">${isActive ? 'Active' : 'Expired'}</span></td><td data-label="Actions"><button class="action-btn btn-reject" onclick="window.deletePromoCode('${code}')">Delete</button></td></tr>`; }).join('');
        }
        window.createPromoCode = async () => {
            const codeInput = document.getElementById('promo-code-name'), rewardInput = document.getElementById('promo-code-reward'), limitInput = document.getElementById('promo-code-limit');
            const code = codeInput.value.trim().toUpperCase(), reward = parseInt(rewardInput.value, 10), usageLimit = parseInt(limitInput.value, 10);
            if (!code || isNaN(reward) || reward <= 0 || isNaN(usageLimit) || usageLimit <= 0) return showToast("Please fill all fields with valid data.", "error");
            if (/\s/.test(code)) return showToast("Promo code cannot contain spaces.", "error");
            const codeRef = ref(database, `app/promo_codes/${code}`); const snapshot = await get(codeRef); if (snapshot.exists()) return showToast("This promo code already exists.", "error");
            try { 
                await set(codeRef, { reward: reward, usageLimit: usageLimit, timesUsed: 0, users: {} });
                showToast(`Promo code "${code}" created!`);
                logAdminAction("Created Promo Code", { code: code, reward: reward, limit: usageLimit });
                codeInput.value = ''; rewardInput.value = ''; limitInput.value = ''; 
            } catch (error) { console.error("Error creating promo code:", error); showToast("Failed to create promo code.", "error"); }
        };
        window.deletePromoCode = async (code) => { 
            if (confirm(`Are you sure you want to delete "${code}"?`)) { 
                try { 
                    await remove(ref(database, `app/promo_codes/${code}`));
                    showToast(`Promo code "${code}" deleted.`);
                    logAdminAction("Deleted Promo Code", { code: code });
                } catch (error) { console.error("Error deleting promo code:", error); showToast("Failed to delete promo code.", "error"); } 
            } 
        };
        
        function handleSegmentChange() { const segment = document.getElementById('target-segment').value; document.getElementById('tier-select-group').style.display = segment === 'tier' ? 'block' : 'none'; document.getElementById('inactive-days-group').style.display = segment === 'inactive' ? 'block' : 'none'; }
        function handleActionChange() { const action = document.getElementById('action-type').value; document.getElementById('action-notification-group').style.display = action === 'notification' ? 'block' : 'none'; document.getElementById('action-bonus-group').style.display = action === 'bonus' ? 'block' : 'none'; }
        window.executeTargetedAction = async () => {
            const segment = document.getElementById('target-segment').value, action = document.getElementById('action-type').value; let targetUserIds = []; const activeUsers = Object.entries(allUsers).filter(([, user]) => !user.isBlocked);
            if (segment === 'all') { targetUserIds = activeUsers.map(([id]) => id); }
            else if (segment === 'tier') { const targetTierName = document.getElementById('target-tier').value; const tiersSorted = [...(appConfig.userTiers || [])].sort((a,b) => a.requiredPoints - b.requiredPoints); activeUsers.forEach(([id, user]) => { let currentUserTier = tiersSorted[0]; for (const tier of tiersSorted) { if ((user.totalEarnings || 0) >= tier.requiredPoints) currentUserTier = tier; else break; } if (currentUserTier && currentUserTier.name === targetTierName) targetUserIds.push(id); }); }
            else if (segment === 'inactive') { const days = parseInt(document.getElementById('inactive-days').value, 10); if (isNaN(days) || days <= 0) return showToast("Invalid number of days.", "error"); const threshold = Date.now() - (days * 24 * 60 * 60 * 1000); activeUsers.forEach(([id, user]) => { const lastLoginTimestamp = user.profile?.lastLogin?.timestamp; if (!lastLoginTimestamp || new Date(lastLoginTimestamp).getTime() < threshold) targetUserIds.push(id); }); }
            if (targetUserIds.length === 0) return showToast("No users found for this segment.", "info");
            if (!confirm(`This action will affect ${targetUserIds.length} user(s). Proceed?`)) return;
            let successCount = 0;
            if (action === 'notification') { const message = document.getElementById('action-notification-message').value.trim(); if (!message) return showToast("Message cannot be empty.", "error"); for (const userId of targetUserIds) { await set(push(ref(database, `app/users/${userId}/notifications`)), { message: message, date: new Date().toISOString(), read: false }); successCount++; } }
            else if (action === 'bonus') { const points = parseInt(document.getElementById('action-bonus-points').value, 10); const reason = document.getElementById('action-bonus-reason').value.trim() || 'Bonus from Admin'; if (isNaN(points) || points <= 0) return showToast("Invalid bonus amount.", "error"); for (const userId of targetUserIds) { const userRef = ref(database, `app/users/${userId}`); const userSnapshot = await get(userRef); if (userSnapshot.exists()) { const currentBalance = userSnapshot.val().balance || 0; const updates = { balance: currentBalance + points }; const newHistoryRef = push(ref(database, `app/users/${userId}/transactionHistory`)); updates[`transactionHistory/${newHistoryRef.key}`] = { type: 'manual', amount: points, title: reason, date: new Date().toISOString() }; await update(userRef, updates); successCount++; } } }
            showToast(`Action executed for ${successCount} user(s).`);
            logAdminAction("Executed Targeted Action", { segment: segment, action: action, affectedCount: successCount });
        };
        
        window.applyBulkAction = async () => {
            const selectedAction = document.getElementById('bulk-action-select').value;
            const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.dataset.id);
            if (!selectedAction || selectedUsers.length === 0) return showToast("Please select an action and at least one user.", "error");
            if (!confirm(`Are you sure you want to perform '${selectedAction}' on ${selectedUsers.length} users?`)) return;
            let successCount = 0;
            if (selectedAction === 'block' || selectedAction === 'unblock') {
                const isBlocked = selectedAction === 'block';
                for (const userId of selectedUsers) { await update(ref(database, `app/users/${userId}`), { isBlocked: isBlocked }); successCount++; }
            } else if (selectedAction === 'bonus') {
                const points = parseInt(prompt("Enter points to give (positive for bonus, negative to deduct):"), 10);
                if (isNaN(points) || points === 0) return showToast("Invalid amount.", "error");
                const reason = prompt("Enter reason for this bonus:", "Bulk bonus from admin");
                for (const userId of selectedUsers) { const userRef = ref(database, `app/users/${userId}`); const snapshot = await get(userRef); if (snapshot.exists()) { const currentBalance = snapshot.val().balance || 0; const updates = { balance: currentBalance + points }; const historyRef = push(ref(database, `app/users/${userId}/transactionHistory`)); updates[`transactionHistory/${historyRef.key}`] = { type: 'manual', amount: points, title: reason, date: new Date().toISOString() }; await update(userRef, updates); successCount++; } }
            }
            showToast(`${successCount} users have been updated.`);
            logAdminAction("Applied Bulk Action", { action: selectedAction, userCount: successCount });
            renderUsers(false);
        };
        
        window.showFraudulentUsers = () => {
            const adsThreshold = parseInt(prompt("Show users who watched more than X ads today:", "500"), 10);
            const ipThreshold = appConfig.fraudDetection?.ipSharingLimit || 3;
            
            const ipMap = {};
            Object.entries(allUsers).forEach(([id, user]) => {
                const ip = user.profile?.lastLogin?.ip;
                if (ip) {
                    if (!ipMap[ip]) ipMap[ip] = [];
                    ipMap[ip].push(id);
                }
            });

            const suspiciousByIp = Object.values(ipMap).filter(users => users.length >= ipThreshold).flat();
            const suspiciousByAds = !isNaN(adsThreshold) ? Object.entries(allUsers).filter(([id, user]) => (user.dailyStats?.adsWatched || 0) > adsThreshold).map(([id]) => id) : [];
            
            const suspiciousUserIds = [...new Set([...suspiciousByIp, ...suspiciousByAds])];

            if (suspiciousUserIds.length === 0) {
                return showToast("No suspicious users found based on current criteria.", "info");
            }
            currentPage = 1;
            const tbody = document.getElementById('users-table-body');
            const filteredUserHtml = suspiciousUserIds.map(id => {
                const user = allUsers[id];
                return `<tr><td data-label="Select"><input type="checkbox" class="user-checkbox" data-id="${id}"></td><td data-label="User ID">${id}</td><td data-label="Name">${(user.profile?.firstName || 'N/A')} ${(user.profile?.lastName || '')}</td><td data-label="Balance">${(user.balance || 0).toLocaleString()}</td><td data-label="Status"><span class="status-badge ${user.isBlocked ? 'status-blocked' : 'status-approved'}">${user.isBlocked ? 'Blocked' : 'Active'}</span></td><td data-label="Actions"><button class="action-btn btn-view" onclick="window.openUserEditModal('${id}')">Edit</button><button class="action-btn btn-history" onclick="window.openUserHistoryModal('${id}')">History</button><button class="action-btn btn-info" onclick="window.openUserReferralsModal('${id}')">Referrals</button><button class="action-btn ${user.isBlocked ? 'btn-unblock' : 'btn-block'}" onclick="window.toggleUserBlock('${id}', ${user.isBlocked || false})">${user.isBlocked ? 'Unblock' : 'Block'}</button></td></tr>`;
            }).join('');
            tbody.innerHTML = filteredUserHtml;
            renderPaginationControls(suspiciousUserIds.length, 1);
            showToast(`Showing ${suspiciousUserIds.length} suspicious users. Use "Reset Filter" to see all users.`, "info");
        };

        function renderPointPackagesSection() { renderSection('point-packages-section', appConfig.pointPackages || [], { toggleLabel: 'Enable Point Store Feature', enabledId: 'storeEnabled', enabledFlag: 'storeEnabled', listContainerId: 'point-packages-list', itemRenderer: (item, index) => `<div class="package-setting"><input type="text" data-type="packagePrice" data-index="${index}" value="${item.price}" placeholder="Price (e.g., 100)"><input type="text" data-type="packageCurrency" data-index="${index}" value="${item.currency}" placeholder="Currency (BDT)"><input type="number" data-type="packagePoints" data-index="${index}" value="${item.points}" placeholder="Points"><button type="button" class="btn-remove" onclick="removePointPackage(${index})">&times;</button></div>`, addFunction: 'window.addPointPackage()', addButtonLabel: 'Add Package' }); }
        window.addPointPackage = () => { if (!appConfig.pointPackages) appConfig.pointPackages = []; appConfig.pointPackages.push({ price: 0, currency: 'BDT', points: 0, enabled: true }); renderPointPackagesSection(); };
        window.removePointPackage = (index) => { if (confirm('Are you sure?')) { appConfig.pointPackages.splice(index, 1); renderPointPackagesSection(); } };
        
        function renderTextManagementSection() {
            const container = document.getElementById('text-management-section'); const strings = appConfig.textStrings || {};
            container.innerHTML = `
                <div class="text-setting"><label>Nav: Home</label><input type="text" id="text-navHome" value="${strings.navHome || ''}"></div>
                <div class="text-setting"><label>Nav: Earn</label><input type="text" id="text-navEarn" value="${strings.navEarn || ''}"></div>
                <div class="text-setting"><label>Nav: Refer</label><input type="text" id="text-navRefer" value="${strings.navRefer || ''}"></div>
                <div class="text-setting"><label>Nav: Profile</label><input type="text" id="text-navProfile" value="${strings.navProfile || ''}"></div>
                <div class="text-setting"><label>Refer Page Title</label><input type="text" id="text-referTitle" value="${strings.referTitle || ''}"></div>
                <div class="text-setting"><label>Refer Link Title</label><input type="text" id="text-referLinkTitle" value="${strings.referLinkTitle || ''}"></div>
            `;
        }
        function renderErrorMessageSection() {
            const container = document.getElementById('error-message-section');
            const messages = appConfig.textStrings.errorMessages || {};
            container.innerHTML = Object.entries(messages).map(([key, value]) => `
                <div class="error-message-setting">
                    <label for="error-${key}">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</label>
                    <input type="text" id="error-${key}" data-key="${key}" value="${value}">
                </div>
            `).join('');
        }
        
        function renderLeaderboardSection() {
            const container = document.getElementById('leaderboard-section');
            const config = appConfig.leaderboard || { enabled: false, resetFrequency: 'daily', rewards: { top1: 0, top2: 0, top3: 0 } };
            container.innerHTML = `
                <div class="section-toggle">
                    <label>Enable Leaderboard Feature</label>
                    <label class="switch"><input type="checkbox" id="leaderboardEnabled" ${config.enabled ? 'checked' : ''}><span class="slider"></span></label>
                </div>
                <div id="leaderboard-settings-container" style="display: ${config.enabled ? 'block' : 'none'}; padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;">
                    <div class="form-group">
                        <label for="leaderboardReset">Reset Frequency</label>
                        <select id="leaderboardReset">
                            <option value="daily" ${config.resetFrequency === 'daily' ? 'selected' : ''}>Daily</option>
                            <option value="weekly" ${config.resetFrequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                             <option value="monthly" ${config.resetFrequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                            <option value="never" ${config.resetFrequency === 'never' ? 'selected' : ''}>Never</option>
                        </select>
                    </div>
                    <h4>Leaderboard Rewards (Points)</h4>
                    <div class="leaderboard-reward-grid">
                        <div class="form-group"><label for="leaderboardTop1">Top 1 Prize</label><input type="number" id="leaderboardTop1" value="${config.rewards.top1 || 0}"></div>
                        <div class="form-group"><label for="leaderboardTop2">Top 2 Prize</label><input type="number" id="leaderboardTop2" value="${config.rewards.top2 || 0}"></div>
                        <div class="form-group"><label for="leaderboardTop3">Top 3 Prize</label><input type="number" id="leaderboardTop3" value="${config.rewards.top3 || 0}"></div>
                    </div>
                    <hr>
                    <button type="button" class="update-btn" style="background-color: var(--purple);" onclick="window.manuallyResetLeaderboard()">Manually End Season & Payout</button>
                </div>`;

            document.getElementById('leaderboardEnabled').addEventListener('change', (e) => {
                document.getElementById('leaderboard-settings-container').style.display = e.target.checked ? 'block' : 'none';
            });
        }
        
        function renderAdvancedTextManagementSection() {
            const container = document.getElementById('advanced-text-management-section');
            const strings = appConfig.uiStrings || {};
            container.innerHTML = `
                <h4>Home Page</h4>
                <div class="text-setting"><label>Balance Label</label><input type="text" id="ui-balanceLabel" value="${strings.balanceLabel || 'Balance:'}"></div>
                <div class="text-setting"><label>Total Earnings Card Title</label><input type="text" id="ui-totalEarningsLabel" value="${strings.totalEarningsLabel || 'Total Earnings'}"></div>
                <div class="text-setting"><label>Ads Watched Card Title</label><input type="text" id="ui-adsWatchedLabel" value="${strings.adsWatchedLabel || 'Ads Watched (Total)'}"></div>
                <div class="text-setting"><label>Total Referrals Card Title</label><input type="text" id="ui-totalReferralsLabel" value="${strings.totalReferralsLabel || 'Total Referrals'}"></div>
                <hr>
                <h4>Profile Page</h4>
                <div class="text-setting"><label>Request Withdrawal Button</label><input type="text" id="ui-requestWithdrawalBtn" value="${strings.requestWithdrawalBtn || 'Request Withdrawal'}"></div>
                <div class="text-setting"><label>Transaction History Button</label><input type="text" id="ui-transactionHistoryBtn" value="${strings.transactionHistoryBtn || 'Transaction History'}"></div>
            `;
        }

        function renderOfferwallSection() {
            const container = document.getElementById('offerwall-section');
            const config = appConfig.offerwall || { enabled: false, code: '' };
            container.innerHTML = `
                <div class="section-toggle">
                    <label>Enable Offerwall Feature</label>
                    <label class="switch"><input type="checkbox" id="offerwallEnabled" ${config.enabled ? 'checked' : ''}><span class="slider"></span></label>
                </div>
                <div id="offerwall-settings-container" style="display: ${config.enabled ? 'block' : 'none'}; padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;">
                    <div class="form-group">
                        <label for="offerwallCode">Offerwall HTML/JS Code</label>
                        <textarea id="offerwallCode" rows="8" placeholder="Paste your Offerwall provider's code here...">${config.code || ''}</textarea>
                    </div>
                </div>`;

            document.getElementById('offerwallEnabled').addEventListener('change', (e) => {
                document.getElementById('offerwall-settings-container').style.display = e.target.checked ? 'block' : 'none';
            });
        }
        
        function renderIpManagementSection() {
            const firewall = appConfig.firewall || { blocked: [], whitelisted: [] };
            const blockedList = document.getElementById('blocked-ip-list');
            const whitelistedList = document.getElementById('whitelisted-ip-list');
            
            blockedList.innerHTML = (firewall.blocked || []).map(ip => `<li class="ip-list-item"><span>${ip}</span><button class="btn-remove" onclick="window.removeIp('blocked', '${ip}')">&times;</button></li>`).join('');
            whitelistedList.innerHTML = (firewall.whitelisted || []).map(ip => `<li class="ip-list-item"><span>${ip}</span><button class="btn-remove" onclick="window.removeIp('whitelisted', '${ip}')">&times;</button></li>`).join('');
        }

        window.blockIp = () => {
            const ip = document.getElementById('ip-address-input').value.trim();
            if (!ip) return showToast('Please enter an IP address.', 'error');
            if (!appConfig.firewall) appConfig.firewall = { blocked: [], whitelisted: [] };
            if (!appConfig.firewall.blocked) appConfig.firewall.blocked = [];
            if (!appConfig.firewall.blocked.includes(ip)) {
                appConfig.firewall.blocked.push(ip);
                renderIpManagementSection();
                document.getElementById('ip-address-input').value = '';
            } else {
                showToast('This IP is already blocked.', 'info');
            }
        };

        window.whitelistIp = () => {
            const ip = document.getElementById('ip-address-input').value.trim();
            if (!ip) return showToast('Please enter an IP address.', 'error');
            if (!appConfig.firewall) appConfig.firewall = { blocked: [], whitelisted: [] };
            if (!appConfig.firewall.whitelisted) appConfig.firewall.whitelisted = [];
            if (!appConfig.firewall.whitelisted.includes(ip)) {
                appConfig.firewall.whitelisted.push(ip);
                renderIpManagementSection();
                document.getElementById('ip-address-input').value = '';
            } else {
                showToast('This IP is already whitelisted.', 'info');
            }
        };

        window.removeIp = (listType, ip) => {
            if (appConfig.firewall && appConfig.firewall[listType]) {
                appConfig.firewall[listType] = appConfig.firewall[listType].filter(item => item !== ip);
                renderIpManagementSection();
            }
        };


        function renderLotterySection(lotteryData) {
            const container = document.getElementById('lottery-section');
            const config = appConfig.lottery || { enabled: false, ticketPrice: 100, prizeAmount: 5000 };
            
            const participants = lotteryData?.current_round?.participants || {};
            const ticketCount = Object.keys(participants).length;

            container.innerHTML = `
                <div class="section-toggle">
                    <label>Enable Lottery System</label>
                    <label class="switch"><input type="checkbox" id="lotteryEnabled" ${config.enabled ? 'checked' : ''}><span class="slider"></span></label>
                </div>
                <div id="lottery-settings-container" style="display: ${config.enabled ? 'block' : 'none'}; padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;">
                    <div class="form-group"><label for="lotteryTicketPrice">Ticket Price (Points)</label><input type="number" id="lotteryTicketPrice" value="${config.ticketPrice}"></div>
                    <div class="form-group"><label for="lotteryPrizeAmount">Total Prize (Points)</label><input type="number" id="lotteryPrizeAmount" value="${config.prizeAmount}"></div>
                    <hr>
                    <h4>Current Round Status</h4>
                    <p><strong>Tickets Sold:</strong> <span id="lottery-tickets-sold">${ticketCount}</span></p>
                    <button type="button" class="update-btn" style="background-color: var(--purple);" onclick="window.drawLotteryWinner()" ${ticketCount === 0 ? 'disabled' : ''}>Draw Winner & Start New Round</button>
                </div>`;

            document.getElementById('lotteryEnabled').addEventListener('change', (e) => {
                document.getElementById('lottery-settings-container').style.display = e.target.checked ? 'block' : 'none';
            });
        }
        
        function renderGamificationSettings() {
            const container = document.getElementById('gamification-section');
            const config = appConfig.gamification || DEFAULT_CONFIG.gamification;
            const levelsHtml = (config.levels || []).map((level, index) => `
                <div class="level-setting">
                    <label class="day-label">Level ${level.level}</label>
                    <div class="form-group" style="margin: 0;">
                        <input type="number" placeholder="XP Required" data-type="levelXp" data-index="${index}" value="${level.xp}">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <input type="number" placeholder="Level Up Bonus (Points)" data-type="levelBonus" data-index="${index}" value="${level.bonus || config.levelUpBonus}">
                    </div>
                    <button type="button" class="btn-remove" onclick="window.removeLevel(${index})">&times;</button>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="section-toggle">
                    <label>Enable Gamification (XP & Level System)</label>
                    <label class="switch"><input type="checkbox" id="gamificationEnabled" ${config.enabled ? 'checked' : ''}><span class="slider"></span></label>
                </div>
                <div id="gamification-settings-container" style="display: ${config.enabled ? 'block' : 'none'}; padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;">
                    <h4>XP Rewards per Action</h4>
                    <div class="gamification-grid">
                        <div class="form-group"><label>XP per Ad Watched</label><input type="number" id="xpPerAd" value="${config.xpPerAd}"></div>
                        <div class="form-group"><label>XP per Referral</label><input type="number" id="xpPerReferral" value="${config.xpPerReferral}"></div>
                        <div class="form-group"><label>XP per Task Completed</label><input type="number" id="xpPerTask" value="${config.xpPerTask}"></div>
                        <div class="form-group"><label>XP per Daily Check-in</label><input type="number" id="xpPerCheckin" value="${config.xpPerCheckin}"></div>
                        <div class="form-group"><label>Default Level-Up Bonus (Points)</label><input type="number" id="levelUpBonus" value="${config.levelUpBonus}"></div>
                    </div>
                    <hr>
                    <h4>Level Definitions</h4>
                    <div id="levels-list-container">${levelsHtml}</div>
                    <button type="button" class="btn-add" onclick="window.addLevel()"><i class="fas fa-plus"></i> Add Level</button>
                </div>`;
            
            document.getElementById('gamificationEnabled').addEventListener('change', (e) => {
                document.getElementById('gamification-settings-container').style.display = e.target.checked ? 'block' : 'none';
            });
        }
        
        window.addLevel = () => {
            if (!appConfig.gamification.levels) appConfig.gamification.levels = [];
            const lastLevel = appConfig.gamification.levels.slice(-1)[0] || { level: 0, xp: 0 };
            appConfig.gamification.levels.push({ level: lastLevel.level + 1, xp: lastLevel.xp + 500, bonus: appConfig.gamification.levelUpBonus });
            renderGamificationSettings();
        };

        window.removeLevel = (index) => {
            if (confirm('Are you sure you want to remove this level?')) {
                appConfig.gamification.levels.splice(index, 1);
                renderGamificationSettings();
            }
        };
        
        window.drawLotteryWinner = async () => {
            if (!confirm("Are you sure you want to draw the lottery winner now? This will end the current round.")) return;

            try {
                const lotterySnapshot = await get(lotteryRef);
                const lotteryData = lotterySnapshot.val();
                const participantsObj = lotteryData?.current_round?.participants;

                if (!participantsObj) {
                    return showToast("No participants in the current lottery round.", "info");
                }

                const participants = Object.keys(participantsObj);
                const winnerId = participants[Math.floor(Math.random() * participants.length)];
                
                const prizeAmount = appConfig.lottery.prizeAmount || 0;
                const winnerRef = ref(database, `app/users/${winnerId}`);
                const winnerSnapshot = await get(winnerRef);

                if (!winnerSnapshot.exists()) {
                    return showToast(`Winner (${winnerId}) not found. Refunding tickets is recommended.`, "error");
                }
                
                const winnerData = winnerSnapshot.val();
                const newBalance = (winnerData.balance || 0) + prizeAmount;
                const historyRef = push(ref(database, `app/users/${winnerId}/transactionHistory`));
                const updates = {
                    balance: newBalance,
                    [`transactionHistory/${historyRef.key}`]: {
                        type: 'manual',
                        amount: prizeAmount,
                        title: 'Lottery Prize Winner!',
                        date: new Date().toISOString()
                    }
                };
                await update(winnerRef, updates);

                const pastWinnersRef = push(ref(database, 'app/lottery/past_winners'));
                await set(pastWinnersRef, {
                    winnerId: winnerId,
                    prizeAmount: prizeAmount,
                    participantsCount: participants.length,
                    date: new Date().toISOString()
                });

                await remove(ref(database, 'app/lottery/current_round'));
                
                logAdminAction("Lottery Winner Drawn", { winnerId: winnerId, prize: prizeAmount, participants: participants.length });
                showToast(`Congratulations! The winner is User ID: ${winnerId}. Prize of ${prizeAmount} points has been sent.`, "success");

            } catch (error) {
                console.error("Error drawing lottery winner:", error);
                showToast("An error occurred while drawing the winner.", "error");
            }
        };
        
        window.manuallyResetLeaderboard = async () => {
            if (!confirm("Are you sure you want to end the leaderboard season and pay out rewards? This action cannot be undone.")) return;
            
            const leaderboardRef = ref(database, 'app/leaderboard');
            const leaderboardSnapshot = await get(leaderboardRef);
            if (!leaderboardSnapshot.exists()) return showToast("Leaderboard data not found.", "error");
            
            const leaderboardData = leaderboardSnapshot.val();
            const sortedUsers = Object.entries(leaderboardData).sort(([,a], [,b]) => b.score - a.score);
            const rewards = appConfig.leaderboard.rewards;

            const topUsers = [
                { user: sortedUsers[0], prize: rewards.top1 },
                { user: sortedUsers[1], prize: rewards.top2 },
                { user: sortedUsers[2], prize: rewards.top3 }
            ];

            let payoutLog = "Payout Results:\n";
            for (const { user, prize } of topUsers) {
                if (user && prize > 0) {
                    const [userId, userData] = user;
                    const userRef = ref(database, `app/users/${userId}`);
                    const userSnapshot = await get(userRef);
                    
                    if (userSnapshot.exists()) {
                        const currentBalance = userSnapshot.val().balance || 0;
                        const newBalance = currentBalance + prize;
                        const historyRef = push(ref(database, `app/users/${userId}/transactionHistory`));
                        
                        await update(userRef, {
                            balance: newBalance,
                            [`transactionHistory/${historyRef.key}`]: {
                                type: 'manual',
                                amount: prize,
                                title: 'Leaderboard Season Prize',
                                date: new Date().toISOString()
                            }
                        });
                        payoutLog += `- User ${userId} (${userData.firstName}) awarded ${prize} points.\n`;
                    }
                }
            }

            await remove(leaderboardRef);
            const allUsersSnapshot = await get(usersRef);
            if (allUsersSnapshot.exists()) {
                const updates = {};
                allUsersSnapshot.forEach(userSnap => {
                    updates[`${userSnap.key}/leaderboardStats/score`] = 0;
                });
                await update(usersRef, updates);
            }

            logAdminAction("Leaderboard Season Ended", { payoutLog: payoutLog });
            showToast("Leaderboard season ended, rewards paid out, and scores reset!", "success");
            alert(payoutLog);
        };

        async function createSaveFunction(sectionName, logic) {
            logic();
            if (await saveConfigToFirebase()) {
                showToast(`${sectionName} settings saved successfully!`);
                logAdminAction(`Saved ${sectionName} Settings`);
            }
        }
        
        // #### START: NEW FEATURE RENDER AND SAVE FUNCTIONS ####

        function renderGenericEarningFeature(config) {
            const { featureKey, containerId, sectionTitle, fields, listConfig } = config;
            const featureConfig = appConfig[featureKey] || { enabled: false };
            const container = document.getElementById(containerId);

            let listHtml = '';
            if (listConfig) {
                listHtml = `
                    <h4>${listConfig.listTitle}</h4>
                    <div id="${featureKey}-list-container">
                        ${(featureConfig[listConfig.listKey] || []).map(listConfig.itemRenderer).join('')}
                    </div>
                    <button type="button" class="btn-add" onclick="${listConfig.addFunction}"><i class="fas fa-plus"></i> ${listConfig.addButtonLabel}</button>
                `;
            }

            let fieldsHtml = fields.map(field => `
                <div class="form-group">
                    <label for="${featureKey}-${field.id}">${field.label}</label>
                    <input type="${field.type || 'number'}" id="${featureKey}-${field.id}" value="${featureConfig[field.id] || ''}" placeholder="${field.placeholder || ''}">
                </div>
            `).join('');

            container.innerHTML = `
                <div class="section-toggle">
                    <label>Enable ${sectionTitle} Feature</label>
                    <label class="switch"><input type="checkbox" id="${featureKey}-enabled" ${featureConfig.enabled ? 'checked' : ''}><span class="slider"></span></label>
                </div>
                <div id="${featureKey}-settings-container" style="padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;">
                    ${fieldsHtml}
                    ${listHtml ? '<hr>' + listHtml : ''}
                </div>
            `;
            
            const switchEl = document.getElementById(`${featureKey}-enabled`);
            const settingsContainer = document.getElementById(`${featureKey}-settings-container`);
            settingsContainer.style.display = switchEl.checked ? 'block' : 'none';
            switchEl.addEventListener('change', (e) => {
                settingsContainer.style.display = e.target.checked ? 'block' : 'none';
            });
        }

        // --- Spin Wheel ---
        function renderSpinWheelSection() {
            renderGenericEarningFeature({
                featureKey: 'spinWheel',
                containerId: 'spin-wheel-section',
                sectionTitle: 'Spin Wheel',
                fields: [
                    { id: 'cost', label: 'Cost per Spin (Points)', placeholder: '0 for free' },
                    { id: 'dailyLimit', label: 'Daily Spin Limit', placeholder: 'e.g., 10' }
                ],
                listConfig: {
                    listTitle: 'Spin Wheel Segments (Prizes)',
                    listKey: 'segments',
                    itemRenderer: (item, index) => `
                        <div class="tier-setting" style="grid-template-columns: 2fr 2fr auto;">
                            <input type="text" data-type="spinSegmentText" data-index="${index}" value="${item.text}" placeholder="Display Text">
                            <input type="number" data-type="spinSegmentValue" data-index="${index}" value="${item.value}" placeholder="Reward Value">
                            <button type="button" class="btn-remove" onclick="window.removeSpinSegment(${index})">&times;</button>
                        </div>`,
                    addFunction: 'window.addSpinSegment()',
                    addButtonLabel: 'Add Segment'
                }
            });
        }
        window.addSpinSegment = () => { if (!appConfig.spinWheel.segments) appConfig.spinWheel.segments = []; appConfig.spinWheel.segments.push({ text: 'Prize', value: 0 }); renderSpinWheelSection(); };
        window.removeSpinSegment = (index) => { if (confirm('Are you sure?')) { appConfig.spinWheel.segments.splice(index, 1); renderSpinWheelSection(); } };
        window.saveSpinWheelSettings = () => createSaveFunction('Spin Wheel', () => {
            appConfig.spinWheel = {
                enabled: document.getElementById('spinWheel-enabled').checked,
                cost: parseInt(document.getElementById('spinWheel-cost').value) || 0,
                dailyLimit: parseInt(document.getElementById('spinWheel-dailyLimit').value) || 0,
                segments: Array.from(document.querySelectorAll('#spinWheel-list-container .tier-setting')).map(el => ({
                    text: el.querySelector('[data-type="spinSegmentText"]').value,
                    value: parseInt(el.querySelector('[data-type="spinSegmentValue"]').value) || 0,
                }))
            };
        });

        // --- Scratch Card ---
        function renderScratchCardSection() {
            renderGenericEarningFeature({
                featureKey: 'scratchCard',
                containerId: 'scratch-card-section',
                sectionTitle: 'Scratch Card',
                fields: [
                    { id: 'cost', label: 'Cost per Card (Points)', placeholder: '0 for free' },
                    { id: 'dailyLimit', label: 'Daily Card Limit', placeholder: 'e.g., 10' }
                ],
                listConfig: {
                    listTitle: 'Scratch Card Prizes',
                    listKey: 'prizes',
                    itemRenderer: (item, index) => `
                        <div class="tier-setting" style="grid-template-columns: 1fr 1fr 1fr auto;">
                            <input type="text" data-type="scratchPrizeText" data-index="${index}" value="${item.text}" placeholder="Display Text">
                            <input type="number" data-type="scratchPrizeValue" data-index="${index}" value="${item.value}" placeholder="Reward Value">
                            <input type="number" data-type="scratchPrizeProb" data-index="${index}" value="${item.probability}" placeholder="Probability (%)">
                            <button type="button" class="btn-remove" onclick="window.removeScratchPrize(${index})">&times;</button>
                        </div>`,
                    addFunction: 'window.addScratchPrize()',
                    addButtonLabel: 'Add Prize'
                }
            });
        }
        window.addScratchPrize = () => { if (!appConfig.scratchCard.prizes) appConfig.scratchCard.prizes = []; appConfig.scratchCard.prizes.push({ text: 'Prize', value: 0, probability: 10 }); renderScratchCardSection(); };
        window.removeScratchPrize = (index) => { if (confirm('Are you sure?')) { appConfig.scratchCard.prizes.splice(index, 1); renderScratchCardSection(); } };
        window.saveScratchCardSettings = () => createSaveFunction('Scratch Card', () => {
            appConfig.scratchCard = {
                enabled: document.getElementById('scratchCard-enabled').checked,
                cost: parseInt(document.getElementById('scratchCard-cost').value) || 0,
                dailyLimit: parseInt(document.getElementById('scratchCard-dailyLimit').value) || 0,
                prizes: Array.from(document.querySelectorAll('#scratchCard-list-container .tier-setting')).map(el => ({
                    text: el.querySelector('[data-type="scratchPrizeText"]').value,
                    value: parseInt(el.querySelector('[data-type="scratchPrizeValue"]').value) || 0,
                    probability: parseInt(el.querySelector('[data-type="scratchPrizeProb"]').value) || 0,
                }))
            };
        });

        // --- Video Zone ---
        function renderVideoZoneSection() {
            renderGenericEarningFeature({
                featureKey: 'videoZone',
                containerId: 'video-zone-section',
                sectionTitle: 'Video Zone',
                fields: [],
                listConfig: {
                    listTitle: 'Videos for Earning',
                    listKey: 'videos',
                    itemRenderer: (item, index) => `
                        <div class="task-setting">
                           <div class="tier-setting" style="grid-template-columns: 2fr 1fr 1fr 1fr auto;">
                                <input type="text" data-type="videoTitle" data-index="${index}" value="${item.title}" placeholder="Video Title">
                                <input type="text" data-type="videoUrl" data-index="${index}" value="${item.url}" placeholder="Video URL (e.g., YouTube)">
                                <input type="number" data-type="videoDuration" data-index="${index}" value="${item.duration}" placeholder="Duration (sec)">
                                <input type="number" data-type="videoReward" data-index="${index}" value="${item.reward}" placeholder="Reward">
                                <button type="button" class="btn-remove" onclick="window.removeVideo(${index})">&times;</button>
                           </div>
                        </div>`,
                    addFunction: 'window.addVideo()',
                    addButtonLabel: 'Add Video'
                }
            });
        }
        window.addVideo = () => { if (!appConfig.videoZone.videos) appConfig.videoZone.videos = []; appConfig.videoZone.videos.push({ title: 'New Video', url: '', duration: 30, reward: 10 }); renderVideoZoneSection(); };
        window.removeVideo = (index) => { if (confirm('Are you sure?')) { appConfig.videoZone.videos.splice(index, 1); renderVideoZoneSection(); } };
        window.saveVideoZoneSettings = () => createSaveFunction('Video Zone', () => {
            appConfig.videoZone = {
                enabled: document.getElementById('videoZone-enabled').checked,
                videos: Array.from(document.querySelectorAll('#videoZone-list-container .tier-setting')).map(el => ({
                    title: el.querySelector('[data-type="videoTitle"]').value,
                    url: el.querySelector('[data-type="videoUrl"]').value,
                    duration: parseInt(el.querySelector('[data-type="videoDuration"]').value) || 0,
                    reward: parseInt(el.querySelector('[data-type="videoReward"]').value) || 0,
                }))
            };
        });

        // --- Quiz System ---
        function renderQuizSystemSection() {
            const container = document.getElementById('quiz-system-section');
            const config = appConfig.quizSystem || { enabled: false, rewardPerCorrect: 5, categories: [] };

            container.innerHTML = `
                <div class="section-toggle">
                    <label>Enable Quiz System</label>
                    <label class="switch"><input type="checkbox" id="quizSystem-enabled" ${config.enabled ? 'checked' : ''}><span class="slider"></span></label>
                </div>
                <div id="quizSystem-settings-container" style="padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;">
                    <div class="form-group">
                        <label for="quizSystem-rewardPerCorrect">Reward per Correct Answer</label>
                        <input type="number" id="quizSystem-rewardPerCorrect" value="${config.rewardPerCorrect}">
                    </div>
                    <hr>
                    <h4>Quiz Categories & Questions</h4>
                    <div id="quiz-categories-container">
                        ${(config.categories || []).map((cat, catIndex) => `
                            <div class="quiz-category">
                                <div class="quiz-category-header">
                                    <input type="text" class="form-group" style="flex-grow: 1; margin: 0;" data-type="quizCatName" data-cat-index="${catIndex}" value="${cat.name}" placeholder="Category Name">
                                    <button type="button" class="btn-remove" onclick="window.removeQuizCategory(${catIndex})">&times;</button>
                                </div>
                                <div id="questions-container-${catIndex}">
                                    ${(cat.questions || []).map((q, qIndex) => `
                                        <div class="quiz-question">
                                            <input type="text" class="form-group" data-type="quizQuestionText" data-cat-index="${catIndex}" data-q-index="${qIndex}" value="${q.q}" placeholder="Question">
                                            ${(q.options || []).map((opt, optIndex) => `
                                                <div class="quiz-option">
                                                    <input type="radio" name="correct-answer-${catIndex}-${qIndex}" ${q.answer === opt ? 'checked' : ''} onchange="window.setCorrectAnswer(${catIndex}, ${qIndex}, ${optIndex})">
                                                    <input type="text" style="flex-grow: 1;" data-type="quizOptionText" data-cat-index="${catIndex}" data-q-index="${qIndex}" data-opt-index="${optIndex}" value="${opt}" placeholder="Option ${optIndex + 1}">
                                                </div>
                                            `).join('')}
                                            <button type="button" class="btn-remove" style="font-size: 0.8rem; padding: 5px 8px; margin-top: 5px;" onclick="window.removeQuizQuestion(${catIndex}, ${qIndex})">Remove Question</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <button type="button" class="btn-add" style="font-size: 0.9rem;" onclick="window.addQuizQuestion(${catIndex})">Add Question</button>
                            </div>
                        `).join('')}
                    </div>
                    <button type="button" class="btn-add" onclick="window.addQuizCategory()">Add Category</button>
                </div>
            `;
            
            const switchEl = document.getElementById('quizSystem-enabled');
            const settingsContainer = document.getElementById('quizSystem-settings-container');
            settingsContainer.style.display = switchEl.checked ? 'block' : 'none';
            switchEl.addEventListener('change', (e) => {
                settingsContainer.style.display = e.target.checked ? 'block' : 'none';
            });
        }
        window.addQuizCategory = () => { if (!appConfig.quizSystem.categories) appConfig.quizSystem.categories = []; appConfig.quizSystem.categories.push({ name: 'New Category', questions: [] }); renderQuizSystemSection(); };
        window.removeQuizCategory = (catIndex) => { if (confirm('Are you sure?')) { appConfig.quizSystem.categories.splice(catIndex, 1); renderQuizSystemSection(); } };
        window.addQuizQuestion = (catIndex) => { appConfig.quizSystem.categories[catIndex].questions.push({ q: '', options: ['', '', ''], answer: '' }); renderQuizSystemSection(); };
        window.removeQuizQuestion = (catIndex, qIndex) => { appConfig.quizSystem.categories[catIndex].questions.splice(qIndex, 1); renderQuizSystemSection(); };
        window.setCorrectAnswer = (catIndex, qIndex, optIndex) => { const optionText = document.querySelector(`[data-type="quizOptionText"][data-cat-index="${catIndex}"][data-q-index="${qIndex}"][data-opt-index="${optIndex}"]`).value; appConfig.quizSystem.categories[catIndex].questions[qIndex].answer = optionText; };
        window.saveQuizSystemSettings = () => createSaveFunction('Quiz System', () => {
            appConfig.quizSystem = {
                enabled: document.getElementById('quizSystem-enabled').checked,
                rewardPerCorrect: parseInt(document.getElementById('quizSystem-rewardPerCorrect').value) || 0,
                categories: Array.from(document.querySelectorAll('.quiz-category')).map((catEl, catIndex) => ({
                    name: catEl.querySelector('[data-type="quizCatName"]').value,
                    questions: Array.from(catEl.querySelectorAll('.quiz-question')).map((qEl, qIndex) => {
                        const options = Array.from(qEl.querySelectorAll('[data-type="quizOptionText"]')).map(optEl => optEl.value);
                        const correctRadio = qEl.querySelector(`input[name="correct-answer-${catIndex}-${qIndex}"]:checked`);
                        let answer = '';
                        if (correctRadio) {
                           const correctOptionInput = correctRadio.nextElementSibling;
                           answer = correctOptionInput.value;
                        }
                        return {
                            q: qEl.querySelector('[data-type="quizQuestionText"]').value,
                            options: options,
                            answer: answer
                        };
                    })
                }))
            };
        });

        // --- Captcha Entry ---
        function renderCaptchaEntrySection() {
             renderGenericEarningFeature({
                featureKey: 'captchaEntry',
                containerId: 'captcha-entry-section',
                sectionTitle: 'Captcha Entry',
                fields: [
                    { id: 'reward', label: 'Reward per Correct Captcha', placeholder: 'e.g., 1' },
                    { id: 'dailyLimit', label: 'Daily Captcha Limit', placeholder: 'e.g., 50' }
                ]
            });
        }
        window.saveCaptchaEntrySettings = () => createSaveFunction('Captcha Entry', () => {
             appConfig.captchaEntry = {
                enabled: document.getElementById('captchaEntry-enabled').checked,
                reward: parseInt(document.getElementById('captchaEntry-reward').value) || 0,
                dailyLimit: parseInt(document.getElementById('captchaEntry-dailyLimit').value) || 0
            };
        });

        // #### END: NEW FEATURE RENDER AND SAVE FUNCTIONS ####

        window.saveAllSettings = async () => {
            // Save existing settings
            window.saveTechnicalSettings();
            window.saveAssetSettings();
            window.saveIpManagementSettings();
            window.saveAppControlSettings();
            window.saveAppCustomizationSettings();
            window.saveGamificationSettings();
            window.saveManageSettings();
            window.saveReferralControlSettings();
            window.saveAdvancedControlSettings();
            window.saveFraudDetectionSettings();
            window.saveAdSystemSettings(); 
            window.saveDailyCheckinSettings();
            window.saveTasksSettings();
            window.saveUserTiersSettings();
            window.saveWithdrawalSettings();
            window.saveOfferwallSettings();
            window.saveLotterySettings();
            window.saveLeaderboardSettings();
            window.saveStoreSettings();
            window.saveTextManagementSettings();
            window.saveAdvancedTextSettings();
            window.saveErrorMessagesSettings();
            
            // Save NEW settings
            window.saveSpinWheelSettings();
            window.saveScratchCardSettings();
            window.saveVideoZoneSettings();
            window.saveQuizSystemSettings();
            window.saveCaptchaEntrySettings();

            if (await saveConfigToFirebase()) {
                showToast('All settings have been updated successfully!', 'success');
            }
        };

        function toggleMenu() { sideNav.classList.toggle('open'); overlay.classList.toggle('active'); }
        function handleNavClick(e) { e.preventDefault(); navigateToPage(this.getAttribute('href').substring(1)); if (window.innerWidth <= 768) toggleMenu(); }
        window.navigateToPage = function(targetId) { pages.forEach(p => p.classList.remove('active')); document.getElementById(targetId).classList.add('active'); navLinks.forEach(l => { l.classList.toggle('active', l.getAttribute('href') === `#${targetId}`); }); }
        
        function updateDashboardData() {
            if(Object.keys(allUsers).length === 0) return;
            const currency = appConfig.currency || 'BDT', pointsPerCurrency = appConfig.pointsPerCurrency || 100;
            const pendingWithdrawals = Object.values(allWithdrawals).filter(w => w.status === 'Pending');
            let totalEarningsPoints = 0, totalReferrals = 0, totalAdsWatched = 0, totalCommissionPoints = 0;
            Object.values(allUsers).forEach(user => { totalEarningsPoints += user.totalEarnings || 0; totalReferrals += user.referralsList ? Object.keys(user.referralsList).length : 0; totalAdsWatched += user.totalAdsWatched || 0; totalCommissionPoints += user.totalReferralCommission || 0; });
            document.getElementById('db-total-users').textContent = Object.keys(allUsers).length;
            document.getElementById('db-ads-watched').textContent = totalAdsWatched.toLocaleString();
            document.getElementById('db-total-earnings').textContent = `${currency} ${(totalEarningsPoints / pointsPerCurrency).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('db-total-commission').textContent = `${currency} ${(totalCommissionPoints / pointsPerCurrency).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('db-total-referrals').textContent = totalReferrals.toLocaleString();
            document.getElementById('db-req-withdraw').textContent = pendingWithdrawals.length;
        }
        
        function renderSupportTickets(tickets) {
            const tbody = document.getElementById('support-tickets-body');
            const sortedTickets = Object.entries(tickets).sort(([, a], [, b]) => new Date(b.timestamp) - new Date(a.timestamp));
            tbody.innerHTML = sortedTickets.length === 0 ? `<tr><td colspan="5">No support tickets found.</td></tr>` : sortedTickets.map(([id, ticket]) => `<tr><td data-label="User ID">${ticket.userId}</td><td data-label="Date">${new Date(ticket.timestamp).toLocaleString()}</td><td data-label="Subject">${ticket.subject}</td><td data-label="Status"><span class="status-badge status-${ticket.status.toLowerCase()}">${ticket.status}</span></td><td data-label="Actions"><button class="action-btn btn-view" onclick="window.openSupportTicketModal('${id}')">View & Reply</button></td></tr>`).join('');
        }

        window.openSupportTicketModal = async (ticketId) => {
            currentReplyingTicketId = ticketId;
            const ticketRef = ref(database, `app/support_tickets/${ticketId}`);
            const snapshot = await get(ticketRef);
            if (!snapshot.exists()) return showToast("Ticket not found.", "error");
            
            const ticket = snapshot.val();
            document.getElementById('modal-ticket-subject').textContent = ticket.subject;
            document.getElementById('ticket-details-content').innerHTML = `
                <p><strong>User:</strong> ${ticket.userName || 'N/A'} (@${ticket.userUsername || 'N/A'})</p>
                <p><strong>User ID:</strong> ${ticket.userId}</p>
                <p><strong>Date:</strong> ${new Date(ticket.timestamp).toLocaleString()}</p>
                <p><strong>Original Message:</strong> ${ticket.message}</p>
            `;

            const repliesList = document.getElementById('ticket-replies-list');
            const replies = ticket.replies || {};
            repliesList.innerHTML = Object.values(replies).map(reply => `
                <div class="ticket-reply-item ${reply.isAdmin ? 'admin-reply' : 'user-reply'}">
                    <div class="reply-meta">${reply.isAdmin ? 'Admin' : 'User'} replied at ${new Date(reply.timestamp).toLocaleString()}</div>
                    <div class="reply-message">${reply.message}</div>
                </div>
            `).join('');

            document.getElementById('ticket-reply-message').value = '';
            document.getElementById('support-ticket-modal').classList.add('active');
        };

        window.closeSupportTicketModal = () => document.getElementById('support-ticket-modal').classList.remove('active');

        window.sendSupportReply = async () => {
            if (!currentReplyingTicketId) return;
            const message = document.getElementById('ticket-reply-message').value.trim();
            if (!message) return showToast("Reply message cannot be empty.", "error");

            const reply = {
                message: message,
                timestamp: new Date().toISOString(),
                isAdmin: true
            };

            try {
                const repliesRef = ref(database, `app/support_tickets/${currentReplyingTicketId}/replies`);
                await push(repliesRef, reply);
                await update(ref(database, `app/support_tickets/${currentReplyingTicketId}`), { status: 'Replied' });
                
                showToast("Reply sent successfully!");
                logAdminAction("Replied to Support Ticket", { ticketId: currentReplyingTicketId });
                closeSupportTicketModal();
            } catch (error) {
                console.error("Error sending reply:", error);
                showToast("Failed to send reply.", "error");
            }
        };

        function renderTaskSubmissions(submissions) {
            const tbody = document.getElementById('task-submissions-body');
            const filteredSubmissions = Object.entries(submissions || {}).filter(([,s]) => s.status === 'pending').sort(([,a],[,b]) => new Date(b.timestamp) - new Date(a.timestamp));

            tbody.innerHTML = filteredSubmissions.length === 0 
                ? `<tr><td colspan="6">No pending submissions found.</td></tr>` 
                : filteredSubmissions.map(([id, sub]) => `
                    <tr>
                        <td data-label="User ID">${sub.userId}</td>
                        <td data-label="Task Title">${sub.taskTitle}</td>
                        <td data-label="Submission">
                            <a href="#" class="screenshot-link" onclick="window.viewScreenshot('${sub.screenshotUrl}')">View Screenshot</a>
                        </td>
                        <td data-label="Date">${new Date(sub.timestamp).toLocaleString()}</td>
                        <td data-label="Status"><span class="status-badge status-pending">Pending</span></td>
                        <td data-label="Actions">
                            <button class="action-btn btn-approve" onclick="window.manageSubmission('${id}', 'approved')">Approve</button>
                            <button class="action-btn btn-reject" onclick="window.manageSubmission('${id}', 'rejected')">Reject</button>
                        </td>
                    </tr>`).join('');
        }
        
        window.viewScreenshot = (url) => {
            document.getElementById('screenshot-image').src = url;
            document.getElementById('screenshot-modal').classList.add('active');
        }
        window.closeScreenshotModal = () => {
            document.getElementById('screenshot-modal').classList.remove('active');
        }

        window.manageSubmission = async (submissionId, status) => {
            const reason = status === 'rejected' ? prompt("Reason for rejection (optional):") : '';
            if (reason === null) return;

            const submissionRef = ref(database, `app/task_submissions/${submissionId}`);
            const submissionSnapshot = await get(submissionRef);
            if (!submissionSnapshot.exists()) return showToast("Submission not found.", "error");

            const submission = submissionSnapshot.val();
            const userRef = ref(database, `app/users/${submission.userId}`);

            try {
                if (status === 'approved') {
                    const task = (appConfig.tasks || []).find(t => t.id === submission.taskId);
                    const reward = task ? task.reward : 0;
                    
                    if (reward > 0) {
                        const userSnapshot = await get(userRef);
                        if (userSnapshot.exists()) {
                            const userData = userSnapshot.val();
                            const updates = {
                                balance: (userData.balance || 0) + reward,
                                totalEarnings: (userData.totalEarnings || 0) + reward
                            };
                            const historyRef = push(ref(database, `app/users/${submission.userId}/transactionHistory`));
                            updates[`transactionHistory/${historyRef.key}`] = {
                                type: 'task',
                                amount: reward,
                                title: `Task Approved: ${submission.taskTitle}`,
                                date: new Date().toISOString()
                            };
                            await update(userRef, updates);
                        }
                    }
                }

                await update(submissionRef, { status: status, rejectionReason: reason || null });
                showToast(`Submission has been ${status}.`);
                logAdminAction(`Task Submission ${status}`, { submissionId: submissionId, reason: reason });
            } catch (error) {
                console.error(`Error managing submission:`, error);
                showToast("Failed to update submission status.", "error");
            }
        };

        window.exportUsersToCSV = async () => {
            if (!confirm("This will download data for ALL users. This might be slow if you have many users. Continue?")) {
                return;
            }
            showToast("Preparing user data for export... Please wait.", "info");

            const snapshot = await get(usersRef);
            if (!snapshot.exists()) {
                showToast("No user data to export.", "error");
                return;
            }

            const users = snapshot.val();
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["UserID", "FirstName", "LastName", "Username", "Balance", "TotalEarnings", "TotalAdsWatched", "TotalReferrals", "IsBlocked", "JoinedAt"];
            csvContent += headers.join(",") + "\r\n";

            for (const id in users) {
                const user = users[id];
                const row = [
                    id,
                    user.profile?.firstName || "",
                    user.profile?.lastName || "",
                    user.profile?.username || "",
                    user.balance || 0,
                    user.totalEarnings || 0,
                    user.totalAdsWatched || 0,
                    Object.keys(user.referralsList || {}).length,
                    user.isBlocked || false,
                    user.joinedAt || ""
                ];
                csvContent += row.join(",") + "\r\n";
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "users_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("User data export started.", "success");
            logAdminAction("Exported Users to CSV");
        };


        init();
    });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>The_Anisur_Earnings_Bot (Firebase)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Spin Wheel লাইব্রেরি যুক্ত করা হলো -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/winwheeljs@2.8.0/Winwheel.min.js"></script>
  <style>
    :root {
      --primary-color: #6a11cb;
      --primary-hover: #8c3dff;
      --secondary-color: #f0f2f5;
      --background-color: #f0f2f5;
      --text-color: #1c1c1f;
      --text-muted-color: #65676b;
      --accent-color: #2575fc;
      --card-bg: #ffffff;
      --gradient-start: #6a11cb;
      --gradient-end: #2575fc;
      --status-pending: #ffc107;
      --status-success: #28a745;
      --status-failed: #dc3545;
      --status-referral: #17a2b8;
      --status-login: #fd7e14;
      --status-task: #007bff;
      --status-manual: #8e44ad;
      --tier-bronze-color: #cd7f32;
      --tier-silver-color: #c0c0c0;
      --tier-gold-color: #ffd700;
      --rank-gold: #ffd700;
      --rank-silver: #c0c0c0;
      --rank-bronze: #cd7f32;
      --xp-color: #ff9800;
      --level-color: #9c27b0;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0; background-color: var(--background-color); color: var(--text-color);
      font-family: 'Segoe UI', 'Roboto', sans-serif; display: flex; justify-content: center; align-items: center;
      height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .container {
      width: 100%; height: 100%; max-width: 400px; background: var(--background-color);
      display: flex; flex-direction: column; overflow: hidden; position: relative;
    }
    main {
      flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px;
    }
    .view { display: none; animation: fadeIn 0.4s ease-in-out; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .header { display: flex; align-items: center; justify-content: space-between; padding: 0 5px 15px 5px; }
    .header-left { display: flex; align-items: center; }
    .header-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; overflow: hidden; }
    .header-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .header-info .username { font-size: 16px; font-weight: 700; margin: 0; }
    .header-info .balance { font-size: 14px; color: var(--text-muted-color); margin: 2px 0 0; font-weight: 600; }
    .header-right .notification-btn { background: none; border: none; font-size: 20px; color: var(--text-muted-color); cursor: pointer; position: relative; }
    .notification-btn .dot { width: 8px; height: 8px; background-color: var(--status-failed); border-radius: 50%; position: absolute; top: 0; right: 0; display: none; }

    .welcome-card { background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); color: white; border-radius: 16px; padding: 25px; margin-bottom: 25px; text-align: center; }
    .welcome-card h2 { margin: 0 0 10px; font-size: 20px; }
    .welcome-card p { margin: 0 0 15px; opacity: 0.9; }
    .welcome-card .action-button { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid white; padding: 12px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: background 0.3s; text-decoration: none; display: inline-block; }
    .welcome-card .action-button:hover { background: rgba(255, 255, 255, 0.3); }

    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
    .stats-card { background: var(--card-bg); border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .stats-card .icon { font-size: 24px; color: var(--primary-color); margin-bottom: 8px; }
    .stats-card .value { font-size: 20px; font-weight: 700; margin: 0; }
    .stats-card .label { font-size: 13px; color: var(--text-muted-color); margin: 2px 0 0; }
    .full-width-stats .value span { display: block; }
    .full-width-stats .value .points-value { font-size: 22px; }
    .full-width-stats .value .bdt-value { font-size: 14px; font-weight: 500; color: var(--text-muted-color); margin-top: 2px;}
    .full-width-stats { grid-column: 1 / -1; }

    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 15px; padding-left: 5px; }
    .card { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

    .profile-main { text-align: center; padding: 10px 0; }
    .profile-main .avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 10px; object-fit: cover; border: 3px solid var(--primary-color); }
    .profile-main .name { font-size: 22px; font-weight: 700; margin: 0; display: flex; align-items: center; justify-content: center; gap: 8px;}
    .profile-main .username { font-size: 16px; color: var(--text-muted-color); margin-top: 4px; }
    .tier-badge { font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 12px; color: white; text-transform: uppercase; }
    .tier-badge.bronze { background-color: var(--tier-bronze-color); }
    .tier-badge.silver { background-color: var(--tier-silver-color); }
    .tier-badge.gold { background-color: var(--tier-gold-color); }
    .level-badge { font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 12px; color: white; background-color: var(--level-color); }

    .info-list .info-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
    .info-list .info-item:last-child { border-bottom: none; }
    .info-list .label { font-size: 16px; color: var(--text-muted-color); }
    .info-list .value { font-size: 16px; font-weight: 600; text-align: right; }
    .info-list .value .bdt-value { font-size: 12px; color: var(--text-muted-color); font-weight: 500; display: block; margin-top: 2px; }
    .profile-actions { padding: 10px !important; }
    .profile-action-button { display: flex; align-items: center; width: 100%; padding: 15px; background: none; border: none; font-size: 16px; text-align: left; color: var(--text-color); cursor: pointer; border-radius: 10px; transition: background-color 0.2s ease; }
    .profile-action-button:hover { background-color: var(--secondary-color); }
    .profile-action-button i:first-child { margin-right: 15px; width: 20px; text-align: center; color: var(--primary-color); }
    .profile-action-button span { flex-grow: 1; font-weight: 600; }
    .profile-action-button i:last-child { color: var(--text-muted-color); }
    
    .xp-progress-card { text-align: left; padding: 15px; }
    .xp-progress-card .progress-info { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; font-weight: 600; color: var(--text-color); }
    .xp-progress-card .progress-info .level { color: var(--level-color); }
    .xp-progress-card .progress-info .xp { color: var(--xp-color); }
    .xp-progress-card .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
    .xp-progress-card .progress-bar-inner { height: 100%; width: 0%; background: var(--xp-color); border-radius: 4px; }
    
    .progress-card { text-align: center; }
    .progress-card h3 { margin-top: 0; }
    .progress-card .progress-info { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: var(--text-muted-color); }
    .progress-card .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
    .progress-card .progress-bar-inner { height: 100%; width: 0%; background: var(--primary-color); border-radius: 4px; }
    .limits-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; margin-bottom: 5px; }
    .limit-card { background: #fafafa; border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #e9e9e9; }
    .limit-card .icon { font-size: 22px; color: var(--primary-color); margin-bottom: 8px; }
    .limit-card .value { font-size: 18px; font-weight: 700; margin: 0; color: var(--text-color); }
    .limit-card .label { font-size: 13px; color: var(--text-muted-color); margin: 2px 0 0; }

    .action-button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: 700; margin-top: 20px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
    .action-button:disabled { background-color: #999; cursor: not-allowed; box-shadow: none; transform: none; }
    .primary-button { background: var(--primary-color); color: #fff; }
    .primary-button:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3); }
    .secondary-button { background: var(--secondary-color); color: var(--text-color); }
    .secondary-button:hover { background: #e0e0e0; }

    .task-card { padding: 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .task-card:last-child { margin-bottom: 0; }
    .task-info { display: flex; align-items: center; gap: 15px; }
    .task-info .task-icon { font-size: 20px; color: var(--status-pending); width: 24px; text-align: center; }
    .task-info .task-icon img { width: 24px; height: 24px; border-radius: 50%; }
    .task-info h4, .task-info p { margin: 0; }
    .task-info h4 { font-size: 16px; font-weight: 700; }
    .task-info p { font-size: 13px; color: var(--text-muted-color); }
    .task-button { background: var(--secondary-color); color: var(--primary-color); padding: 10px 16px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none; font-size: 14px; white-space: nowrap; flex-shrink: 0; min-width: 110px; }
    .task-button:hover:not(:disabled) { background-color: #e0e0e0; }
    .task-button:disabled { background-color: #999; color: white; cursor: not-allowed; }
    .task-button.completed { background-color: var(--status-success); color: white; }
    .task-button.completed i { margin-right: 6px; }

    .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; max-width: 400px; margin: 0 auto; display: flex; justify-content: space-around; background: var(--card-bg); padding: 10px 0; border-top: 1px solid #e0e0e0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
    .nav-button { display: flex; flex-direction: column; align-items: center; color: var(--text-muted-color); background: none; border: none; font-size: 12px; transition: color 0.2s ease, transform 0.2s ease; cursor: pointer; padding: 5px; flex-grow: 1; }
    .nav-button .icon { font-size: 22px; margin-bottom: 4px; }
    .nav-button:hover { color: var(--text-color); }
    .nav-button.active { color: var(--primary-color); transform: scale(1.1); }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--card-bg); padding: 25px; border-radius: 16px; width: 90%; max-width: 360px; text-align: left; animation: slideIn 0.3s; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; max-height: 80vh; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
    .modal-header h3 { margin: 0; font-size: 20px; color: var(--text-color); }
    .modal-header .action-button { margin-top: 0; padding: 8px 15px; font-size: 14px; }
    .modal-body { overflow-y: auto; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    #global-notification-modal .modal-content p { line-height: 1.6; color: var(--text-muted-color); text-align: center; }
    .modal-actions { display: flex; gap: 10px; margin-top: 25px;}

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: 600; color: var(--text-muted-color); margin-bottom: 8px; font-size: 14px; }
    .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; font-size: 15px; }
    .form-group textarea { resize: vertical; min-height: 100px; }
    
    .payment-method-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .payment-method-selector input[type="radio"] { position: absolute; opacity: 0; width: 0; height: 0; }
    .payment-method-label { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px 5px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.2s ease-in-out; text-align: center; height: 100%; }
    .payment-method-label img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 10px; }
    .payment-method-label span { font-size: 15px; font-weight: 600; color: var(--text-color); }
    .payment-method-selector input[type="radio"]:checked + .payment-method-label { border-color: var(--primary-color); background-color: #f3e8ff; box-shadow: 0 0 10px rgba(106, 17, 203, 0.2); }
    .withdraw-summary { margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 8px; font-size: 14px; }
    .withdraw-summary p { margin: 5px 0; display: flex; justify-content: space-between; }
    .withdraw-summary span { font-weight: 600; }

    .history-item { display: flex; align-items: center; padding: 15px; margin-bottom: 12px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .history-item .icon-wrapper { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; }
    .history-item.earning .icon-wrapper { background-color: rgba(40, 167, 69, 0.1); color: var(--status-success); }
    .history-item.withdrawal .icon-wrapper { background-color: rgba(220, 53, 69, 0.1); color: var(--status-failed); }
    .history-item.referral .icon-wrapper { background-color: rgba(23, 162, 184, 0.1); color: var(--status-referral); }
    .history-item.login .icon-wrapper { background-color: rgba(253, 126, 20, 0.1); color: var(--status-login); }
    .history-item.task .icon-wrapper { background-color: rgba(0, 123, 255, 0.1); color: var(--status-task); }
    .history-item.manual .icon-wrapper { background-color: rgba(142, 68, 173, 0.1); color: var(--status-manual); }
    .history-item-info { flex-grow: 1; display: flex; flex-direction: column; }
    .history-item-info .title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .history-item-info .details { font-size: 13px; color: var(--text-muted-color); }
    .withdrawal-details { font-size: 12px; margin-top: 5px; padding: 8px; background-color: #f9f9f9; border-radius: 6px; }
    .withdrawal-details p { margin: 3px 0; }
    
    .history-item .amount-wrapper { text-align: right; }
    .history-item .amount { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .history-item.earning .amount, .history-item.referral .amount, .history-item.login .amount, .history-item.task .amount { color: var(--status-success); }
    .history-item.withdrawal .amount { color: var(--status-failed); }
    .history-item .status { font-weight: 600; padding: 3px 8px; border-radius: 12px; font-size: 11px; }
    .status-pending, .status-open { background-color: rgba(255, 193, 7, 0.2); color: #856404; }
    .status-approved, .status-replied { background-color: rgba(40, 167, 69, 0.2); color: var(--status-success); }
    .status-rejected, .status-closed { background-color: rgba(220, 53, 69, 0.2); color: var(--status-failed); }
    .no-history, .no-referrals, .no-data { text-align: center; color: var(--text-muted-color); padding: 50px 20px; background: var(--card-bg); border-radius: 12px; }
    .no-history i, .no-referrals i, .no-data i { font-size: 48px; margin-bottom: 15px; color: #ccc; }

    .notification-list { list-style: none; padding: 0; }
    .notification-item { display: flex; padding: 15px 0; border-bottom: 1px solid #eee; }
    .notification-item:last-child { border-bottom: none; }
    .notification-item .icon { font-size: 20px; margin-right: 15px; color: var(--primary-color); }
    .notification-item .content .message { font-size: 15px; color: var(--text-color); margin: 0 0 5px; }
    .notification-item .content .date { font-size: 12px; color: var(--text-muted-color); }
    .notification-item.unread { font-weight: bold; }

    .timer-notification-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 9999999; animation: fadeIn 0.3s; }
    .timer-notification-content { color: white; font-size: 28px; font-weight: bold; padding: 25px 35px; background: rgba(0, 0, 0, 0.75); border-radius: 15px; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    .timer-notification-content .icon { font-size: 32px; margin-bottom: 10px; }

    .daily-checkin-card { text-align: center; }
    .daily-checkin-card h3 { margin-top: 0; margin-bottom: 8px; }
    .daily-checkin-card p { margin-top: 0; margin-bottom: 20px; font-size: 14px; color: var(--text-muted-color); }
    #checkin-timeline-container { height: 100px; overflow-x: auto; overflow-y: hidden; display: flex; align-items: center; padding: 0 15px 15px 15px; }
    #checkin-timeline-container::-webkit-scrollbar { height: 5px; } #checkin-timeline-container::-webkit-scrollbar-track { background: #eee; border-radius: 10px; } #checkin-timeline-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    .day-item { flex: 0 0 auto; display: flex; align-items: center; position: relative; margin-right: 25px; }
    .day-item:last-child { margin-right: 0; }
    .day-item::after { content: ''; position: absolute; height: 4px; width: 25px; background-color: #e0e0e0; top: 22px; left: 100%; transform: translateY(-50%); transition: background-color 0.5s ease; }
    .day-item:last-child::after { display: none; }
    .day-item.claimed::after { background: linear-gradient(90deg, var(--status-success), var(--status-pending)); }
    .day-content { width: 70px; display: flex; flex-direction: column; align-items: center; text-align: center; }
    .day-circle { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; margin-bottom: 8px; position: relative; z-index: 2; border: 2px solid #e0e0e0; background-color: var(--secondary-color); color: var(--text-muted-color); transition: all 0.3s ease; flex-shrink: 0; }
    .day-reward { font-size: 12px; font-weight: 600; color: var(--text-color); }
    .day-number { font-size: 10px; color: var(--text-muted-color); }
    .day-item.locked .day-circle { background-color: #f5f5f5; color: #bbb; border-color: #eee; }
    .day-item.locked .day-reward, .day-item.locked .day-number { opacity: 0.6; }
    .day-item.claimed .day-circle { background-color: var(--status-success); border-color: var(--status-success); color: white; }
    .day-item.claimable .day-circle { background-color: var(--status-pending); border-color: var(--primary-color); color: #333; cursor: pointer; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(106, 17, 203, 0.4); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(106, 17, 203, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(106, 17, 203, 0); } }

    .refer-card { padding: 20px; }
    .refer-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .refer-header h3 { margin: 0; font-size: 22px; }
    .refer-header .badge { background-color: #e3d1ff; color: var(--primary-color); padding: 5px 10px; border-radius: 8px; font-weight: 700; font-size: 14px; }
    .refer-card > p { color: var(--text-muted-color); margin-bottom: 25px; line-height: 1.5; }
    .steps-list { list-style: none; padding: 0; margin: 0; }
    .step-item { display: flex; align-items: flex-start; margin-bottom: 20px; }
    .step-item .icon { color: var(--primary-color); background-color: #f3e8ff; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-right: 15px; flex-shrink: 0; }
    .step-item .text h4 { margin: 0 0 4px; font-size: 16px; }
    .step-item .text p { margin: 0; color: var(--text-muted-color); font-size: 14px; }
    .refer-link-box { margin-top: 25px; }
    .refer-link-box p { font-weight: 600; margin: 0 0 8px; font-size: 15px; }
    .refer-link-input-wrapper { display: flex; align-items: center; }
    #referral-link-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px 0 0 8px; background: #f9f9f9; text-align: left; font-size: 14px; border-right: none; }
    .copy-button { background: var(--primary-color); color: white; border: none; padding: 0 15px; height: 46px; border-radius: 0 8px 8px 0; cursor: pointer; font-size: 16px; }
    .share-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
    .share-btn { border: none; padding: 12px 5px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap; }
    .share-btn.telegram { background: #2AABEE; color: white; } .share-btn.whatsapp { background: #25D366; color: white; } .share-btn.twitter { background: #1DA1F2; color: white; }
    .referrals-list-card h4 { margin: 0 0 15px; font-size: 18px; }
    .search-box { position: relative; margin-bottom: 15px; }
    .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted-color); }
    .search-box input { width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; font-size: 15px; }

    .earn-option-card { display: flex; align-items: center; background-color: var(--card-bg); padding: 12px 15px; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); text-decoration: none; color: var(--text-color); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .earn-option-card:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
    .earn-option-card .logo-wrapper { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; background-color: var(--secondary-color); padding: 5px; overflow: hidden; }
    .earn-option-card .logo-wrapper img { width: 100%; height: 100%; object-fit: contain; }
    .earn-option-card .info-wrapper { flex-grow: 1; display: flex; flex-direction: column; }
    .earn-option-card .info-wrapper .company-name { font-weight: 700; font-size: 16px; margin-bottom: 2px; }
    .earn-option-card .info-wrapper .subtitle { font-size: 13px; color: var(--text-muted-color); }
    .earn-option-card .action-wrapper { font-size: 16px; color: var(--text-muted-color); padding-left: 10px; }

    .store-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    .package-card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; padding: 20px; border: 2px solid transparent; transition: all 0.3s ease; }
    .package-card:hover { border-color: var(--primary-color); transform: translateY(-5px); }
    .package-card .icon { font-size: 32px; color: var(--primary-color); margin-bottom: 15px; }
    .package-card .points { font-size: 28px; font-weight: 700; margin: 0; color: var(--text-color); }
    .package-card .price { font-size: 16px; color: var(--text-muted-color); margin-top: 5px; }
    .package-card .buy-button { margin-top: 20px; padding: 12px 20px; font-size: 15px; }

    .system-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--background-color); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999999; font-size: 18px; font-weight: 600; color: var(--text-color); transition: opacity 0.5s; text-align: center; padding: 20px; }
    .system-overlay .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
    .system-overlay i { font-size: 48px; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    #announcement-banner { background-color: var(--primary-color); color: white; padding: 12px; text-align: center; font-size: 14px; position: relative; }
    #announcement-banner button { position: absolute; top: 5px; right: 10px; background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

    .ticket-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
    .ticket-list-item:hover { background-color: #f9f9f9; }
    .ticket-list-item .info .subject { font-weight: 600; }
    .ticket-list-item .info .date { font-size: 0.8rem; color: #777; }
    .ticket-details-container { background-color: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 20px; word-break: break-word; }
    .ticket-details-container p { margin: 0 0 10px; }
    .ticket-details-container strong { color: var(--primary-color); }
    .ticket-replies-list { max-height: 200px; overflow-y: auto; }
    .ticket-reply-item { margin-bottom: 15px; padding: 10px; border-radius: 8px; }
    .ticket-reply-item.user-reply { background-color: #e9ecef; }
    .ticket-reply-item.admin-reply { background-color: #d1e7dd; }
    .reply-meta { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; color: #555; }
    .reply-message { font-size: 0.95rem; white-space: pre-wrap; }
    
    .leaderboard-item { display: flex; align-items: center; margin-bottom: 12px; padding: 10px; border-radius: 10px; background-color: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    .leaderboard-item .rank { font-size: 18px; font-weight: 700; width: 30px; text-align: center; margin-right: 15px; }
    .leaderboard-item .rank.gold { color: var(--rank-gold); } .leaderboard-item .rank.silver { color: var(--rank-silver); } .leaderboard-item .rank.bronze { color: var(--rank-bronze); }
    .leaderboard-item .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; }
    .leaderboard-item .info { flex-grow: 1; }
    .leaderboard-item .info .name { font-weight: 600; font-size: 16px; }
    .leaderboard-item .info .points { color: var(--text-muted-color); font-size: 14px; }
    .leaderboard-item .prize { font-weight: 700; font-size: 16px; color: var(--primary-color); }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; width: calc(100% - 40px); max-width: 360px; }
    .toast { background-color: #fff; padding: 12px 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; opacity: 0; transform: translateY(-20px); transition: all 0.4s ease-in-out; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { border-left: 4px solid var(--status-success); }
    .toast.error { border-left: 4px solid var(--status-failed); }
    .toast.info { border-left: 4px solid var(--status-referral); }
    .toast .icon { font-size: 18px; margin-right: 10px; }
    .toast.success .icon { color: var(--status-success); }
    .toast.error .icon { color: var(--status-failed); }
    .toast.info .icon { color: var(--status-referral); }

    .pagination-controls { display: flex; justify-content: center; align-items: center; margin-top: 20px; }
    .pagination-button { background: var(--secondary-color); color: var(--text-color); border: none; padding: 8px 14px; margin: 0 4px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
    .pagination-button:disabled { background-color: #e0e0e0; color: #aaa; cursor: not-allowed; }
    .pagination-button.active { background: var(--primary-color); color: white; }
    
    #offerwall-container {
        width: 100%;
        height: 70vh;
        border: 1px solid #ddd;
        border-radius: 12px;
        overflow: hidden;
    }
    #offerwall-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    .lottery-stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 25px;
        text-align: center;
    }
    .lottery-stats-card {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #eee;
    }
    .lottery-stats-card .value {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0 0 5px 0;
    }
    .lottery-stats-card .label {
        font-size: 14px;
        color: var(--text-muted-color);
        margin: 0;
    }
    .winner-item {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .winner-item:last-child {
        border-bottom: none;
    }
    .winner-item .rank {
        font-size: 16px;
        font-weight: 700;
        width: 30px;
        color: var(--rank-gold);
    }
    .winner-item .info {
        flex-grow: 1;
    }
    .winner-item .name {
        font-weight: 600;
    }
    .winner-item .date {
        font-size: 12px;
        color: var(--text-muted-color);
    }
    .winner-item .prize {
        font-weight: 700;
        color: var(--status-success);
    }
    
    /* #### START: NEW FEATURES CSS #### */
    #spin-wheel-container {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0;
    }
    .spin-pointer {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -135px); /* Position it at the top center */
        font-size: 32px;
        color: var(--primary-color);
        z-index: 10;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    #scratch-card-container {
        position: relative;
        width: 280px;
        height: 150px;
        margin: 20px auto;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        border: 2px dashed var(--primary-color);
    }
    .scratch-prize {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-color);
        background-color: #f9f9f9;
    }
    #scratch-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .video-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #eee;
        border-radius: 8px;
    }
    .video-item i { font-size: 24px; color: var(--status-failed); margin-right: 15px; }
    .video-info { flex-grow: 1; }
    .video-info h5, .video-info p { margin: 0; }
    .video-info h5 { font-weight: 600; }
    .video-info p { font-size: 0.85rem; color: #777; }
    
    .quiz-option-btn {
        display: block;
        width: 100%;
        margin-bottom: 10px;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: none;
        font-size: 1rem;
        text-align: left;
        cursor: pointer;
    }
    .quiz-option-btn.selected {
        background-color: #e3d1ff;
        border-color: var(--primary-color);
    }
    .quiz-option-btn.correct { background-color: #d4edda; border-color: var(--status-success); }
    .quiz-option-btn.wrong { background-color: #f8d7da; border-color: var(--status-failed); }

    #captcha-image {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f1f1f1;
        font-family: 'Courier New', Courier, monospace;
        font-size: 24px;
        letter-spacing: 5px;
        text-decoration: line-through;
        margin-bottom: 15px;
        user-select: none;
    }
    /* #### END: NEW FEATURES CSS #### */
  </style>
</head>
<body>
  <div id="toast-container" class="toast-container"></div>
  <div class="system-overlay" id="loading-overlay"><div class="spinner"></div><p>Loading Settings...</p></div>
  <div class="system-overlay" id="blocked-overlay" style="display: none;"><i class="fa-solid fa-ban" style="color: var(--status-failed);"></i><div><h2>Access Denied</h2><p>Your account has been blocked by the administrator.</p></div></div>
  <div class="system-overlay" id="vpn-blocked-overlay" style="display: none;"><i class="fa-solid fa-shield-halved" style="color: var(--status-failed);"></i><div><h2>Access Restricted</h2><p>Your account has been restricted due to suspicious network activity (VPN/Proxy detected). Please disable it and restart the bot.</p></div></div>
  <div class="system-overlay" id="maintenance-overlay" style="display: none;"><i class="fa-solid fa-screwdriver-wrench" style="color: var(--status-task);"></i><h2>Under Maintenance</h2><p>The app is currently undergoing maintenance. Please check back later.</p></div>
  
  <div class="container" style="display: none;">
    <div id="announcement-banner-container"></div>
    <main id="main-content">

      <div id="common-header" class="header">
        <div class="header-left">
            <div class="header-avatar" id="header-avatar-placeholder"></div>
            <div class="header-info">
              <h2 class="username" id="header-username">Loading...</h2>
              <p class="balance"><span id="header-balance-label">Balance:</span> <span id="header-balance">...</span></p>
            </div>
        </div>
        <div class="header-right">
            <button class="notification-btn" onclick="window.openNotificationsModal()">
                <i class="fa-solid fa-bell"></i>
                <span class="dot" id="notification-dot"></span>
            </button>
        </div>
      </div>

      <div id="home-view" class="view active">
        <div class="welcome-card">
            <h2 id="welcome-message">Welcome, User!</h2>
            <p>Ready to boost your earnings?</p>
            <a href="#" target="_blank" class="action-button" id="shopping-button">Start Shopping Now &nbsp; <i class="fa-solid fa-arrow-right"></i></a>
        </div>
        <div class="stats-grid">
            <div class="stats-card full-width-stats">
                <div class="icon"><i class="fa-solid fa-wallet"></i></div>
                <h3 class="value" id="home-total-earnings"><span class="points-value">0 Points</span><span class="bdt-value">...</span></h3>
                <p class="label" id="home-total-earnings-label">Current Balance</p>
            </div>
            <div class="stats-card"><div class="icon"><i class="fa-solid fa-eye"></i></div><h3 class="value" id="home-ads-watched">0</h3><p class="label" id="home-ads-watched-label">Ads Watched (Total)</p></div>
            <div class="stats-card"><div class="icon"><i class="fa-solid fa-users"></i></div><h3 class="value" id="home-total-referrals">0</h3><p class="label" id="home-total-referrals-label">Total Referrals</p></div>
            <div class="stats-card"><div class="icon"><i class="fa-solid fa-list-check"></i></div><h3 class="value" id="home-total-tasks-completed">0</h3><p class="label">Total Task</p></div>
            <div class="stats-card"><div class="icon"><i class="fa-solid fa-hand-holding-dollar"></i></div><h3 class="value" id="home-total-commission">0 Points</h3><p class="label">Total Commission</p></div>
        </div>
        <div class="card" id="leaderboard-section" style="display: none;">
            <h3 class="section-title">Leaderboard</h3>
            <div id="leaderboard-container"></div>
        </div>
      </div>

      <div id="earn-view" class="view">
        <div id="ad-networks-container"></div>
        
        <!-- #### START: NEW FEATURES HTML #### -->
        
        <div class="card" id="spin-wheel-section" style="display: none; text-align: center;">
            <h3 class="section-title">Spin & Win</h3>
            <p id="spin-details-p">Spin the wheel to win exciting prizes!</p>
            
            <div id="spin-wheel-container">
                <i class="fa-solid fa-caret-down spin-pointer"></i>
                <canvas id="spin-canvas" width="280" height="280">Canvas not supported.</canvas>
            </div>

            <button id="spin-now-button" class="action-button primary-button" onclick="window.startSpin()">
                <i class="fa-solid fa-sync-alt"></i> Spin Now
            </button>
            <p id="spins-left-p" style="margin-top: 10px; color: var(--text-muted-color);"></p>
        </div>
        
        <div class="card" id="scratch-card-section" style="display: none; text-align: center;">
            <h3 class="section-title">Scratch & Win</h3>
            <p id="scratch-details-p">Scratch the card to reveal your prize!</p>
            <div id="scratch-card-container">
                <div id="scratch-prize-text" class="scratch-prize"></div>
                <canvas id="scratch-canvas"></canvas>
            </div>
            <p id="scratches-left-p" style="margin-top: 10px; color: var(--text-muted-color);"></p>
        </div>

        <div id="video-zone-section" style="display: none;">
            <h3 class="section-title" style="margin-top: 25px; margin-bottom: 10px;">Video Zone</h3>
            <div id="video-zone-container"></div>
        </div>

        <div class="card" id="quiz-section" style="display: none; text-align: center;">
            <h3 class="section-title">Play Quiz & Earn</h3>
            <p>Test your knowledge and earn points for every correct answer!</p>
            <div id="quiz-categories-container" style="margin: 20px 0;"></div>
        </div>
        
        <div class="card" id="captcha-section" style="display: none; text-align: center;">
            <h3 class="section-title">Captcha Entry</h3>
            <p id="captcha-details-p">Enter the text below to earn points.</p>
            <div id="captcha-image">LOADING...</div>
            <div class="form-group">
                <input type="text" id="captcha-input" placeholder="Enter captcha text">
            </div>
            <button id="captcha-submit-button" class="action-button primary-button" onclick="window.submitCaptcha()">Submit</button>
            <p id="captchas-left-p" style="margin-top: 10px; color: var(--text-muted-color);"></p>
        </div>

        <!-- #### END: NEW FEATURES HTML #### -->

        <div class="card daily-checkin-card" id="daily-checkin-section" style="display: none; margin-top: 25px;">
            <h3>Daily Check-in Bonus</h3><p>Claim your daily reward and keep your streak!</p>
            <div id="checkin-timeline-container"></div>
            <button id="claim-checkin-button" class="action-button primary-button"><i class="fa-solid fa-gift"></i> Claim Reward</button>
        </div>
        <div id="tasks-section" style="display: none;">
            <h3 class="section-title" style="margin-top: 25px; margin-bottom: 10px;">Complete Tasks</h3>
            <div id="tasks-container"></div>
        </div>
      </div>
      
      <div id="refer-view" class="view">
        <div class="card refer-card">
            <div class="refer-header">
                <h3 id="refer-title">Refer & Earn Forever</h3>
                <span class="badge" id="referral-commission-badge">...%</span>
            </div>
            <p id="referral-limit-message" style="color: var(--status-failed); font-weight: bold; display: none;"></p>
            <p id="referral-description-p">Earn a commission from your friends' earnings for life! Follow these simple steps to start:</p>
            <ul class="steps-list">
                <li class="step-item"><div class="icon"><i class="fa-solid fa-link"></i></div><div class="text"><h4>1. Copy Your Link</h4><p>Grab your unique referral link below.</p></div></li>
                <li class="step-item"><div class="icon"><i class="fa-solid fa-share-nodes"></i></div><div class="text"><h4>2. Share with Friends</h4><p>Use the Telegram, WhatsApp, or Twitter/X buttons to share your link.</p></div></li>
                <li class="step-item"><div class="icon"><i class="fa-solid fa-hand-holding-dollar"></i></div><div class="text"><h4>3. Earn Lifetime Rewards</h4><p>Get rewards once they join and start earning!</p></div></li>
            </ul>
            <div class="refer-link-box">
                <p id="refer-link-title">Your Referral Link</p>
                <div class="refer-link-input-wrapper">
                    <input type="text" id="referral-link-input" value="Loading your link..." readonly>
                    <button class="copy-button" onclick="window.copyReferralLink()"><i class="fa-regular fa-copy"></i></button>
                </div>
            </div>
            <div class="share-buttons">
                <button class="share-btn telegram" onclick="window.shareOnSocial('telegram')"><i class="fa-brands fa-telegram"></i> Telegram</button>
                <button class="share-btn whatsapp" onclick="window.shareOnSocial('whatsapp')"><i class="fa-brands fa-whatsapp"></i> WhatsApp</button>
                <button class="share-btn twitter" onclick="window.shareOnSocial('twitter')"><i class="fa-brands fa-twitter"></i> Twitter/X</button>
            </div>
        </div>
        <div class="stats-grid" style="grid-template-columns: 1fr 1fr; margin-top: -5px;">
           <div class="stats-card"><div class="icon"><i class="fa-solid fa-user-clock"></i></div><h3 class="value" id="refer-today-referrals">0</h3><p class="label">Today Referrals</p></div>
           <div class="stats-card"><div class="icon"><i class="fa-solid fa-coins"></i></div><h3 class="value" id="refer-today-commission">0 Points</h3><p class="label">Today Commission</p></div>
        </div>
        <div class="card referrals-list-card">
            <h4>Referrals List</h4>
            <div class="search-box"><i class="fa-solid fa-magnifying-glass"></i><input type="text" id="referral-search-input" onkeyup="window.renderReferralsList()" placeholder="Search referrals by username..."></div>
            <div id="referrals-list-container"></div>
            <div id="referrals-pagination-container" class="pagination-controls"></div>
        </div>
      </div>

      <div id="history-view" class="view">
          <h2 class="section-title">Transaction History</h2>
          <div id="history-list-container"></div>
          <div id="history-pagination-container" class="pagination-controls"></div>
      </div>

      <div id="store-view" class="view">
        <h2 class="section-title">Point Store</h2>
        <p style="padding: 0 5px 15px; color: var(--text-muted-color);">Purchase points to boost your progress or unlock special features!</p>
        <div id="store-packages-container" class="store-grid"></div>
      </div>
      
      <div id="offerwall-view" class="view">
          <h2 class="section-title">Offerwall</h2>
          <div id="offerwall-content-container">
          </div>
      </div>
      
      <div id="lottery-view" class="view">
          <div id="lottery-content-container">
          </div>
      </div>

      <div id="profile-view" class="view">
        <div class="card profile-main">
            <img src="" id="profile-avatar" class="avatar" alt="Avatar">
            <h2 id="profile-name" class="name">User <span id="profile-tier-badge"></span> <span id="profile-level-badge"></span></h2>
            <p id="profile-username" class="username">@username</p>
        </div>
        <div class="card xp-progress-card" id="xp-progress-section" style="display: none;">
            <div class="progress-info">
                <span class="level" id="profile-level-text">Level 1</span>
                <span class="xp" id="profile-xp-text">0 / 100 XP</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="profile-xp-progress-bar"></div>
            </div>
        </div>
        <div class="card info-list">
            <div class="info-item"><span class="label">Current Balance</span><span class="value" id="profile-balance">0 Points<span class="bdt-value">...</span></span></div>
            <div class="info-item"><span class="label">Total Earnings</span><span class="value" id="profile-total-earnings">0 Points<span class="bdt-value">...</span></span></div>
            <div class="info-item" id="profile-tier-info-item" style="display: none;"><span class="label">Current Tier</span><span class="value" id="profile-tier-value">...</span></div>
            <div class="info-item"><span class="label">Total Ads Watched</span><span class="value" id="profile-ads-watched">0</span></div>
            <div class="info-item"><span class="label">Total Referrals</span><span class="value" id="profile-referrals">0</span></div>
            <div class="info-item"><span class="label">Total Commission</span><span class="value" id="profile-total-commission">0 Points</span></div>
        </div>
        <div class="card profile-actions">
            <button class="profile-action-button" onclick="window.openWithdrawModal()"><i class="fa-solid fa-wallet"></i> <span id="profile-request-withdrawal-btn">Request Withdrawal</span> <i class="fa-solid fa-chevron-right"></i></button>
            <button class="profile-action-button" onclick="window.showView('history-view')"><i class="fa-solid fa-history"></i> <span id="profile-transaction-history-btn">Transaction History</span> <i class="fa-solid fa-chevron-right"></i></button>
            <button class="profile-action-button" onclick="window.redeemPromoCode()"><i class="fa-solid fa-gift" style="color: var(--status-task);"></i> <span>Redeem Promo Code</span> <i class="fa-solid fa-chevron-right"></i></button>
            <button class="profile-action-button" onclick="window.openMyTicketsModal()"><i class="fa-solid fa-life-ring" style="color: var(--status-referral);"></i> <span>Support</span> <i class="fa-solid fa-chevron-right"></i></button>
        </div>
      </div>
    </main>

    <nav class="footer-nav">
      <button class="nav-button active" id="nav-home-button" onclick="window.showView('home-view')"><i class="icon fa-solid fa-house"></i><span class="nav-text">Home</span></button>
      <button class="nav-button" id="nav-earn-button" onclick="window.showView('earn-view')"><i class="icon fa-solid fa-dollar-sign"></i><span class="nav-text">Earn</span></button>
      <button class="nav-button" id="nav-offerwall-button" onclick="window.showView('offerwall-view')" style="display: none;"><i class="icon fa-solid fa-gifts"></i><span class="nav-text">Offers</span></button>
      <button class="nav-button" id="nav-lottery-button" onclick="window.showView('lottery-view')" style="display: none;"><i class="icon fa-solid fa-ticket-alt"></i><span class="nav-text">Lottery</span></button>
      <button class="nav-button" id="nav-refer-button" onclick="window.showView('refer-view')"><i class="icon fa-solid fa-users"></i><span class="nav-text">Refer</span></button>
      <button class="nav-button" id="nav-store-button" onclick="window.showView('store-view')" style="display: none;"><i class="icon fa-solid fa-store"></i><span class="nav-text">Store</span></button>
      <button class="nav-button" id="nav-profile-button" onclick="window.showView('profile-view')"><i class="icon fa-solid fa-user"></i><span class="nav-text">Profile</span></button>
    </nav>
  </div>
  
  <div class="modal-overlay" id="withdraw-modal">
    <div class="modal-content">
        <div class="modal-header"><h3>Request Withdrawal</h3></div>
        <div class="modal-body">
            <div class="form-group"><label>Payment Method</label><div class="payment-method-selector" id="payment-method-selector-container"><p>Loading...</p></div></div>
            <div class="form-group"><label for="withdraw-number">Account Number</label><input type="tel" id="withdraw-number" placeholder="e.g., 01700000000"></div>
            <div class="form-group"><label for="withdraw-amount">Amount (<span class="currency-symbol-modal">...</span>)</label><input type="number" id="withdraw-amount" placeholder="Enter amount"></div>
            <div class="withdraw-summary" id="withdraw-summary" style="display: none;"></div>
        </div>
        <div class="modal-actions"><button class="action-button secondary-button" onclick="window.closeModal('withdraw-modal')">Cancel</button><button class="action-button primary-button" onclick="window.requestWithdraw()">Confirm</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="support-modal">
    <div class="modal-content">
        <div class="modal-header"><h3>Contact Support</h3></div>
        <div class="modal-body">
            <div class="form-group"><label for="support-subject">Subject</label><input type="text" id="support-subject" placeholder="e.g., Problem with withdrawal"></div>
            <div class="form-group"><label for="support-message">Message</label><textarea id="support-message" placeholder="Please describe your issue in detail..."></textarea></div>
        </div>
        <div class="modal-actions">
            <button class="action-button secondary-button" onclick="window.closeModal('support-modal')">Cancel</button>
            <button class="action-button primary-button" onclick="window.submitSupportTicket()">Submit Ticket</button>
        </div>
    </div>
  </div>

  <div class="modal-overlay" id="my-tickets-modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>My Support Tickets</h3>
              <button class="action-button primary-button" onclick="window.openSupportModal()">New Ticket</button>
          </div>
          <div class="modal-body" id="my-tickets-list"></div>
      </div>
  </div>

  <div class="modal-overlay" id="ticket-details-modal">
      <div class="modal-content">
          <div class="modal-header"><h3 id="ticket-details-subject">Ticket Details</h3></div>
          <div class="modal-body">
              <div class="ticket-details-container" id="ticket-details-content"></div>
              <div class="ticket-replies-list" id="ticket-replies-list"></div>
          </div>
          <div class="modal-actions">
              <button class="action-button secondary-button" onclick="window.closeModal('ticket-details-modal')">Close</button>
          </div>
      </div>
  </div>
  
  <div class="modal-overlay" id="task-modal">
    <div class="modal-content">
        <div class="modal-header"><h3 id="task-modal-title">Task</h3></div>
        <div class="modal-body" id="task-modal-body"></div>
        <div class="modal-actions" id="task-modal-actions"></div>
    </div>
  </div>
  
  <div class="modal-overlay" id="notification-modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>Notifications</h3>
          </div>
          <div class="modal-body" id="notification-list-container">
              <div class="notification-list">
              </div>
          </div>
           <div class="modal-actions" style="justify-content: center;">
              <button class="action-button primary-button" style="width: auto; padding: 10px 30px;" onclick="window.closeModal('notification-modal')">Close</button>
          </div>
      </div>
  </div>

  <!-- #### START: NEW QUIZ MODAL #### -->
  <div class="modal-overlay" id="quiz-modal">
    <div class="modal-content">
        <div class="modal-header"><h3 id="quiz-modal-title">Quiz Time!</h3></div>
        <div class="modal-body" id="quiz-modal-body">
            <div id="quiz-question-container" style="display: none;">
                <p id="quiz-progress-text" style="text-align: center; font-weight: bold;"></p>
                <p id="quiz-question-text" style="font-size: 1.1rem; margin-bottom: 20px;"></p>
                <div id="quiz-options-container"></div>
            </div>
            <div id="quiz-result-container" style="display: none; text-align: center;">
                <h4>Quiz Complete!</h4>
                <p id="quiz-result-summary"></p>
                <p id="quiz-total-reward"></p>
            </div>
        </div>
        <div class="modal-actions" id="quiz-modal-actions">
             <button id="quiz-next-btn" class="action-button primary-button" onclick="window.nextQuizQuestion()">Next Question</button>
             <button id="quiz-close-btn" class="action-button secondary-button" onclick="window.closeModal('quiz-modal')" style="display: none;">Close</button>
        </div>
    </div>
  </div>
  <!-- #### END: NEW QUIZ MODAL #### -->


  <div class="timer-notification-overlay" id="timer-notification-overlay"><div class="timer-notification-content" id="timer-notification-content"></div></div>
  <div class="modal-overlay" id="global-notification-modal">
    <div class="modal-content">
        <div class="modal-header"><h3><i class="fa-solid fa-bell" style="color: var(--primary-color); margin-right: 10px;"></i>Admin Notice</h3></div>
        <div class="modal-body"><p id="global-notification-text">This is a notice from the admin.</p></div>
        <div class="modal-actions" style="justify-content: center;"><button class="action-button primary-button" style="width: auto; padding: 10px 30px;" onclick="window.closeModal('global-notification-modal')">OK</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="app-update-modal">
    <div class="modal-content" style="text-align: center;">
        <div class="modal-header" style="justify-content: center;"><h3><i class="fa-solid fa-triangle-exclamation" style="color: var(--status-pending); margin-right: 10px;"></i>Update Required</h3></div>
        <div class="modal-body"><p id="app-update-text">A new version of the app is available. Please restart the bot to apply the update.</p></div>
        <div class="modal-actions" style="justify-content: center;">
            <button class="action-button primary-button" style="width: auto; padding: 10px 30px;" onclick="window.Telegram.WebApp.close()">Restart Bot</button>
        </div>
    </div>
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, update, push, runTransaction, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const bootstrapFirebaseConfig = {
        apiKey: "AIzaSyD5WNVy_CCoQ9cuHWNeTYf0UirKLwIs8hQ",
        authDomain: "the-ramjan-earnings.firebaseapp.com",
        databaseURL: "https://the-ramjan-earnings-default-rtdb.firebaseio.com",
    };

    let app, database, storage;
    let configRef, usersRef, userRef, withdrawRequestsRef, globalNotificationRef, promoCodesRef, supportTicketsRef, taskSubmissionsRef, leaderboardRef, lotteryRef;
    
    let appConfig = {}; 
    let userData = {};
    let lotteryData = {};
    let tgUser = null;
    let isConfigLoaded = false;
    let isUserLoaded = false;
    let isLoginTracked = false;
    let isEarningBlocked = false;
    let isAdScriptLoaded = false;
    const clientVersion = "1.0.0"; 

    let currentHistoryPage = 1;
    const itemsPerPage = 15;
    let currentReferralsPage = 1;
    let allUsersDataForReferrals = {};

    // #### START: NEW FEATURE VARIABLES ####
    let theWheel;
    let wheelSpinning = false;
    let isScratching = false;
    let currentCaptcha = '';
    let currentQuiz = {};
    // #### END: NEW FEATURE VARIABLES ####


    async function bootstrapApp() {
        try {
            const bootstrapApp = initializeApp(bootstrapFirebaseConfig, "bootstrap");
            const bootstrapDb = getDatabase(bootstrapApp);
            const configSnapshot = await get(ref(bootstrapDb, 'app/config'));
            
            if (configSnapshot.exists()) {
                const remoteConfig = configSnapshot.val();
                appConfig = remoteConfig;

                if (appConfig.telegramScript && appConfig.telegramScript.enabled) {
                    const tgScript = document.createElement('script');
                    tgScript.src = 'https://telegram.org/js/telegram-web-app.js';
                    tgScript.async = false;
                    tgScript.onload = () => {
                        console.log("Telegram Web App script loaded.");
                        initializeAppWithConfig(appConfig.firebaseConfig);
                    };
                    document.head.appendChild(tgScript);
                } else {
                    initializeAppWithConfig(appConfig.firebaseConfig);
                }
            } else {
                throw new Error("Critical configuration not found in database.");
            }
        } catch (error) {
            console.error("Bootstrap failed:", error);
            document.getElementById('loading-overlay').innerHTML = `<p>Error: Could not load critical app settings. Please contact support.</p>`;
        }
    }

    function initializeAppWithConfig(firebaseConfig) {
        app = initializeApp(firebaseConfig);
        database = getDatabase(app);
        storage = getStorage(app);

        configRef = ref(database, 'app/config');
        usersRef = ref(database, 'app/users');
        withdrawRequestsRef = ref(database, 'app/withdraw_requests');
        globalNotificationRef = ref(database, 'app/global_notification');
        promoCodesRef = ref(database, 'app/promo_codes');
        supportTicketsRef = ref(database, 'app/support_tickets');
        taskSubmissionsRef = ref(database, 'app/task_submissions');
        leaderboardRef = ref(database, 'app/leaderboard');
        lotteryRef = ref(database, 'app/lottery');
        
        initApp();
    }

    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const iconClass = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-times-circle' : 'fa-info-circle');
        toast.innerHTML = `<span class="icon"><i class="fas ${iconClass}"></i></span> <p>${message}</p>`;
        container.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentElement === container) container.removeChild(toast);
            }, 500);
        }, duration);
    }
    
    document.addEventListener('DOMContentLoaded', () => { bootstrapApp(); });

    async function initApp() {
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            tgUser = Telegram.WebApp.initDataUnsafe.user;
        } else {
            console.warn("Telegram Web App not found. Using mock user.");
            tgUser = { id: 123456789, first_name: 'Test', last_name: 'User', username: 'testuser', photo_url: 'https://i.pravatar.cc/150?u=123456789'};
        }

        if (!tgUser) {
            document.getElementById('loading-overlay').innerHTML = "<p>Error: Could not verify user. Please launch from Telegram.</p>";
            return;
        }

        userRef = ref(database, `app/users/${tgUser.id}`);
        
        isConfigLoaded = true;
        if (checkVersionAndNotice()) return; 
        initializeUser();
        applyTheme(appConfig);
        updateDynamicElements();
        
        onValue(lotteryRef, (snapshot) => {
            lotteryData = snapshot.val() || {};
            if (document.getElementById('lottery-view').classList.contains('active')) {
                renderLottery();
            }
        });
    }
    
    function applyTheme(config) {
        const primaryColor = config.theme?.primaryColor || '#6a11cb';
        const root = document.documentElement;
        root.style.setProperty('--primary-color', primaryColor);
        root.style.setProperty('--gradient-start', primaryColor);
    }

    async function initializeUser() {
        onValue(userRef, async (snapshot) => {
            let justCreated = false;
            if (snapshot.exists()) {
                userData = snapshot.val();
            } else {
                justCreated = true;
                const startParam = window.Telegram?.WebApp?.initDataUnsafe?.start_param;
                let initialBalance = 0; let initialHistory = {};
                if (appConfig.welcomeBonusEnabled && appConfig.welcomeBonus > 0) {
                    initialBalance = appConfig.welcomeBonus;
                    initialHistory[`welcome_${Date.now()}`] = { type: 'manual', amount: initialBalance, title: 'Welcome Bonus', date: new Date().toISOString() };
                }
                const newUser = {
                    profile: { id: tgUser.id, firstName: tgUser.first_name || '', lastName: tgUser.last_name || '', username: tgUser.username || '', photo_url: tgUser.photo_url || '', referredBy: startParam || null },
                    balance: initialBalance, totalEarnings: initialBalance, totalAdsWatched: 0, totalReferralCommission: 0,
                    referralsList: {}, transactionHistory: initialHistory, tasksState: {},
                    checkinState: { streak: 0, lastClaimTimestamp: null },
                    adTracking: { dailyCount: 0, hourlyCount: 0, lastAdTimestamp: null, lastHourlyReset: null },
                    dailyStats: { adsWatched: 0, referralCommission: 0, referrals: 0, lastReset: new Date().toISOString() },
                    leaderboardStats: { score: 0, lastReset: new Date().toISOString() },
                    isBlocked: false, joinedAt: new Date().toISOString(), blockReason: null,
                    xp: 0, level: 1,
                    // #### START: NEW USER STATE ####
                    spinState: { dailyCount: 0, lastSpinDate: null },
                    scratchState: { dailyCount: 0, lastScratchDate: null },
                    watchedVideos: {},
                    quizState: { lastQuizDate: null },
                    captchaState: { dailyCount: 0, lastCaptchaDate: null }
                    // #### END: NEW USER STATE ####
                };
                
                if (startParam) {
                    const referrerRef = ref(database, `app/users/${startParam}`);
                    const referrerSnapshot = await get(referrerRef);
                    if (referrerSnapshot.exists()) {
                        const referrerData = referrerSnapshot.val();
                        const maxReferrals = appConfig.referralControl?.maxReferrals || 0;
                        const currentReferrals = Object.keys(referrerData.referralsList || {}).length;

                        if (maxReferrals > 0 && currentReferrals >= maxReferrals) {
                           newUser.profile.referredBy = null;
                        } else {
                           await set(push(ref(database, `app/users/${startParam}/referralsList`)), { userId: tgUser.id, joinedAt: new Date().toISOString() });
                           
                           // Update referrer's daily stats for referrals
                           const referrerDailyStats = referrerData.dailyStats || {};
                           const isNewDayForReferrer = isNewDay(referrerDailyStats.lastReset);
                           const newDailyReferrals = isNewDayForReferrer ? 1 : (referrerDailyStats.referrals || 0) + 1;
                           const newLastReset = isNewDayForReferrer ? new Date().toISOString() : referrerDailyStats.lastReset;
                           
                           await update(referrerRef, {
                               'dailyStats/referrals': newDailyReferrals,
                               'dailyStats/lastReset': newLastReset
                           });

                           if (appConfig.gamification?.enabled) {
                               const xpForReferral = appConfig.gamification.xpPerReferral || 0;
                               if (xpForReferral > 0) {
                                   const currentXp = referrerData.xp || 0;
                                   await update(referrerRef, { xp: currentXp + xpForReferral });
                               }
                           }
                        }
                    }
                }
                await set(userRef, newUser);
                userData = newUser;
            }
            
            if (userData.isBlocked) {
                const blockedOverlay = document.getElementById('blocked-overlay');
                let reasonHtml = `<h2>Access Denied</h2><p>Your account has been blocked by the administrator.</p>`;
                if (userData.blockReason) {
                    reasonHtml += `<p style="font-size: 14px; color: #ccc; margin-top: 10px; padding: 0 20px;">Reason: ${userData.blockReason}</p>`;
                }
                blockedOverlay.querySelector('div').innerHTML = reasonHtml;
                document.querySelector('.container').style.display = 'none';
                blockedOverlay.style.display = 'flex';
                return;
            }

            if (!isUserLoaded) { 
                isUserLoaded = true; 
                initializeAppUI(); 
            }

            if (!justCreated) {
                await checkAndResetAdLimits();
            }

            await checkVpnStatus(); 
            updateDisplay();
        });
    }

    async function checkVpnStatus() {
        const vpnConfig = appConfig.fraudDetection?.vpnDetection;
        if (!vpnConfig || !vpnConfig.enabled) return;

        try {
            const response = await fetch('https://ip-api.com/json/?fields=status,message,proxy,hosting,query');
            if (!response.ok) return; 
            const data = await response.json();

            if (data.status === 'success' && (data.proxy || data.hosting)) {
                const action = vpnConfig.action || 'warn';
                if (action === 'warn') {
                    showToast("VPN/Proxy usage is discouraged and may affect earnings.", "error", 5000);
                } else if (action === 'block_earning') {
                    isEarningBlocked = true;
                    showToast("Earning features have been disabled due to VPN/Proxy usage.", "error", 5000);
                } else if (action === 'block_account') {
                    document.getElementById('vpn-blocked-overlay').style.display = 'flex';
                    document.querySelector('.container').style.display = 'none';
                }
            }
        } catch (error) {
            console.warn("Could not check VPN status:", error);
        }
    }
    
    async function trackUserLogin() {
        if (isLoginTracked) return; isLoginTracked = true;
        try {
            const response = await fetch('https://api.ipify.org?format=json'); const data = await response.json(); const ip = data.ip;
            await update(userRef, { 'profile/lastLogin': { timestamp: new Date().toISOString(), ip: ip } });
        } catch (error) {
            await update(userRef, { 'profile/lastLogin/timestamp': new Date().toISOString() });
        }
    }

    function listenForNotifications() {
        if (!tgUser) return; const notificationsRef = ref(database, `app/users/${tgUser.id}/notifications`);
        onValue(notificationsRef, (snapshot) => {
            let hasUnread = false;
            if (snapshot.exists()) {
                 snapshot.forEach((childSnapshot) => {
                     const notification = childSnapshot.val();
                     if (notification && !notification.read) {
                         hasUnread = true;
                     }
                 });
            }
            if (hasUnread) {
                document.getElementById('notification-dot').style.display = 'block';
            }
        }, { onlyOnce: true });
    }


    function listenForGlobalNotifications() {
        onValue(globalNotificationRef, (snapshot) => {
            if (snapshot.exists()) {
                const notification = snapshot.val(), lastSeenTimestamp = localStorage.getItem('lastSeenGlobalNotification');
                if (notification.timestamp !== lastSeenTimestamp) {
                    document.getElementById('global-notification-text').textContent = notification.message;
                    document.getElementById('global-notification-modal').classList.add('active');
                    localStorage.setItem('lastSeenGlobalNotification', notification.timestamp);
                    document.getElementById('notification-dot').style.display = 'block';
                }
            }
        });
    }

    function initializeAppUI() {
        loadTelegramUser(); showView('home-view'); initializeEventListeners();
        listenForNotifications(); listenForGlobalNotifications(); trackUserLogin();
        document.getElementById('loading-overlay').style.opacity = '0';
        setTimeout(() => { document.getElementById('loading-overlay').style.display = 'none'; document.querySelector('.container').style.display = 'flex'; }, 500);
    }
    
    function checkVersionAndNotice() {
        if (appConfig.maintenanceMode) {
            document.getElementById('maintenance-overlay').style.display = 'flex';
            document.querySelector('.container').style.display = 'none';
            return true;
        }
        if (appConfig.appVersion && appConfig.appVersion !== clientVersion) {
            const updateText = appConfig.appUpdateMessage || "A new version is available. Please restart the bot to apply the update.";
            document.getElementById('app-update-text').textContent = updateText;
            document.getElementById('app-update-modal').classList.add('active');
            return true; 
        }
        const announcement = appConfig.announcement || ''; const bannerContainer = document.getElementById('announcement-banner-container');
        if (announcement.trim() !== '' && !sessionStorage.getItem('announcement_closed')) { bannerContainer.innerHTML = `<div id="announcement-banner"><span>${announcement}</span><button onclick="window.closeAnnouncement()">&times;</button></div>`; }
        return false;
    }
    window.closeAnnouncement = () => { document.getElementById('announcement-banner').style.display = 'none'; sessionStorage.setItem('announcement_closed', 'true'); };

    function updateDynamicElements() {
        if (!isConfigLoaded) return;

        if (!isAdScriptLoaded && appConfig.libtlZoneId) {
            const zoneId = appConfig.libtlZoneId;
            const script = document.createElement('script');
            script.src = '//libtl.com/sdk.js';
            script.setAttribute('data-zone', zoneId);
            script.setAttribute('data-sdk', `show_${zoneId}`);
            script.async = true;
            document.head.appendChild(script);
            isAdScriptLoaded = true;
        }

        const commissionRate = appConfig.refferBonus || 10;
        document.getElementById('referral-commission-badge').textContent = `${commissionRate}%`;
        document.getElementById('referral-description-p').textContent = `Earn ${commissionRate}% of your friends' earnings for life!`;
        if (appConfig.dynamicText) {
            const shoppingButton = document.getElementById('shopping-button');
            shoppingButton.innerHTML = `${appConfig.dynamicText.shoppingButtonText || 'Start Shopping'} &nbsp; <i class="fa-solid fa-arrow-right"></i>`;
            shoppingButton.href = appConfig.dynamicText.shoppingButtonLink || '#';
        }
        if (appConfig.textStrings) {
            document.querySelector('#nav-home-button .nav-text').textContent = appConfig.textStrings.navHome || 'Home';
            document.querySelector('#nav-earn-button .nav-text').textContent = appConfig.textStrings.navEarn || 'Earn';
            document.querySelector('#nav-refer-button .nav-text').textContent = appConfig.textStrings.navRefer || 'Refer';
            document.querySelector('#nav-profile-button .nav-text').textContent = appConfig.textStrings.navProfile || 'Profile';
            document.getElementById('refer-title').textContent = appConfig.textStrings.referTitle || 'Refer & Earn Forever';
            document.getElementById('refer-link-title').textContent = appConfig.textStrings.referTitle || 'Your Referral Link';
        }
        if (appConfig.uiStrings) {
             document.getElementById('header-balance-label').textContent = appConfig.uiStrings.balanceLabel || 'Balance:';
             document.getElementById('home-total-earnings-label').textContent = appConfig.uiStrings.totalEarningsLabel || 'Total Earnings';
             document.getElementById('home-ads-watched-label').textContent = appConfig.uiStrings.adsWatchedLabel || 'Ads Watched (Total)';
             document.getElementById('home-total-referrals-label').textContent = appConfig.uiStrings.totalReferralsLabel || 'Total Referrals';
             document.getElementById('profile-request-withdrawal-btn').textContent = appConfig.uiStrings.requestWithdrawalBtn || 'Request Withdrawal';
             document.getElementById('profile-transaction-history-btn').textContent = appConfig.uiStrings.transactionHistoryBtn || 'Transaction History';
        }
        const storeNavButton = document.getElementById('nav-store-button');
        if (appConfig.storeEnabled) {
            storeNavButton.style.display = 'flex';
        } else {
            storeNavButton.style.display = 'none';
        }

        document.getElementById('nav-offerwall-button').style.display = appConfig.offerwall?.enabled ? 'flex' : 'none';
        document.getElementById('nav-lottery-button').style.display = appConfig.lottery?.enabled ? 'flex' : 'none';
        
        if (appConfig.leaderboard?.enabled) {
            document.getElementById('leaderboard-section').style.display = 'block';
            renderLeaderboard();
        } else {
            document.getElementById('leaderboard-section').style.display = 'none';
        }
        
        if(appConfig.gamification?.enabled) {
            document.getElementById('xp-progress-section').style.display = 'block';
        } else {
            document.getElementById('xp-progress-section').style.display = 'none';
        }

        renderAdNetworks();
        if (appConfig.dailyCheckinEnabled) { document.getElementById('daily-checkin-section').style.display = 'block'; renderCheckinDays(); } else { document.getElementById('daily-checkin-section').style.display = 'none'; }
        if (appConfig.tasksEnabled) { document.getElementById('tasks-section').style.display = 'block'; renderTasks(); } else { document.getElementById('tasks-section').style.display = 'none'; }
        
        // #### START: RENDER NEW FEATURES DYNAMICALLY ####
        renderSpinWheel();
        renderScratchCard();
        renderVideoZone();
        renderQuizSection();
        renderCaptchaSection();
        // #### END: RENDER NEW FEATURES DYNAMICALLY ####
    }
        
    function isNewDay(timestamp) { if (!timestamp) return true; const today = new Date().setHours(0, 0, 0, 0); const thatDay = new Date(timestamp).setHours(0, 0, 0, 0); return today > thatDay; }
    function isNewHour(timestamp) {
        if (!timestamp) return true;
        const now = new Date();
        const lastReset = new Date(timestamp);
        return now.getHours() !== lastReset.getHours() || now.toDateString() !== lastReset.toDateString();
    }

    async function checkAndResetAdLimits() {
        const updates = {};
        const now = new Date();

        if (isNewDay(userData.dailyStats?.lastReset)) {
            updates['dailyStats'] = { adsWatched: 0, referralCommission: 0, referrals: 0, lastReset: now.toISOString() };
            updates['adTracking/dailyCount'] = 0;
        }

        if (isNewHour(userData.adTracking?.lastHourlyReset)) {
            updates['adTracking/hourlyCount'] = 0;
            updates['adTracking/lastHourlyReset'] = now.toISOString();
        }
        
        if (Object.keys(updates).length > 0) {
            await update(userRef, updates);
        }
    }

    window.showView = (viewId) => {
        if (!isConfigLoaded || !isUserLoaded) return; 
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        document.querySelectorAll('.nav-button').forEach(btn => { btn.classList.remove('active'); if (btn.getAttribute('onclick').includes(viewId)) { btn.classList.add('active'); } });
        if (viewId === 'earn-view') updateDynamicElements(); 
        if (viewId === 'refer-view') { currentReferralsPage = 1; window.renderReferralsList(); updateReferralView(); }
        if (viewId === 'history-view') { currentHistoryPage = 1; renderHistory(); } 
        if (viewId === 'store-view') renderStore();
        if (viewId === 'offerwall-view') renderOfferwall();
        if (viewId === 'lottery-view') renderLottery();
        updateDisplay(); 
    };
    
    function getCurrentUserTier() {
        if (!appConfig.userTiersEnabled || !appConfig.userTiers) return { name: 'Default', bonusPercent: 0 };
        const totalPoints = userData.totalEarnings || 0; let currentTier = appConfig.userTiers[0];
        for (const tier of appConfig.userTiers) { if (totalPoints >= tier.requiredPoints) { currentTier = tier; } else { break; } }
        return currentTier;
    }

    function updateDisplay() {
        if (!isConfigLoaded || !isUserLoaded) return;
        const currencySymbol = appConfig.currency || 'BDT'; const pointsPerCurrency = appConfig.pointsPerCurrency || 100;
        const pointsBalance = userData.balance || 0; const balanceInBdt = pointsBalance / pointsPerCurrency;
        document.getElementById('header-balance').textContent = `${currencySymbol} ${balanceInBdt.toFixed(2)}`;
        
        document.getElementById('home-total-earnings').innerHTML = `<span class="points-value">${pointsBalance.toLocaleString()} Points</span><span class="bdt-value">${currencySymbol} ${balanceInBdt.toFixed(2)}</span>`;
        document.getElementById('home-total-earnings-label').textContent = "Current Balance";

        document.getElementById('home-ads-watched').textContent = userData.totalAdsWatched || 0;
        document.getElementById('home-total-referrals').textContent = userData.referralsList ? Object.keys(userData.referralsList).length : 0;
        document.getElementById('home-total-tasks-completed').textContent = userData.tasksState ? Object.values(userData.tasksState).filter(s => s.completed).length : 0;
        document.getElementById('home-total-commission').textContent = `${userData.totalReferralCommission || 0} Points`;
        const dailyAdsLimit = appConfig.adsLimit || 250, hourlyLimit = appConfig.hourlyAdsLimit || 25;
        const adTracking = userData.adTracking || { dailyCount: 0, hourlyCount: 0 };
        document.querySelectorAll('.ad-network-card').forEach(card => {
            const watchButton = card.querySelector(`.watch-ad-button`);
            if (watchButton) {
                card.querySelector(`.tasks-completed-daily`).textContent = adTracking.dailyCount; card.querySelector(`.tasks-remaining-daily`).textContent = dailyAdsLimit - adTracking.dailyCount;
                card.querySelector(`.progress-bar-inner`).style.width = `${(adTracking.dailyCount / dailyAdsLimit) * 100}%`;
                card.querySelector(`.hourly-limit-value`).textContent = `${adTracking.hourlyCount}/${hourlyLimit}`; card.querySelector(`.daily-limit-value`).textContent = `${adTracking.dailyCount}/${dailyAdsLimit}`;
                if (adTracking.dailyCount >= dailyAdsLimit) { watchButton.disabled = true; watchButton.innerHTML = `<i class="fa-solid fa-check"></i> Daily Limit`; }
                else if (adTracking.hourlyCount >= hourlyLimit) { watchButton.disabled = true; watchButton.innerHTML = `<i class="fa-solid fa-clock"></i> Hourly Limit`; }
                else { watchButton.disabled = false; watchButton.innerHTML = `<i class="fa-solid fa-play-circle"></i> Watch Ad & Earn`; }
            }
        });
        document.getElementById('refer-today-commission').textContent = `${userData.dailyStats?.referralCommission || 0} Points`;
        document.getElementById('refer-today-referrals').textContent = userData.dailyStats?.referrals || 0;

        document.getElementById('profile-balance').innerHTML = `${pointsBalance.toLocaleString()} Points <span class="bdt-value">${currencySymbol} ${balanceInBdt.toFixed(2)}</span>`;
        document.getElementById('profile-total-earnings').innerHTML = `${(userData.totalEarnings || 0).toLocaleString()} Points <span class="bdt-value">${((userData.totalEarnings || 0) / pointsPerCurrency).toFixed(2)} ${currencySymbol}</span>`;
        document.getElementById('profile-ads-watched').textContent = userData.totalAdsWatched || 0;
        document.getElementById('profile-referrals').textContent = userData.referralsList ? Object.keys(userData.referralsList).length : 0;
        document.getElementById('profile-total-commission').textContent = `${userData.totalReferralCommission || 0} Points`;
        const tier = getCurrentUserTier(); const tierBadge = document.getElementById('profile-tier-badge'); const tierInfoItem = document.getElementById('profile-tier-info-item');
        if (appConfig.userTiersEnabled && tier) {
            tierBadge.textContent = tier.name; tierBadge.className = `tier-badge ${tier.name.toLowerCase()}`;
            document.getElementById('profile-tier-value').textContent = `${tier.name} (${tier.bonusPercent}% Bonus)`; tierInfoItem.style.display = 'flex';
        } else { tierBadge.textContent = ''; tierInfoItem.style.display = 'none'; }
        
        if (appConfig.gamification?.enabled) {
            const currentLevel = userData.level || 1;
            const currentXp = userData.xp || 0;
            const levels = appConfig.gamification.levels || [];
            
            const levelInfo = levels.find(l => l.level === currentLevel) || { xp: 0 };
            const nextLevelInfo = levels.find(l => l.level === currentLevel + 1);

            document.getElementById('profile-level-badge').textContent = `LVL ${currentLevel}`;
            document.getElementById('profile-level-badge').style.display = 'inline-block';
            document.getElementById('profile-level-text').textContent = `Level ${currentLevel}`;

            if (nextLevelInfo) {
                const xpForNextLevel = nextLevelInfo.xp - levelInfo.xp;
                const currentXpInLevel = currentXp - levelInfo.xp;
                const progressPercent = (currentXpInLevel / xpForNextLevel) * 100;
                document.getElementById('profile-xp-text').textContent = `${currentXpInLevel.toLocaleString()} / ${xpForNextLevel.toLocaleString()} XP`;
                document.getElementById('profile-xp-progress-bar').style.width = `${Math.min(100, progressPercent)}%`;
            } else {
                document.getElementById('profile-xp-text').textContent = "Max Level Reached";
                document.getElementById('profile-xp-progress-bar').style.width = '100%';
            }
        } else {
             document.getElementById('profile-level-badge').style.display = 'none';
        }
    }

    function loadTelegramUser() {
        if (tgUser && userData.profile) {
            let { firstName, lastName, username, photo_url } = userData.profile;
            const userName = firstName || 'User'; document.getElementById('header-username').textContent = userName;
            
            if (!photo_url && tgUser.photo_url) {
                update(userRef, { 'profile/photo_url': tgUser.photo_url });
                photo_url = tgUser.photo_url;
            }

            const headerAvatar = document.getElementById('header-avatar-placeholder');
            const avatarUrl = photo_url || appConfig.assets?.defaultAvatar || `https://i.pravatar.cc/150?u=${tgUser.id}`;
            headerAvatar.innerHTML = `<img src="${avatarUrl}" alt="A">`;
            if (appConfig.dynamicText && appConfig.dynamicText.welcomeMessageTemplate) { document.getElementById('welcome-message').textContent = appConfig.dynamicText.welcomeMessageTemplate.replace('{name}', userName); } else { document.getElementById('welcome-message').textContent = `Welcome, ${userName}!`; }
            document.querySelector('#profile-name').firstChild.nodeValue = `${firstName || ''} ${lastName || ''}`.trim() + ' ';
            document.getElementById('profile-username').textContent = username ? `@${username}` : 'No username';
            document.getElementById('profile-avatar').src = avatarUrl;
            document.getElementById('referral-link-input').value = `https://t.me/${appConfig.botUsername || "YourBot"}?start=${tgUser.id}`;
        }
    }

    async function grantMultiLevelCommission(basePointsEarned, earningUserId, level = 1) {
        if (level > 3) return; 

        const earningUserSnapshot = await get(ref(database, `app/users/${earningUserId}`));
        if (!earningUserSnapshot.exists()) return;
        const earningUserData = earningUserSnapshot.val();
        
        const referrerId = earningUserData.profile?.referredBy;
        if (!referrerId) return;

        const activationRequirement = appConfig.referralControl?.commissionActivation?.adsWatched || 0;
        if (level === 1 && activationRequirement > 0 && (earningUserData.totalAdsWatched || 0) < activationRequirement) {
            return;
        }

        let commissionRate = 0;
        const multiLevelConfig = appConfig.referralControl?.multiLevel;
        
        if (level === 1) {
            commissionRate = (appConfig.refferBonus || 0) / 100;
        } else if (multiLevelConfig?.enabled) {
            if (level === 2) commissionRate = (multiLevelConfig.level2_commission || 0) / 100;
            if (level === 3) commissionRate = (multiLevelConfig.level3_commission || 0) / 100;
        }

        if (commissionRate > 0) {
            const commissionAmount = Math.floor(basePointsEarned * commissionRate);
            if (commissionAmount > 0) {
                const referrerRef = ref(database, `app/users/${referrerId}`);
                const referrerSnapshot = await get(referrerRef);
                if (referrerSnapshot.exists()) {
                    const referrerData = referrerSnapshot.val();
                    
                    const isNewDayForReferrer = isNewDay(referrerData.dailyStats?.lastReset);
                    const newDailyCommission = isNewDayForReferrer ? commissionAmount : (referrerData.dailyStats?.referralCommission || 0) + commissionAmount;

                    const updates = {
                        'balance': (referrerData.balance || 0) + commissionAmount,
                        'totalReferralCommission': (referrerData.totalReferralCommission || 0) + commissionAmount,
                        'totalEarnings': (referrerData.totalEarnings || 0) + commissionAmount,
                        'dailyStats/referralCommission': newDailyCommission
                    };

                    if (isNewDayForReferrer) {
                         updates['dailyStats/lastReset'] = new Date().toISOString();
                         updates['dailyStats/adsWatched'] = 0; 
                         updates['dailyStats/referrals'] = 0;
                    }

                    updates[`transactionHistory/ref_${Date.now()}`] = {
                        type: 'referral',
                        amount: commissionAmount,
                        title: `Level ${level} Commission from ${earningUserData.profile.firstName || 'user'}`,
                        date: new Date().toISOString()
                    };
                    await update(referrerRef, updates);
                    
                    await grantMultiLevelCommission(basePointsEarned, referrerId, level + 1);
                }
            }
        }
    }
    
    async function grantXpAndCheckLevelUp(actionType) {
        if (!appConfig.gamification?.enabled) return;
        
        const xpConfig = appConfig.gamification;
        let xpToGrant = 0;
        switch (actionType) {
            case 'ad': xpToGrant = xpConfig.xpPerAd || 0; break;
            case 'task': xpToGrant = xpConfig.xpPerTask || 0; break;
            case 'checkin': xpToGrant = xpConfig.xpPerCheckin || 0; break;
        }
        
        if (xpToGrant <= 0) return;

        const newXp = (userData.xp || 0) + xpToGrant;
        await update(userRef, { xp: newXp });
        userData.xp = newXp;

        const currentLevel = userData.level || 1;
        const nextLevelInfo = (xpConfig.levels || []).find(l => l.level === currentLevel + 1);

        if (nextLevelInfo && newXp >= nextLevelInfo.xp) {
            const bonus = nextLevelInfo.bonus || xpConfig.levelUpBonus || 0;
            
            const updates = {
                level: currentLevel + 1,
                balance: (userData.balance || 0) + bonus,
                totalEarnings: (userData.totalEarnings || 0) + bonus
            };
            updates[`transactionHistory/levelup_${Date.now()}`] = { type: 'manual', amount: bonus, title: `Level Up to ${currentLevel + 1}!`, date: new Date().toISOString() };
            
            await update(userRef, updates);
            
            const overlay = document.getElementById('timer-notification-overlay');
            overlay.style.display = 'flex';
            overlay.querySelector('.timer-notification-content').innerHTML = `<div class="icon" style="color: var(--level-color);"><i class="fa-solid fa-star"></i></div><div>Level Up! You are now Level ${currentLevel + 1}</div>`;
            setTimeout(() => { overlay.style.display = 'none'; }, 3500);
        }
    }
    
    async function grantReward(adNetworkName, baseRewardPoints) {
        const tier = getCurrentUserTier(), bonusPoints = Math.floor(baseRewardPoints * (tier.bonusPercent / 100));
        const totalReward = baseRewardPoints + bonusPoints; const transactionTitle = bonusPoints > 0 ? `${adNetworkName} Ad Reward (+${bonusPoints} bonus)` : `${adNetworkName} Ad Reward`;
        
        const updates = {
            'balance': (userData.balance || 0) + totalReward, 
            'totalEarnings': (userData.totalEarnings || 0) + totalReward, 
            'totalAdsWatched': (userData.totalAdsWatched || 0) + 1,
            'dailyStats/adsWatched': (userData.dailyStats?.adsWatched || 0) + 1, 
            'adTracking/dailyCount': (userData.adTracking?.dailyCount || 0) + 1,
            'adTracking/hourlyCount': (userData.adTracking?.hourlyCount || 0) + 1, 
            'adTracking/lastAdTimestamp': new Date().toISOString(),
            'leaderboardStats/score': (userData.leaderboardStats?.score || 0) + totalReward
        };
        updates[`transactionHistory/earn_${Date.now()}`] = { type: 'earning', amount: totalReward, title: transactionTitle, date: new Date().toISOString() };
        
        await update(userRef, updates);
        await grantMultiLevelCommission(baseRewardPoints, tgUser.id);
        await grantXpAndCheckLevelUp('ad');
        
        if (window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
    
    window.startAdCycle = () => {
        if (isEarningBlocked) { return showToast("Earning is disabled due to network policy.", "error"); }

        const adConfig = appConfig.adSystemConfig?.primaryAd;
        if (!adConfig || !adConfig.enabled) {
            return showToast("This earning method is temporarily unavailable.", "info");
        }
        
        const adTracking = userData.adTracking || { dailyCount: 0, hourlyCount: 0 };
        if (adTracking.dailyCount >= (appConfig.adsLimit || 250) || adTracking.hourlyCount >= (appConfig.hourlyAdsLimit || 25)) return;
        
        const overlay = document.getElementById('timer-notification-overlay'), overlayContent = document.getElementById('timer-notification-content');
        
        const adTimerSeconds = adConfig.timer || 30;
        
        const adFunctionName = `show_${appConfig.libtlZoneId}`;
        if (typeof window[adFunctionName] === 'function') {
            window[adFunctionName]().catch(e => console.error("Ad SDK error:", e));
        } else {
            console.warn(`Ad SDK function '${adFunctionName}' not found. Please check if the ad script loaded correctly.`);
            showToast("Ad service is currently unavailable. Please try again later.", "error");
            return;
        }

        overlay.style.display = 'flex'; let countdown = adTimerSeconds;
        overlayContent.innerHTML = `<div class="icon"><i class="fa-solid fa-hourglass-half"></i></div><div>${countdown}</div>`;
        const intervalId = setInterval(() => { countdown--; overlayContent.innerHTML = `<div class="icon"><i class="fa-solid fa-hourglass-half"></i></div><div>${countdown}</div>`; if (countdown <= 0) clearInterval(intervalId); }, 1000);
        
        setTimeout(async () => {
            clearInterval(intervalId);
            let rewardPoints = adConfig.reward || 1;
            
            const totalRewardWithBonus = rewardPoints + Math.floor(rewardPoints * (getCurrentUserTier().bonusPercent / 100));
            await grantReward("Primary", rewardPoints);
            overlayContent.innerHTML = `<div class="icon" style="color: var(--status-success);"><i class="fa-solid fa-check-circle"></i></div><div>+${totalRewardWithBonus} Points!</div>`;
            setTimeout(() => { overlay.style.display = 'none'; }, 2500);
        }, adTimerSeconds * 1000);
    };

    async function triggerRewardedAd() {
        const rewardedConfig = appConfig.adSystemConfig?.rewardedAd;
        if (!rewardedConfig || !rewardedConfig.enabled) return;

        showToast("Watch a short ad to get an extra bonus!", "info");

        const overlay = document.getElementById('timer-notification-overlay');
        const overlayContent = document.getElementById('timer-notification-content');
        const adTimerSeconds = rewardedConfig.timer || 20;

        const adFunctionName = `show_${appConfig.libtlZoneId}`;
        if (typeof window[adFunctionName] === 'function') {
            window[adFunctionName]().catch(e => console.error("Ad SDK error:", e));
        } else {
            console.warn(`Ad SDK function '${adFunctionName}' not found.`);
            return;
        }

        overlay.style.display = 'flex';
        let countdown = adTimerSeconds;
        overlayContent.innerHTML = `<div class="icon"><i class="fa-solid fa-hourglass-half"></i></div><div>${countdown}</div>`;
        const intervalId = setInterval(() => { countdown--; overlayContent.innerHTML = `<div class="icon"><i class="fa-solid fa-hourglass-half"></i></div><div>${countdown}</div>`; if (countdown <= 0) clearInterval(intervalId); }, 1000);

        setTimeout(async () => {
            clearInterval(intervalId);
            let baseRewardPoints = rewardedConfig.reward || 0;
            
            await grantReward('Rewarded Task', baseRewardPoints); 

            const totalRewardWithBonus = baseRewardPoints + Math.floor(baseRewardPoints * (getCurrentUserTier().bonusPercent / 100));
            overlayContent.innerHTML = `<div class="icon" style="color: var(--status-success);"><i class="fa-solid fa-check-circle"></i></div><div>Extra Bonus: +${totalRewardWithBonus} Points!</div>`;
            setTimeout(() => { overlay.style.display = 'none'; }, 2500);
        }, adTimerSeconds * 1000);
    }

    async function claimSimpleTask(task) {
        let reward = task.reward;
        const tier = getCurrentUserTier();
        const bonusPoints = Math.floor(reward * (tier.bonusPercent / 100));
        const totalReward = reward + bonusPoints;
        const transactionTitle = bonusPoints > 0 ? `Task: ${task.title} (+${bonusPoints} bonus)` : `Task: ${task.title}`;

        const updates = {
            'balance': (userData.balance || 0) + totalReward,
            'totalEarnings': (userData.totalEarnings || 0) + totalReward,
            'leaderboardStats/score': (userData.leaderboardStats?.score || 0) + totalReward,
            [`tasksState/${task.id}/completed`]: true,
            [`tasksState/${task.id}/pendingClaim`]: false
        };
        updates[`transactionHistory/task_${Date.now()}`] = { type: 'task', amount: totalReward, title: transactionTitle, date: new Date().toISOString() };
        await update(userRef, updates);
        await grantMultiLevelCommission(reward, tgUser.id);
        await grantXpAndCheckLevelUp('task');
        
        const overlay = document.getElementById('timer-notification-overlay');
        overlay.style.display = 'flex';
        overlay.querySelector('.timer-notification-content').innerHTML = `<div class="icon" style="color: var(--status-task);"><i class="fa-solid fa-check-double"></i></div><div>+${totalReward} Points!</div>`;
        setTimeout(() => { overlay.style.display = 'none'; }, 2500);

        const rewardedConfig = appConfig.adSystemConfig?.rewardedAd;
        if (rewardedConfig && rewardedConfig.enabled && rewardedConfig.triggerOnTaskCompletion) {
            setTimeout(() => {
                triggerRewardedAd();
            }, 2600);
        }
    }

    function renderCheckinDays() {
        const timelineContainer = document.getElementById('checkin-timeline-container'),
              claimButton = document.getElementById('claim-checkin-button');
        const checkinRewards = appConfig.dailyCheckinRewards || [];
        if (!timelineContainer || !claimButton || checkinRewards.length === 0) return;

        const { streak = 0, lastClaimTimestamp = null } = userData.checkinState || {};
        const canClaimToday = isNewDay(lastClaimTimestamp);
        let isClaimable = false, claimableReward = 0;

        timelineContainer.innerHTML = checkinRewards.map((dayInfo, index) => {
            const reward = dayInfo.reward;
            let status = 'locked', icon = '🎁';
            if (index < streak) {
                status = 'claimed'; icon = '<i class="fa-solid fa-check"></i>';
            } else if (index === streak && canClaimToday) {
                status = 'claimable'; icon = '<i class="fa-solid fa-gift"></i>';
                isClaimable = true;
                claimableReward = reward;
            }
            return `<div class="day-item ${status}"><div class="day-content"><div class="day-circle">${icon}</div><div class="day-reward">${reward} Points</div><div class="day-number">Day ${index + 1}</div></div></div>`;
        }).join('');
        
        const hourlyLimit = appConfig.hourlyAdsLimit || 25;
        const hourlyCount = userData.adTracking?.hourlyCount || 0;
        const hourlyLimitMet = hourlyCount >= hourlyLimit;

        if (isClaimable) {
            if (hourlyLimitMet) {
                claimButton.innerHTML = `<i class="fa-solid fa-gift"></i> Claim ${claimableReward} Points`;
                claimButton.disabled = false;
            } else {
                const remainingAds = hourlyLimit - hourlyCount;
                claimButton.innerHTML = `<i class="fa-solid fa-play-circle"></i> Watch ${remainingAds} more ads`;
                claimButton.disabled = true;
            }
        } else if (streak >= checkinRewards.length) {
            claimButton.innerHTML = `<i class="fa-solid fa-check-circle"></i> Cycle Complete`;
            claimButton.disabled = true;
        } else {
            claimButton.innerHTML = `<i class="fa-solid fa-clock"></i> Come back tomorrow`;
            claimButton.disabled = true;
        }
    }


    function initializeEventListeners() {
        document.getElementById('claim-checkin-button').addEventListener('click', async () => {
            if (isEarningBlocked) { return showToast("Earning is disabled due to network policy.", "error"); }
            const hourlyLimit = appConfig.hourlyAdsLimit || 25;
            const hourlyCount = userData.adTracking?.hourlyCount || 0;
            if (hourlyCount < hourlyLimit) {
                return showToast(`You need to watch ${hourlyLimit - hourlyCount} more ads this hour to claim.`, "error");
            }

            const checkinRewards = appConfig.dailyCheckinRewards || []; const { streak = 0, lastClaimTimestamp = null } = userData.checkinState || {};
            if (streak < checkinRewards.length && isNewDay(lastClaimTimestamp)) {
                const dayInfo = checkinRewards[streak]; if (!dayInfo) return;
                let reward = dayInfo.reward;
                const tier = getCurrentUserTier(), bonusPoints = Math.floor(reward * (tier.bonusPercent / 100)), totalReward = reward + bonusPoints;
                const transactionTitle = bonusPoints > 0 ? `Daily Check-in: Day ${streak + 1} (+${bonusPoints} bonus)` : `Daily Check-in: Day ${streak + 1}`;
                
                const updates = {
                    'balance': (userData.balance || 0) + totalReward, 
                    'totalEarnings': (userData.totalEarnings || 0) + totalReward,
                    'checkinState/streak': streak + 1, 
                    'checkinState/lastClaimTimestamp': new Date().getTime(),
                    'leaderboardStats/score': (userData.leaderboardStats?.score || 0) + totalReward
                };
                updates[`transactionHistory/checkin_${Date.now()}`] = { type: 'login', amount: totalReward, title: transactionTitle, date: new Date().toISOString() };
                await update(userRef, updates);
                await grantMultiLevelCommission(reward, tgUser.id);
                await grantXpAndCheckLevelUp('checkin');
                const overlay = document.getElementById('timer-notification-overlay'); overlay.style.display = 'flex';
                overlay.querySelector('.timer-notification-content').innerHTML = `<div class="icon" style="color: var(--status-login);"><i class="fa-solid fa-calendar-check"></i></div><div>+${totalReward} Points!</div>`;
                setTimeout(() => { overlay.style.display = 'none'; }, 2500);
            }
        });
        document.getElementById('withdraw-amount').addEventListener('input', updateWithdrawSummary);
    }

    function renderAdNetworks() {
        const container = document.getElementById('ad-networks-container');
        if (!appConfig.adSystemConfig?.primaryAd?.enabled) {
            container.innerHTML = "";
            return;
        }
        
        const hourlyLimit = appConfig.hourlyAdsLimit || 25;
        const dailyLimit = appConfig.adsLimit || 250;
        
        container.innerHTML = `
            <div class="ad-network-card">
                <div class="card progress-card" style="margin-bottom: 12px;">
                    <h3>Watch Ads</h3>
                    <div class="progress-info">
                        <span>Completed: <span class="tasks-completed-daily">0</span></span>
                        <span>Remaining: <span class="tasks-remaining-daily">${dailyLimit}</span></span>
                    </div>
                    <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                    <div class="limits-grid">
                        <div class="limit-card">
                            <div class="icon"><i class="fa-solid fa-clock"></i></div>
                            <h3 class="value hourly-limit-value">0/${hourlyLimit}</h3>
                            <p class="label">Hourly Limit</p>
                        </div>
                        <div class="limit-card">
                            <div class="icon"><i class="fa-solid fa-calendar-day"></i></div>
                            <h3 class="value daily-limit-value">0/${dailyLimit}</h3>
                            <p class="label">Daily Limit</p>
                        </div>
                    </div>
                    <button class="action-button primary-button watch-ad-button" onclick="window.startAdCycle()">
                        <i class="fa-solid fa-play-circle"></i> Watch Ad & Earn
                    </button>
                </div>
            </div>`;
    }

    
    function renderTasks() {
        const container = document.getElementById('tasks-container');
        const tasks = appConfig.tasks || [];
        if (!container || tasks.length === 0) return;

        container.innerHTML = tasks.filter(t => t.enabled).map(task => {
            const taskState = userData.tasksState?.[task.id] || {};
            let buttonHTML;
            let description = `${task.reward} points reward`;

            if (taskState.completed) {
                buttonHTML = `<button class="task-button completed" disabled><i class="fa-solid fa-check"></i> Completed</button>`;
            } else if (taskState.pendingReview) {
                buttonHTML = `<button class="task-button" disabled>Pending Review</button>`;
            } else if (taskState.pendingClaim) {
                buttonHTML = `<button class="task-button" onclick="window.handleTaskClick(${task.id})">Claim Reward</button>`;
            } else {
                let actionText = 'Start Task';
                if (task.type === 'join_claim') actionText = 'Join & Claim';
                if (task.type === 'screenshot') actionText = 'Submit Proof';
                if (task.type === 'question_answer') actionText = 'Answer Question';
                if (task.type === 'watch_ads_claim') {
                    const adsWatched = userData.totalAdsWatched || 0;
                    const requiredAds = task.requiredAds || 0;
                    if (adsWatched >= requiredAds) {
                        actionText = 'Claim Reward';
                    } else {
                        actionText = 'Watch Ads';
                        description = `Watch ${requiredAds - adsWatched} more ads`;
                    }
                }
                buttonHTML = `<button class="task-button" onclick="window.handleTaskClick(${task.id})">${actionText}</button>`;
            }

            const iconHTML = task.iconUrl ? `<img src="${task.iconUrl}" alt="icon">` : '<i class="fa-solid fa-tasks"></i>';

            return `
            <div class="card task-card">
                <div class="task-info">
                    <div class="task-icon">${iconHTML}</div>
                    <div>
                        <h4>${task.title}</h4>
                        <p>${description}</p>
                    </div>
                </div>
                ${buttonHTML}
            </div>`;
        }).join('');
    }
    
    window.handleTaskClick = async (taskId) => {
        if (isEarningBlocked) { return showToast("Earning is disabled due to network policy.", "error"); }
        const task = (appConfig.tasks || []).find(t => t.id === taskId);
        const taskState = userData.tasksState?.[taskId] || {};
        if (!task || taskState.completed || taskState.pendingReview) return;

        if (task.type === 'join_claim') {
            if (taskState.pendingClaim) {
                await claimSimpleTask(task);
            } else {
                if (window.Telegram?.WebApp) Telegram.WebApp.openTelegramLink(task.link);
                else window.open(task.link, "_blank");
                await update(userRef, { [`tasksState/${taskId}/pendingClaim`]: true });
                showToast('After joining, come back and click "Claim Reward".', 'info');
            }
        } else if (task.type === 'screenshot') {
            openScreenshotTaskModal(task);
        } else if (task.type === 'question_answer') {
            openQATaskModal(task);
        } else if (task.type === 'watch_ads_claim') {
            const adsWatched = userData.totalAdsWatched || 0;
            const requiredAds = task.requiredAds || 0;
            if (adsWatched >= requiredAds) {
                await claimSimpleTask(task);
            } else {
                showToast(`You need to watch ${requiredAds - adsWatched} more ads to claim this reward.`, 'info');
                window.showView('earn-view');
            }
        }
    };
    
    function openScreenshotTaskModal(task) {
        document.getElementById('task-modal-title').textContent = task.title;
        document.getElementById('task-modal-body').innerHTML = `
            <p>${task.description}</p>
            <div class="form-group">
                <label for="screenshot-upload">Upload your screenshot:</label>
                <input type="file" id="screenshot-upload" accept="image/*">
            </div>
            <p id="upload-status" style="display:none; font-weight: bold;"></p>
        `;
        document.getElementById('task-modal-actions').innerHTML = `
            <button class="action-button secondary-button" onclick="window.closeModal('task-modal')">Cancel</button>
            <button id="submit-screenshot-btn" class="action-button primary-button" onclick="window.submitScreenshot(${task.id})">Submit</button>
        `;
        openModal('task-modal');
    }
    
    window.submitScreenshot = async (taskId) => {
        const fileInput = document.getElementById('screenshot-upload');
        const file = fileInput.files[0];
        if (!file) return showToast("Please select a file to upload.", "error");

        const statusP = document.getElementById('upload-status');
        const submitBtn = document.getElementById('submit-screenshot-btn');
        statusP.style.display = 'block';
        statusP.textContent = 'Uploading...';
        submitBtn.disabled = true;

        const filePath = `screenshots/${tgUser.id}/${taskId}_${Date.now()}`;
        const fileRef = storageRef(storage, filePath);

        try {
            const snapshot = await uploadBytes(fileRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            
            const task = appConfig.tasks.find(t => t.id === taskId);
            const submission = {
                userId: tgUser.id,
                taskId: taskId,
                taskTitle: task.title,
                screenshotUrl: downloadURL,
                timestamp: new Date().toISOString(),
                status: 'pending'
            };
            
            await push(taskSubmissionsRef, submission);
            await update(userRef, { [`tasksState/${taskId}/pendingReview`]: true });

            statusP.textContent = 'Submission successful! Please wait for review.';
            statusP.style.color = 'var(--status-success)';
            setTimeout(() => {
                closeModal('task-modal');
                renderTasks();
            }, 2000);

        } catch (error) {
            console.error("Upload failed:", error);
            statusP.textContent = 'Upload failed. Please try again.';
            statusP.style.color = 'var(--status-failed)';
            submitBtn.disabled = false;
        }
    };
    
    function openQATaskModal(task) {
        document.getElementById('task-modal-title').textContent = task.title;
        document.getElementById('task-modal-body').innerHTML = `
            <p>${task.question}</p>
            <div class="form-group">
                <label for="task-answer">Your Answer:</label>
                <input type="text" id="task-answer" placeholder="Enter your answer">
            </div>
        `;
        document.getElementById('task-modal-actions').innerHTML = `
            <button class="action-button secondary-button" onclick="window.closeModal('task-modal')">Cancel</button>
            <button class="action-button primary-button" onclick="window.submitAnswer(${task.id})">Submit Answer</button>
        `;
        openModal('task-modal');
    }

    window.submitAnswer = async (taskId) => {
        const task = (appConfig.tasks || []).find(t => t.id === taskId);
        const userAnswer = document.getElementById('task-answer').value;

        if (userAnswer.trim() === task.answer) {
            await claimSimpleTask(task);
            closeModal('task-modal');
        } else {
            showToast("Incorrect answer. Please try again.", "error");
        }
    };
    
    window.redeemPromoCode = async () => {
        if (isEarningBlocked) { return showToast("This feature is temporarily unavailable.", "error"); }
        const code = prompt("Please enter your promo code:"); if (!code || code.trim() === '') return;
        const trimmedCode = code.trim().toUpperCase(); const codeRef = ref(database, `app/promo_codes/${trimmedCode}`);
        try {
            const transactionResult = await runTransaction(codeRef, (codeData) => {
                if (!codeData) { return; } 
                if ((codeData.timesUsed || 0) >= codeData.usageLimit) { throw new Error("expired"); }
                if (codeData.users && codeData.users[tgUser.id]) { throw new Error("used"); }
                codeData.timesUsed = (codeData.timesUsed || 0) + 1;
                if (!codeData.users) codeData.users = {};
                codeData.users[tgUser.id] = true;
                return codeData;
            });

            if (!transactionResult.committed) {
                return showToast("Invalid or already used promo code.", "error");
            }
            const reward = transactionResult.snapshot.val().reward;
            const updates = { 
                'balance': (userData.balance || 0) + reward,
                'totalEarnings': (userData.totalEarnings || 0) + reward,
                'leaderboardStats/score': (userData.leaderboardStats?.score || 0) + reward
            };
            updates[`transactionHistory/promo_${Date.now()}`] = { type: 'manual', amount: reward, title: `Promo Code: ${trimmedCode}`, date: new Date().toISOString() };
            await update(userRef, updates);
            showToast(`Success! You have received ${reward} points.`, "success");

        } catch (error) {
            if (error.message === 'expired') { showToast("This promo code has expired.", "error"); }
            else if (error.message === 'used') { showToast("You have already used this promo code.", "error"); }
            else { showToast("An error occurred.", "error"); }
        }
    };

    window.openModal = (modalId) => document.getElementById(modalId).classList.add('active');
    window.closeModal = (modalId) => document.getElementById(modalId).classList.remove('active');

    window.openWithdrawModal = () => {
        if (!appConfig.withdrawalMethodsEnabled) return showToast("Withdrawals are temporarily disabled.", "info");
        const container = document.getElementById('payment-method-selector-container');
        const methods = (appConfig.withdrawalMethods || []).filter(m => m.enabled);
        container.innerHTML = methods.length === 0 ? "<p>No payment methods available.</p>" : methods.map(method => `<div><input type="radio" id="method-${method.name.toLowerCase()}" name="payment-method" value="${method.name}"><label for="method-${method.name.toLowerCase()}" class="payment-method-label"><img src="${method.logo}" alt="${method.name}"><span>${method.bn_name}</span></label></div>`).join('');
        document.querySelectorAll('.currency-symbol-modal').forEach(el => el.textContent = appConfig.currency || 'BDT');
        document.getElementById('withdraw-amount').value = '';
        updateWithdrawSummary();
        openModal('withdraw-modal');
    };
    
    function updateWithdrawSummary() {
        const amountInput = document.getElementById('withdraw-amount');
        const summaryDiv = document.getElementById('withdraw-summary');
        const amount = parseFloat(amountInput.value);
        const feePercent = appConfig.withdrawalFeePercent || 0;
        const currency = appConfig.currency || 'BDT';

        if (isNaN(amount) || amount <= 0) {
            summaryDiv.style.display = 'none';
            return;
        }

        const fee = (amount * feePercent) / 100;
        const receivableAmount = amount - fee;

        summaryDiv.innerHTML = `
            <p><span>Amount:</span> <span>${amount.toFixed(2)} ${currency}</span></p>
            <p><span>Fee (${feePercent}%):</span> <span>-${fee.toFixed(2)} ${currency}</span></p>
            <hr style="margin: 5px 0;">
            <p><strong>You will receive:</strong> <strong>${receivableAmount.toFixed(2)} ${currency}</strong></p>
        `;
        summaryDiv.style.display = 'block';
    }

    function getErrorMessage(key, params = {}) {
        let message = appConfig.textStrings?.errorMessages?.[key] || "An error occurred.";
        for (const param in params) {
            message = message.replace(`{${param}}`, params[param]);
        }
        return message;
    }

    window.requestWithdraw = async () => {
        const currencySymbol = appConfig.currency || 'BDT';
        const pointsPerCurrency = appConfig.pointsPerCurrency || 100;
        const minReferrals = appConfig.minReferralsForWithdrawal || 3;
        
        const userTier = getCurrentUserTier();
        const minWithdraw = userTier.minWithdraw || appConfig.minWithdraw || 500;
        const dailyLimit = userTier.dailyWithdrawLimit || 0;

        if ((userData.referralsList ? Object.keys(userData.referralsList).length : 0) < minReferrals) {
            return showToast(getErrorMessage('minReferrals', { count: minReferrals }), "error");
        }
        
        const balanceInBdt = (userData.balance || 0) / pointsPerCurrency;
        const selectedMethodEl = document.querySelector('input[name="payment-method"]:checked');
        const method = selectedMethodEl ? selectedMethodEl.value : null;
        const number = document.getElementById('withdraw-number').value.trim();
        const amountInBdt = parseFloat(document.getElementById('withdraw-amount').value);

        if (!method || !number || isNaN(amountInBdt) || amountInBdt <= 0) {
            return showToast(getErrorMessage('fillAllFields'), "error");
        }
        if (amountInBdt < minWithdraw) {
            return showToast(getErrorMessage('minWithdrawal', { amount: minWithdraw.toFixed(2), currency: currencySymbol }), "error");
        }
        if (amountInBdt > balanceInBdt) {
            return showToast(getErrorMessage('insufficientBalance'), "error");
        }
        
        if (dailyLimit > 0) {
            const today = new Date().setHours(0, 0, 0, 0);
            const history = userData.transactionHistory || {};
            let todaysWithdrawalTotal = 0;
            for (const key in history) {
                const item = history[key];
                if (item.type === 'withdrawal') {
                    const itemDate = new Date(item.date).setHours(0, 0, 0, 0);
                    if (itemDate === today) {
                        todaysWithdrawalTotal += item.amount;
                    }
                }
            }
            if (todaysWithdrawalTotal + amountInBdt > dailyLimit) {
                return showToast(`Your daily withdrawal limit is ${dailyLimit} ${currencySymbol}. You have already withdrawn ${todaysWithdrawalTotal.toFixed(2)} ${currencySymbol} today.`, "error");
            }
        }

        const feePercent = appConfig.withdrawalFeePercent || 0;
        const fee = (amountInBdt * feePercent) / 100;
        const finalAmount = amountInBdt - fee;
        const amountInPoints = amountInBdt * pointsPerCurrency;
        
        const newRequestRef = push(withdrawRequestsRef);
        const newRequest = { userId: tgUser.id, method, number, amount: finalAmount, requestedAmount: amountInBdt, fee: fee, date: new Date().toISOString(), status: 'Pending' };
        await set(newRequestRef, newRequest);

        const updates = { 'balance': (userData.balance || 0) - amountInPoints };
        updates[`transactionHistory/${newRequestRef.key}`] = { type: 'withdrawal', method, number, amount: amountInBdt, date: newRequest.date, status: 'Pending' };
        await update(userRef, updates);
        
        closeModal('withdraw-modal');
        showToast("Withdrawal request submitted successfully.", "success");
    };
    
    async function renderHistory(page = 1) {
        currentHistoryPage = page;
        const container = document.getElementById('history-list-container');
        const paginationContainer = document.getElementById('history-pagination-container');
        const currencySymbol = appConfig.currency || 'BDT';
        const historyItems = Object.entries(userData.transactionHistory || {}).sort(([,a],[,b]) => new Date(b.date) - new Date(a.date));
        
        if (historyItems.length === 0) {
            container.innerHTML = `<div class="no-history"><i class="fa-solid fa-folder-open"></i><p>No history yet.</p></div>`;
            paginationContainer.innerHTML = '';
            return;
        }

        const totalPages = Math.ceil(historyItems.length / itemsPerPage);
        const startIndex = (page - 1) * itemsPerPage;
        const paginatedItems = historyItems.slice(startIndex, startIndex + itemsPerPage);

        const withdrawRequestsSnapshot = await get(withdrawRequestsRef);
        const allWithdrawals = withdrawRequestsSnapshot.val() || {};

        container.innerHTML = paginatedItems.map(([key, item]) => {
            let dateStr = new Date(item.date).toLocaleString('en-GB'); let iconClass, itemHTML;
            switch(item.type) { case 'earning': iconClass = 'fa-solid fa-play'; break; case 'withdrawal': iconClass = 'fa-solid fa-arrow-down'; break; case 'referral': iconClass = 'fa-solid fa-users'; break; case 'login': iconClass = 'fa-solid fa-calendar-check'; break; case 'task': iconClass = 'fa-solid fa-tasks'; break; case 'manual': iconClass = 'fa-solid fa-user-pen'; break; default: iconClass = 'fa-solid fa-question'; break; }
            if (item.type === 'withdrawal') {
                const originalRequest = allWithdrawals[key];
                const status = originalRequest ? originalRequest.status : item.status;
                const txId = originalRequest ? originalRequest.transactionId : null;
                const adminNote = originalRequest ? originalRequest.adminNote : null;
                
                let detailsHTML = `<span class="details">${item.number} &bull; ${dateStr}</span>`;
                if (txId && txId !== 'N/A' || status === 'Rejected') {
                    detailsHTML += `<div class="withdrawal-details">`;
                    if (txId && txId !== 'N/A') {
                        detailsHTML += `<p><strong>TxID:</strong> ${txId}</p>`;
                    }
                    if (status === 'Rejected' && adminNote) {
                        detailsHTML += `<p><strong>Reason:</strong> ${adminNote}</p>`;
                    }
                    detailsHTML += `</div>`;
                }
                itemHTML = `<div class="history-item withdrawal"><div class="icon-wrapper"><i class="${iconClass}"></i></div><div class="history-item-info"><span class="title">Withdraw via ${item.method}</span>${detailsHTML}</div><div class="amount-wrapper"><span class="amount">-${currencySymbol} ${item.amount.toFixed(2)}</span><span class="status status-${status.toLowerCase()}">${status}</span></div></div>`;
            } else {
                let amountStr = item.amount || 0; let amountPrefix = amountStr >= 0 ? '+' : ''; let amountColorClass = amountStr >= 0 ? 'var(--status-success)' : 'var(--status-failed)';
                itemHTML = `<div class="history-item ${item.type}"><div class="icon-wrapper"><i class="${iconClass}"></i></div><div class="history-item-info"><span class="title">${item.title}</span><span class="details">${dateStr}</span></div><div class="amount-wrapper"><span class="amount" style="color: ${amountColorClass};">${amountPrefix}${amountStr.toLocaleString()} Points</span></div></div>`;
            } return itemHTML;
        }).join('');

        renderPaginationControls(paginationContainer, totalPages, page, 'renderHistory');
    }

    function renderStore() {
        const container = document.getElementById('store-packages-container');
        if (!appConfig.storeEnabled || !appConfig.pointPackages || appConfig.pointPackages.length === 0) {
            container.innerHTML = `<div class="no-data"><i class="fa-solid fa-shop-slash"></i><p>The store is currently empty.</p></div>`;
            return;
        }
        container.innerHTML = appConfig.pointPackages.filter(p => p.enabled).map(pkg => `
            <div class="package-card">
                <div class="icon"><i class="fa-solid fa-coins"></i></div>
                <h3 class="points">${pkg.points.toLocaleString()} Points</h3>
                <p class="price">${pkg.price} ${pkg.currency}</p>
                <button class="action-button primary-button buy-button" onclick="window.buyPoints(${pkg.price}, ${pkg.points})">Buy Now</button>
            </div>
        `).join('');
    }
    window.buyPoints = (price, points) => {
        showToast(`Buying points is not implemented yet. Please contact admin.`, "info");
    };

    function updateReferralView() {
        const maxReferrals = appConfig.referralControl?.maxReferrals || 0;
        const currentReferrals = Object.keys(userData.referralsList || {}).length;
        const limitMessage = document.getElementById('referral-limit-message');

        if (maxReferrals > 0 && currentReferrals >= maxReferrals) {
            document.querySelectorAll('.share-btn, .copy-button').forEach(btn => btn.disabled = true);
            limitMessage.textContent = `You have reached your maximum referral limit of ${maxReferrals}.`;
            limitMessage.style.display = 'block';
        } else {
            document.querySelectorAll('.share-btn, .copy-button').forEach(btn => btn.disabled = false);
            limitMessage.style.display = 'none';
        }
    }

    async function cacheAllUsers() {
        const snapshot = await get(usersRef);
        if (snapshot.exists()) {
            allUsersDataForReferrals = snapshot.val();
        }
    }
    
    window.renderReferralsList = async (page = 1) => {
        if (Object.keys(allUsersDataForReferrals).length === 0) {
            await cacheAllUsers();
        }
        currentReferralsPage = page;
        const container = document.getElementById('referrals-list-container');
        const paginationContainer = document.getElementById('referrals-pagination-container');
        const searchInput = document.getElementById('referral-search-input').value.toLowerCase();
        
        const referralEntries = Object.values(userData.referralsList || {});
        if (referralEntries.length === 0) {
            container.innerHTML = `<div class="no-referrals"><i class="fa-solid fa-user-group"></i><p>You haven't referred anyone yet.</p></div>`;
            paginationContainer.innerHTML = '';
            return;
        }
        
        container.innerHTML = '<p style="text-align: center;">Loading referrals...</p>';
        
        const filteredReferrals = referralEntries.map(ref => {
            const referredUser = allUsersDataForReferrals[ref.userId];
            if (!referredUser) return null;

            const name = `${referredUser.profile?.firstName || ''} ${referredUser.profile?.lastName || ''}`.trim() || 'No Name';
            const username = referredUser.profile?.username || '';
            
            if (!searchInput || name.toLowerCase().includes(searchInput) || username.toLowerCase().includes(searchInput)) {
                return referredUser;
            }
            return null;
        }).filter(Boolean).sort((a,b) => new Date(b.joinedAt) - new Date(a.joinedAt));


        const totalPages = Math.ceil(filteredReferrals.length / itemsPerPage);
        const startIndex = (page - 1) * itemsPerPage;
        const paginatedReferrals = filteredReferrals.slice(startIndex, startIndex + itemsPerPage);

        let listHtml = paginatedReferrals.map(referredUser => {
            const name = `${referredUser.profile?.firstName || ''} ${referredUser.profile?.lastName || ''}`.trim() || 'No Name';
            const username = referredUser.profile?.username || '';
            const joinDate = new Date(referredUser.joinedAt);
            const joinDateStr = joinDate.toLocaleDateString();
            
            return `
                <div class="history-item referral">
                    <div class="icon-wrapper"><i class="fa-solid fa-user-check"></i></div>
                    <div class="history-item-info">
                        <span class="title">${name}</span>
                        <span class="details">${username ? `@${username}` : 'No username'} &bull; Joined: ${joinDateStr}</span>
                    </div>
                </div>`;
        }).join('');
        
        container.innerHTML = listHtml || `<div class="no-referrals"><p>No matching referrals found.</p></div>`;
        renderPaginationControls(paginationContainer, totalPages, page, 'renderReferralsList');
    };

    function renderPaginationControls(container, totalPages, currentPage, functionName) {
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let buttons = '';
        if (currentPage > 1) {
            buttons += `<button class="pagination-button" onclick="window.${functionName}(${currentPage - 1})">&lsaquo; Prev</button>`;
        }

        buttons += `<span class="pagination-button active">${currentPage}</span>`;

        if (currentPage < totalPages) {
            buttons += `<button class="pagination-button" onclick="window.${functionName}(${currentPage + 1})">Next &rsaquo;</button>`;
        }
        
        container.innerHTML = buttons;
    }

    window.copyReferralLink = () => { navigator.clipboard.writeText(document.getElementById('referral-link-input').value).then(() => showToast('Link copied!', 'success')); };
    window.shareOnSocial = (platform) => { 
        const link = document.getElementById('referral-link-input').value; const text = encodeURIComponent("Join me on this awesome app and earn rewards!"); let url = '';
        if (platform === 'telegram') url = `https://t.me/share/url?url=${link}&text=${text}`;
        if (platform === 'whatsapp') url = `https://api.whatsapp.com/send?text=${text} ${link}`;
        if (platform === 'twitter') url = `https://twitter.com/intent/tweet?text=${text}&url=${link}`;
        if (url) window.open(url, '_blank');
    };
    
    window.openSupportModal = () => {
        document.getElementById('support-subject').value = '';
        document.getElementById('support-message').value = '';
        openModal('support-modal');
    };
    window.submitSupportTicket = async () => {
        const subject = document.getElementById('support-subject').value.trim();
        const message = document.getElementById('support-message').value.trim();

        if (!subject || !message) {
            return showToast("Please fill in both the subject and message fields.", "error");
        }

        const newTicket = {
            userId: tgUser.id,
            userName: `${userData.profile.firstName || ''} ${userData.profile.lastName || ''}`.trim(),
            userUsername: userData.profile.username || 'N/A',
            subject: subject,
            message: message,
            timestamp: new Date().toISOString(),
            status: 'Open'
        };

        try {
            await push(supportTicketsRef, newTicket);
            showToast("Support ticket submitted successfully!", "success");
            closeModal('support-modal');
        } catch (error) {
            showToast("There was an error submitting your ticket.", "error");
        }
    };

    window.openMyTicketsModal = async () => {
        const listContainer = document.getElementById('my-tickets-list');
        listContainer.innerHTML = `<div class="spinner" style="margin: 20px auto;"></div>`;
        openModal('my-tickets-modal');

        const userTicketsQuery = query(supportTicketsRef, orderByChild('userId'), equalTo(tgUser.id));
        const snapshot = await get(userTicketsQuery);

        if (!snapshot.exists()) {
            listContainer.innerHTML = `<div class="no-data"><i class="fa-solid fa-ticket"></i><p>You haven't submitted any tickets yet.</p></div>`;
            return;
        }
        
        const tickets = snapshot.val();
        const sortedTickets = Object.entries(tickets).sort(([,a],[,b]) => new Date(b.timestamp) - new Date(a.timestamp));
        listContainer.innerHTML = sortedTickets.map(([id, ticket]) => `
            <div class="ticket-list-item" onclick="window.openTicketDetails('${id}')">
                <div class="info">
                    <div class="subject">${ticket.subject}</div>
                    <div class="date">${new Date(ticket.timestamp).toLocaleString()}</div>
                </div>
                <span class="status status-${ticket.status.toLowerCase()}">${ticket.status}</span>
            </div>
        `).join('');
    };

    window.openTicketDetails = async (ticketId) => {
        const snapshot = await get(ref(database, `app/support_tickets/${ticketId}`));
        if (!snapshot.exists()) return;

        const ticket = snapshot.val();
        document.getElementById('ticket-details-subject').textContent = ticket.subject;
        document.getElementById('ticket-details-content').innerHTML = `
            <p><strong>Date:</strong> ${new Date(ticket.timestamp).toLocaleString()}</p>
            <p><strong>Original Message:</strong></p>
            <p>${ticket.message}</p>
        `;

        const repliesList = document.getElementById('ticket-replies-list');
        const replies = ticket.replies || {};
        repliesList.innerHTML = Object.values(replies).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).map(reply => `
            <div class="ticket-reply-item ${reply.isAdmin ? 'admin-reply' : 'user-reply'}">
                <div class="reply-meta">${reply.isAdmin ? 'Admin' : 'You'} replied at ${new Date(reply.timestamp).toLocaleString()}</div>
                <div class="reply-message">${reply.message}</div>
            </div>
        `).join('');

        openModal('ticket-details-modal');
    };
    
    window.openNotificationsModal = async () => {
        const container = document.getElementById('notification-list-container').querySelector('.notification-list');
        container.innerHTML = `<div class="spinner" style="margin: 20px auto;"></div>`;
        openModal('notification-modal');

        let allNotifications = [];
        const globalSnap = await get(globalNotificationRef);
        if (globalSnap.exists()) {
            const globalNotif = globalSnap.val();
            allNotifications.push({ ...globalNotif, type: 'global', date: globalNotif.timestamp });
        }
        
        const personalNotifsRef = ref(database, `app/users/${tgUser.id}/notifications`);
        const personalSnap = await get(personalNotifsRef);
        if (personalSnap.exists()) {
            const personalNotifs = personalSnap.val();
            const updates = {};
            Object.entries(personalNotifs).forEach(([key, notif]) => {
                allNotifications.push({ ...notif, type: 'personal' });
                if (!notif.read) {
                    updates[`${key}/read`] = true;
                }
            });
            if (Object.keys(updates).length > 0) {
                await update(personalNotifsRef, updates);
                document.getElementById('notification-dot').style.display = 'none';
            }
        }
        
        allNotifications.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (allNotifications.length === 0) {
            container.innerHTML = `<div class="no-data" style="padding: 20px 0;"><p>No notifications yet.</p></div>`;
            return;
        }

        container.innerHTML = allNotifications.map(notif => `
            <div class="notification-item">
                <div class="icon"><i class="fas ${notif.type === 'global' ? 'fa-bullhorn' : 'fa-envelope'}"></i></div>
                <div class="content">
                    <p class="message">${notif.message}</p>
                    <p class="date">${new Date(notif.date).toLocaleString()}</p>
                </div>
            </div>
        `).join('');
    };
    
    async function renderLeaderboard() {
        const container = document.getElementById('leaderboard-container');
        container.innerHTML = '<p style="text-align: center;">Loading leaderboard...</p>';

        onValue(leaderboardRef, (snapshot) => {
            if (!snapshot.exists() || !appConfig.leaderboard?.enabled) {
                container.innerHTML = '<p style="text-align: center;">Leaderboard is not available right now.</p>';
                return;
            }
            const data = snapshot.val();
            const rewards = appConfig.leaderboard.rewards;
            let rank = 1;

            const listHtml = Object.entries(data).sort(([,a],[,b]) => b.score - a.score).slice(0, 10).map(([userId, user]) => {
                let rankClass = ''; let prizeHtml = '';
                if(rank === 1) { rankClass = 'gold'; prizeHtml = `<div class="prize"><i class="fas fa-trophy"></i> ${rewards.top1 || ''}</div>`; }
                else if(rank === 2) { rankClass = 'silver'; prizeHtml = `<div class="prize"><i class="fas fa-trophy"></i> ${rewards.top2 || ''}</div>`; }
                else if(rank === 3) { rankClass = 'bronze'; prizeHtml = `<div class="prize"><i class="fas fa-trophy"></i> ${rewards.top3 || ''}</div>`; }
                
                const item = `
                    <div class="leaderboard-item">
                        <span class="rank ${rankClass}">${rank}</span>
                        <img src="${user.photo_url || 'https://i.pravatar.cc/150'}" class="avatar" alt="Avatar">
                        <div class="info">
                            <div class="name">${user.firstName || 'User'}</div>
                            <div class="points">${user.score.toLocaleString()} Points</div>
                        </div>
                        ${prizeHtml}
                    </div>`;
                rank++;
                return item;
            }).join('');
            container.innerHTML = listHtml || '<p style="text-align: center;">No one is on the leaderboard yet.</p>';
        });
    }

    function renderOfferwall() {
        const container = document.getElementById('offerwall-content-container');
        if (!appConfig.offerwall?.enabled) {
            container.innerHTML = `<div class="no-data"><i class="fa-solid fa-store-slash"></i><p>Offerwall is currently unavailable.</p></div>`;
            return;
        }
        container.innerHTML = `
            <div id="offerwall-container">
                <iframe id="offerwall-iframe" srcdoc="${appConfig.offerwall.code || ''}"></iframe>
            </div>
        `;
    }

    async function renderLottery() {
        const container = document.getElementById('lottery-content-container');
        if (!appConfig.lottery?.enabled) {
            container.innerHTML = `<div class="no-data"><i class="fa-solid fa-ticket-alt"></i><p>The lottery is currently closed.</p></div>`;
            return;
        }
        
        const myTickets = lotteryData.current_round?.participants?.[tgUser.id] ? 1 : 0;
        const totalTickets = Object.keys(lotteryData.current_round?.participants || {}).length;

        let pastWinnersHtml = '<h4><i class="fa-solid fa-trophy"></i> Recent Winners</h4>';
        if (lotteryData.past_winners) {
            const winnerPromises = Object.values(lotteryData.past_winners)
                .sort((a,b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5)
                .map(async (winner) => {
                    const userSnap = await get(ref(database, `app/users/${winner.winnerId}/profile/firstName`));
                    const name = userSnap.val() || `User ${winner.winnerId.slice(0,4)}`;
                    return `<div class="winner-item">
                                <span class="rank"><i class="fas fa-trophy"></i></span>
                                <div class="info">
                                    <div class="name">${name}</div>
                                    <div class="date">${new Date(winner.date).toLocaleDateString()}</div>
                                </div>
                                <div class="prize">+${winner.prizeAmount.toLocaleString()} Pts</div>
                            </div>`;
                });
            const winners = await Promise.all(winnerPromises);
            pastWinnersHtml += winners.join('');
        } else {
            pastWinnersHtml += '<p>No winners yet for previous rounds.</p>';
        }

        container.innerHTML = `
            <div class="card text-center">
                <h2 class="section-title">Weekly Lottery</h2>
                <div class="lottery-stats-grid">
                    <div class="lottery-stats-card">
                        <div class="value">${appConfig.lottery.prizeAmount?.toLocaleString() || 0}</div>
                        <p class="label">Prize in Points</p>
                    </div>
                    <div class="lottery-stats-card">
                        <div class="value">${appConfig.lottery.ticketPrice?.toLocaleString() || 0}</div>
                        <p class="label">Ticket Price</p>
                    </div>
                </div>
                <p>Your Tickets: <strong>${myTickets}</strong> | Total Tickets Sold: <strong>${totalTickets}</strong></p>
                <button class="action-button primary-button" onclick="window.buyLotteryTicket()">
                    <i class="fa-solid fa-ticket-alt"></i> Buy Ticket Now
                </button>
            </div>
            <div class="card">
                ${pastWinnersHtml}
            </div>
        `;
    }

    window.buyLotteryTicket = async () => {
        if (isEarningBlocked) { return showToast("This feature is temporarily unavailable.", "error"); }
        const price = appConfig.lottery?.ticketPrice;
        if (!price || price <= 0) return showToast("Lottery is not configured correctly.", "error");

        if (userData.balance < price) {
            return showToast("Not enough points to buy a ticket.", "error");
        }
        
        const myTicket = lotteryData.current_round?.participants?.[tgUser.id];
        if (myTicket) {
             return showToast("You have already bought a ticket for this round.", "info");
        }

        if (confirm(`Are you sure you want to spend ${price} points to buy a lottery ticket?`)) {
            try {
                const newBalance = userData.balance - price;
                const updates = {
                    balance: newBalance,
                    [`transactionHistory/lottery_${Date.now()}`]: {
                        type: 'manual',
                        amount: -price,
                        title: `Lottery Ticket Purchase`,
                        date: new Date().toISOString()
                    }
                };
                await update(userRef, updates);
                
                await set(ref(database, `app/lottery/current_round/participants/${tgUser.id}`), true);

                showToast("Ticket purchased successfully! Good luck!", "success");

            } catch (error) {
                console.error("Error buying ticket:", error);
                showToast("Could not purchase ticket. Please try again.", "error");
            }
        }
    };
    
    // #### START: NEW FEATURES JAVASCRIPT LOGIC ####

    // --- Spin Wheel Logic ---
    function renderSpinWheel() {
        const config = appConfig.spinWheel || {};
        const section = document.getElementById('spin-wheel-section');
        if (!config.enabled || !config.segments || config.segments.length === 0) {
            section.style.display = 'none';
            return;
        }
        section.style.display = 'block';

        const segments = config.segments.map(s => ({
            'fillStyle': '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0'),
            'text': s.text,
            'value': s.value
        }));

        if (theWheel) {
            theWheel.stopAnimation(false);
            theWheel = null;
        }

        theWheel = new Winwheel({
            'numSegments': segments.length,
            'outerRadius': 135,
            'innerRadius': 20,
            'textFontSize': 14,
            'textFillStyle': 'white',
            'segments': segments,
            'animation': {
                'type': 'spinToStop', 'duration': 5, 'spins': 8,
                'callbackFinished': window.alertPrize,
            }
        });
        updateSpinButton();
    }

    function updateSpinButton() {
        const config = appConfig.spinWheel || {};
        if (!config.enabled) return;

        let { dailyCount = 0, lastSpinDate = null } = userData.spinState || {};
        const isNewDayForSpin = !lastSpinDate || isNewDay(lastSpinDate);
        if (isNewDayForSpin) dailyCount = 0;
        
        const spinsLeft = config.dailyLimit - dailyCount;
        const button = document.getElementById('spin-now-button');
        const costText = config.cost > 0 ? `(${config.cost} Points)` : '(Free)';

        document.getElementById('spins-left-p').textContent = `Spins left today: ${spinsLeft}`;
        button.innerHTML = `<i class="fa-solid fa-sync-alt"></i> Spin Now ${costText}`;

        if (spinsLeft <= 0) {
            button.disabled = true; button.textContent = 'Daily Limit Reached';
        } else if ((userData.balance || 0) < config.cost) {
            button.disabled = true; button.textContent = 'Not Enough Points';
        } else {
            button.disabled = false;
        }
    }

    window.startSpin = async () => {
        if (wheelSpinning) return;
        const config = appConfig.spinWheel;
        let { dailyCount = 0, lastSpinDate = null } = userData.spinState || {};
        if (isNewDay(lastSpinDate)) dailyCount = 0;
        
        if (dailyCount >= config.dailyLimit || (userData.balance || 0) < config.cost) {
            updateSpinButton(); return;
        }

        wheelSpinning = true;
        document.getElementById('spin-now-button').disabled = true;

        const updates = {
            'balance': (userData.balance || 0) - config.cost,
            'spinState/dailyCount': dailyCount + 1,
            'spinState/lastSpinDate': new Date().toISOString()
        };
        if (config.cost > 0) updates[`transactionHistory/spin_cost_${Date.now()}`] = { type: 'manual', amount: -config.cost, title: 'Spin Wheel Cost', date: new Date().toISOString() };
        
        await update(userRef, updates);
        
        theWheel.startAnimation();
    };

    window.alertPrize = async (indicatedSegment) => {
        const reward = indicatedSegment.value;
        if (reward > 0) {
            showToast(`Congratulations! You won ${indicatedSegment.text}!`, 'success');
            const updates = {
                'balance': (userData.balance || 0) + reward,
                'totalEarnings': (userData.totalEarnings || 0) + reward,
            };
            updates[`transactionHistory/spin_win_${Date.now()}`] = { type: 'manual', amount: reward, title: `Spin Wheel Prize`, date: new Date().toISOString() };
            await update(userRef, updates);
        } else {
            showToast('Better luck next time!', 'info');
        }
        
        wheelSpinning = false;
        theWheel.stopAnimation(false);
        theWheel.rotationAngle = 0;
        theWheel.draw();
        updateSpinButton();
    };
    
    // --- Scratch Card Logic ---
    function renderScratchCard() {
        const config = appConfig.scratchCard || {};
        const section = document.getElementById('scratch-card-section');
        if (!config.enabled) {
            section.style.display = 'none'; return;
        }
        section.style.display = 'block';
        updateScratchCard();
    }
    
    function updateScratchCard() {
        const config = appConfig.scratchCard || {};
        if (!config.enabled) return;
        
        let { dailyCount = 0, lastScratchDate = null } = userData.scratchState || {};
        if(isNewDay(lastScratchDate)) dailyCount = 0;

        const scratchesLeft = config.dailyLimit - dailyCount;
        document.getElementById('scratches-left-p').textContent = `Cards left today: ${scratchesLeft}`;
        document.getElementById('scratch-details-p').textContent = `Cost: ${config.cost} Points. Scratch the card to reveal your prize!`;
        
        if (scratchesLeft <= 0 || (userData.balance || 0) < config.cost) {
            document.getElementById('scratch-card-container').style.cursor = 'not-allowed';
            document.getElementById('scratch-prize-text').textContent = (scratchesLeft <= 0) ? 'Limit Reached' : 'No Points';
        } else {
            document.getElementById('scratch-card-container').style.cursor = 'pointer';
            document.getElementById('scratch-prize-text').textContent = 'SCRATCH HERE';
            initScratchCanvas();
        }
    }

    function initScratchCanvas() {
        const canvas = document.getElementById('scratch-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 280;
        canvas.height = 150;
        ctx.fillStyle = '#c0c0c0'; // Silver color
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        let isDrawing = false;
        const scratch = (e) => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, 2 * Math.PI);
            ctx.fill();
        };

        const start = (e) => { isDrawing = true; scratch(e); };
        const end = () => { isDrawing = false; };
        
        canvas.onmousedown = start;
        canvas.onmousemove = scratch;
        canvas.onmouseup = end;
        canvas.ontouchstart = start;
        canvas.ontouchmove = scratch;
        canvas.ontouchend = end;

        if (!canvas.dataset.listenerAttached) {
            canvas.addEventListener('mousedown', startScratch, {once: true});
            canvas.addEventListener('touchstart', startScratch, {once: true});
            canvas.dataset.listenerAttached = 'true';
        }
    }

    async function startScratch() {
        const config = appConfig.scratchCard || {};
        let { dailyCount = 0, lastScratchDate = null } = userData.scratchState || {};
        if(isNewDay(lastScratchDate)) dailyCount = 0;

        if (dailyCount >= config.dailyLimit || (userData.balance || 0) < config.cost) {
            updateScratchCard(); return;
        }

        const updates = {
            'balance': (userData.balance || 0) - config.cost,
            'scratchState/dailyCount': dailyCount + 1,
            'scratchState/lastScratchDate': new Date().toISOString()
        };
        if (config.cost > 0) updates[`transactionHistory/scratch_cost_${Date.now()}`] = { type: 'manual', amount: -config.cost, title: 'Scratch Card Cost', date: new Date().toISOString() };
        
        await update(userRef, updates);

        // Determine prize
        const prizes = config.prizes || [];
        let totalProb = prizes.reduce((acc, p) => acc + p.probability, 0);
        let random = Math.random() * totalProb;
        let prize = prizes[prizes.length - 1]; // default to last
        for(let i=0; i < prizes.length; i++) {
            if(random < prizes[i].probability) {
                prize = prizes[i]; break;
            }
            random -= prizes[i].probability;
        }

        document.getElementById('scratch-prize-text').textContent = prize.text;

        if (prize.value > 0) {
            const rewardUpdates = {
                'balance': (userData.balance || 0) - config.cost + prize.value,
                'totalEarnings': (userData.totalEarnings || 0) + prize.value
            };
            rewardUpdates[`transactionHistory/scratch_win_${Date.now()}`] = { type: 'manual', amount: prize.value, title: `Scratch Card Prize`, date: new Date().toISOString() };
            await update(userRef, rewardUpdates);
            showToast(`You won ${prize.text}!`, 'success');
        }

        setTimeout(() => {
            updateScratchCard();
        }, 3000);
    }

    // --- Video Zone Logic ---
    function renderVideoZone() {
        const config = appConfig.videoZone || {};
        const section = document.getElementById('video-zone-section');
        if (!config.enabled || !config.videos || config.videos.length === 0) {
            section.style.display = 'none'; return;
        }
        section.style.display = 'block';

        const container = document.getElementById('video-zone-container');
        container.innerHTML = config.videos.map((video, index) => {
            const watched = userData.watchedVideos && userData.watchedVideos[index];
            return `
            <div class="card video-item">
                <i class="fab fa-youtube"></i>
                <div class="video-info">
                    <h5>${video.title}</h5>
                    <p>${video.reward} Points - ${video.duration} seconds</p>
                </div>
                <button class="task-button" onclick="window.watchVideo(${index})" ${watched ? 'disabled' : ''}>${watched ? 'Watched' : 'Watch'}</button>
            </div>`;
        }).join('');
    }
    
    window.watchVideo = (index) => {
        const config = appConfig.videoZone.videos[index];
        window.open(config.url, '_blank');
        
        const overlay = document.getElementById('timer-notification-overlay');
        overlay.style.display = 'flex';
        let countdown = config.duration;
        overlay.querySelector('.timer-notification-content').innerHTML = `<div>Watching Video...</div><div>${countdown}</div>`;
        
        const interval = setInterval(() => {
            countdown--;
            overlay.querySelector('.timer-notification-content').innerHTML = `<div>Watching Video...</div><div>${countdown}</div>`;
            if (countdown <= 0) {
                clearInterval(interval);
                claimVideoReward(index);
                overlay.querySelector('.timer-notification-content').innerHTML = `<div>+${config.reward} Points!</div>`;
                setTimeout(() => overlay.style.display = 'none', 2000);
            }
        }, 1000);
    };

    async function claimVideoReward(index) {
        const reward = appConfig.videoZone.videos[index].reward;
        const updates = {
            'balance': (userData.balance || 0) + reward,
            'totalEarnings': (userData.totalEarnings || 0) + reward,
            [`watchedVideos/${index}`]: true
        };
        updates[`transactionHistory/video_${Date.now()}`] = { type: 'task', amount: reward, title: `Video: ${appConfig.videoZone.videos[index].title}`, date: new Date().toISOString() };
        await update(userRef, updates);
        showToast(`Reward claimed for watching video!`, 'success');
    }

    // --- Quiz Logic ---
    function renderQuizSection() {
        const config = appConfig.quizSystem || {};
        const section = document.getElementById('quiz-section');
        if (!config.enabled || !config.categories || config.categories.length === 0) {
            section.style.display = 'none'; return;
        }
        section.style.display = 'block';
        
        const container = document.getElementById('quiz-categories-container');
        container.innerHTML = config.categories.map((cat, index) => 
            `<button class="action-button secondary-button" style="margin-top: 10px;" onclick="window.startQuiz(${index})">${cat.name}</button>`
        ).join('');
    }

    window.startQuiz = (catIndex) => {
        const config = appConfig.quizSystem;
        const category = config.categories[catIndex];
        if(!category.questions || category.questions.length === 0) {
            return showToast("No questions in this category.", "info");
        }
        
        currentQuiz = {
            categoryIndex: catIndex,
            questionIndex: 0,
            score: 0,
            questions: [...category.questions].sort(() => 0.5 - Math.random()) // Shuffle questions
        };

        document.getElementById('quiz-question-container').style.display = 'block';
        document.getElementById('quiz-result-container').style.display = 'none';
        document.getElementById('quiz-next-btn').style.display = 'block';
        document.getElementById('quiz-close-btn').style.display = 'none';
        
        displayQuizQuestion();
        openModal('quiz-modal');
    };

    function displayQuizQuestion() {
        const q = currentQuiz.questions[currentQuiz.questionIndex];
        document.getElementById('quiz-progress-text').textContent = `Question ${currentQuiz.questionIndex + 1} of ${currentQuiz.questions.length}`;
        document.getElementById('quiz-question-text').textContent = q.q;
        const optionsContainer = document.getElementById('quiz-options-container');
        optionsContainer.innerHTML = q.options.map(option => 
            `<button class="quiz-option-btn" onclick="window.selectQuizOption(this, '${option}')">${option}</button>`
        ).join('');
    }

    window.selectQuizOption = (btn, selectedOption) => {
        const q = currentQuiz.questions[currentQuiz.questionIndex];
        const buttons = document.querySelectorAll('.quiz-option-btn');
        buttons.forEach(b => b.disabled = true);

        if (selectedOption === q.answer) {
            btn.classList.add('correct');
            currentQuiz.score++;
        } else {
            btn.classList.add('wrong');
            buttons.forEach(b => {
                if(b.textContent === q.answer) b.classList.add('correct');
            });
        }
    };

    window.nextQuizQuestion = () => {
        currentQuiz.questionIndex++;
        if (currentQuiz.questionIndex < currentQuiz.questions.length) {
            displayQuizQuestion();
        } else {
            showQuizResult();
        }
    };

    async function showQuizResult() {
        const config = appConfig.quizSystem;
        const totalReward = currentQuiz.score * config.rewardPerCorrect;

        document.getElementById('quiz-question-container').style.display = 'none';
        document.getElementById('quiz-result-container').style.display = 'block';
        document.getElementById('quiz-next-btn').style.display = 'none';
        document.getElementById('quiz-close-btn').style.display = 'block';

        document.getElementById('quiz-result-summary').textContent = `You answered ${currentQuiz.score} out of ${currentQuiz.questions.length} questions correctly.`;
        document.getElementById('quiz-total-reward').textContent = `Total Reward: ${totalReward} Points`;

        if (totalReward > 0) {
            const updates = {
                'balance': (userData.balance || 0) + totalReward,
                'totalEarnings': (userData.totalEarnings || 0) + totalReward
            };
            updates[`transactionHistory/quiz_${Date.now()}`] = { type: 'task', amount: totalReward, title: `Quiz Reward`, date: new Date().toISOString() };
            await update(userRef, updates);
        }
    }
    
    // --- Captcha Logic ---
    function renderCaptchaSection() {
        const config = appConfig.captchaEntry || {};
        const section = document.getElementById('captcha-section');
        if (!config.enabled) {
            section.style.display = 'none'; return;
        }
        section.style.display = 'block';
        generateCaptcha();
        updateCaptchaButton();
    }
    
    function generateCaptcha() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < 6; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        currentCaptcha = result;
        document.getElementById('captcha-image').textContent = currentCaptcha;
    }

    function updateCaptchaButton() {
        const config = appConfig.captchaEntry || {};
        let { dailyCount = 0, lastCaptchaDate = null } = userData.captchaState || {};
        if(isNewDay(lastCaptchaDate)) dailyCount = 0;

        const captchasLeft = config.dailyLimit - dailyCount;
        document.getElementById('captchas-left-p').textContent = `Captchas left today: ${captchasLeft}`;
        
        const button = document.getElementById('captcha-submit-button');
        button.disabled = captchasLeft <= 0;
    }

    window.submitCaptcha = async () => {
        const config = appConfig.captchaEntry || {};
        let { dailyCount = 0, lastCaptchaDate = null } = userData.captchaState || {};
        if(isNewDay(lastCaptchaDate)) dailyCount = 0;

        if (dailyCount >= config.dailyLimit) {
            return showToast("Daily limit reached.", "error");
        }

        const userInput = document.getElementById('captcha-input').value;
        if (userInput === currentCaptcha) {
            const reward = config.reward;
            const updates = {
                'balance': (userData.balance || 0) + reward,
                'totalEarnings': (userData.totalEarnings || 0) + reward,
                'captchaState/dailyCount': dailyCount + 1,
                'captchaState/lastCaptchaDate': new Date().toISOString()
            };
            updates[`transactionHistory/captcha_${Date.now()}`] = { type: 'task', amount: reward, title: `Captcha Reward`, date: new Date().toISOString() };
            await update(userRef, updates);
            
            showToast(`Correct! +${reward} points.`, 'success');
            document.getElementById('captcha-input').value = '';
            generateCaptcha();
            updateCaptchaButton();
        } else {
            showToast('Incorrect captcha. Try again.', 'error');
            generateCaptcha();
        }
    }

    // #### END: NEW FEATURES JAVASCRIPT LOGIC ####

</script>
</body>
</html>
